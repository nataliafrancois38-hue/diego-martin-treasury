<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diego Martin SDA - Online Tithe Slip</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        const SUPABASE_URL = 'https://vpaiplblmairbcftfbym.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwYWlwbGJsbWFpcmJjZnRmYnltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0ODc3ODQsImV4cCI6MjA4NDA2Mzc4NH0.Gy-FIH1T2nLpaI-TZ6o-w5KPjJNJUw9hrnnKACSxnkg';
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js"></script>
    <style>
        body { background: #0f172a; }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="min-h-screen">
    <div id="app"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Rate limiting - max 5 submissions per hour per browser
        const checkRateLimit = () => {
            const key = 'tithe_submissions_log';
            const now = Date.now();
            const log = JSON.parse(localStorage.getItem(key) || '[]').filter(t => now - t < 3600000);
            if (log.length >= 5) return false;
            log.push(now);
            localStorage.setItem(key, JSON.stringify(log));
            return true;
        };

        const CONF_FIELDS = [
            { key: 'tithe', label: 'Tithes' },
            { key: 'special_offering', label: 'Special Offering' },
            { key: 'ingathering', label: 'Ingathering' },
            { key: 'radio', label: '3ABN/Radio' },
            { key: 'nehemiah', label: 'Nehemiah' },
            { key: 'sabbath_school', label: 'Sabbath School' },
        ];
        const CHURCH_FIELDS = [
            { key: 'budget_covenant', label: 'Budget Covenant/Offerings' },
            { key: 'welfare', label: 'Welfare' },
            { key: 'project', label: 'Church Building Fund' },
            { key: 'school', label: 'Contributions to School' },
            { key: 'pos_band', label: "Children's Home" },
            { key: 'books', label: 'Refunds' },
            { key: 'raffa_house', label: 'Choir' },
            { key: 'tv', label: 'Special Projects' },
            { key: 'government_fund', label: 'Church Project' },
            { key: 'messages_of_hope', label: 'Messages of Hope Radio' },
        ];

        function TitheSubmissionForm() {
            const today = new Date().toISOString().split('T')[0];
            const [form, setForm] = useState({
                member_name: '', member_email: '', member_phone: '',
                submission_date: today,
                ...Object.fromEntries([...CONF_FIELDS, ...CHURCH_FIELDS].map(f => [f.key, '']))
            });
            const [screenshot, setScreenshot] = useState(null);
            const [previewUrl, setPreviewUrl] = useState(null);
            const [submitting, setSubmitting] = useState(false);
            const [submitted, setSubmitted] = useState(false);
            const [error, setError] = useState('');
            const fileRef = useRef(null);
            // Honeypot
            const [hp, setHp] = useState('');

            const handleChange = (key, val) => {
                setForm(f => ({ ...f, [key]: val }));
            };

            const handleFile = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (!file.type.startsWith('image/')) {
                    setError('Please upload an image file (JPG, PNG)');
                    return;
                }
                if (file.size > 10 * 1024 * 1024) {
                    setError('Image must be under 10MB');
                    return;
                }
                setError('');
                // Auto-compress: resize to max 1200px wide, JPEG quality 0.6 â†’ ~100-200KB
                const img = new Image();
                img.onload = () => {
                    const maxW = 1200, maxH = 1200;
                    let w = img.width, h = img.height;
                    if (w > maxW) { h = h * (maxW / w); w = maxW; }
                    if (h > maxH) { w = w * (maxH / h); h = maxH; }
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    canvas.toBlob(blob => {
                        const compressed = new File([blob], 'deposit.jpg', { type: 'image/jpeg' });
                        setScreenshot(compressed);
                        setPreviewUrl(URL.createObjectURL(compressed));
                    }, 'image/jpeg', 0.6);
                };
                img.src = URL.createObjectURL(file);
            };

            const totalAmount = [...CONF_FIELDS, ...CHURCH_FIELDS].reduce((s, f) => s + (parseFloat(form[f.key]) || 0), 0);

            const handleSubmit = async () => {
                // Honeypot check
                if (hp) return;
                
                setError('');
                if (!form.member_name.trim()) { setError('Please enter your name'); return; }
                if (totalAmount <= 0) { setError('Please enter at least one amount'); return; }
                if (!screenshot) { setError('Please upload your deposit screenshot'); return; }

                // Rate limit check
                if (!checkRateLimit()) {
                    setError('Too many submissions. Please try again later.');
                    return;
                }

                setSubmitting(true);
                try {
                    // Upload screenshot
                    let screenshotUrl = '';
                    const fileName = `${Date.now()}_${Math.random().toString(36).slice(2,8)}.${screenshot.name.split('.').pop()}`;
                    const { data: uploadData, error: uploadErr } = await supabase.storage
                        .from('deposit-screenshots')
                        .upload(fileName, screenshot, { contentType: screenshot.type });
                    
                    if (uploadErr) throw new Error('Failed to upload screenshot: ' + uploadErr.message);
                    
                    const { data: urlData } = supabase.storage
                        .from('deposit-screenshots')
                        .getPublicUrl(fileName);
                    screenshotUrl = urlData.publicUrl;

                    // Build submission data - sanitize all strings
                    const sanitize = (s) => String(s || '').replace(/<[^>]*>/g, '').trim().slice(0, 200);
                    const submission = {
                        member_name: sanitize(form.member_name),
                        member_email: sanitize(form.member_email),
                        member_phone: sanitize(form.member_phone),
                        submission_date: form.submission_date,
                        total_amount: totalAmount,
                        deposit_screenshot_url: screenshotUrl,
                        status: 'pending'
                    };
                    
                    [...CONF_FIELDS, ...CHURCH_FIELDS].forEach(f => {
                        submission[f.key] = parseFloat(form[f.key]) || 0;
                    });

                    const { error: insertErr } = await supabase
                        .from('tithe_submissions')
                        .insert(submission);

                    if (insertErr) throw new Error('Submission failed: ' + insertErr.message);

                    setSubmitted(true);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setSubmitting(false);
                }
            };

            if (submitted) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-slate-800 rounded-2xl p-8 max-w-md w-full text-center border border-slate-700">
                            <div className="w-16 h-16 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                                <span className="text-3xl">âœ“</span>
                            </div>
                            <h2 className="text-2xl font-bold text-white mb-2">Submission Received!</h2>
                            <p className="text-slate-400 mb-4">
                                Thank you, {form.member_name}. Your tithe slip for <span className="text-amber-400 font-semibold">${totalAmount.toFixed(2)}</span> has been submitted and is pending review by the Treasurer.
                            </p>
                            <p className="text-slate-500 text-sm mb-6">You will see it reflected once approved.</p>
                            <button onClick={() => { setSubmitted(false); setForm({
                                member_name: '', member_email: '', member_phone: '',
                                submission_date: today,
                                ...Object.fromEntries([...CONF_FIELDS, ...CHURCH_FIELDS].map(f => [f.key, '']))
                            }); setScreenshot(null); setPreviewUrl(null); }}
                                className="px-6 py-2 bg-amber-500 text-slate-900 rounded-lg font-semibold hover:bg-amber-400">
                                Submit Another
                            </button>
                        </div>
                    </div>
                );
            }

            const renderField = (f) => (
                <div key={f.key} className="flex items-center gap-2">
                    <label className="text-sm text-slate-300 w-48 shrink-0">{f.label}</label>
                    <div className="relative flex-1">
                        <span className="absolute left-2 top-1/2 -translate-y-1/2 text-slate-500 text-sm">$</span>
                        <input type="number" step="0.01" min="0" placeholder="0.00"
                            value={form[f.key]} onChange={e => handleChange(f.key, e.target.value)}
                            className="w-full pl-6 pr-2 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm text-right focus:border-amber-500 focus:outline-none" />
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen py-6 px-4">
                    {/* Header */}
                    <div className="max-w-lg mx-auto mb-6 text-center">
                        <div className="inline-flex items-center gap-2 bg-amber-500/10 border border-amber-500/30 rounded-full px-4 py-1 mb-3">
                            <span className="text-amber-400 text-xs font-semibold tracking-wider">DIEGO MARTIN SDA CHURCH</span>
                        </div>
                        <h1 className="text-2xl font-bold text-white mb-1">Online Tithe Slip</h1>
                        <p className="text-slate-400 text-sm">Fill in your offering details and upload your deposit screenshot</p>
                    </div>

                    <div className="max-w-lg mx-auto space-y-4">
                        {/* Member Info */}
                        <div className="bg-slate-800/70 rounded-xl border border-slate-700 p-4 space-y-3">
                            <h3 className="text-sm font-semibold text-amber-400 mb-1">Your Information</h3>
                            <div>
                                <label className="text-xs text-slate-400 block mb-1">Full Name <span className="text-red-400">*</span></label>
                                <input type="text" value={form.member_name} onChange={e => handleChange('member_name', e.target.value)} maxLength={100}
                                    placeholder="Enter your full name"
                                    className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm focus:border-amber-500 focus:outline-none" />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Email (optional)</label>
                                    <input type="email" value={form.member_email} onChange={e => handleChange('member_email', e.target.value)} maxLength={100}
                                        placeholder="email@example.com"
                                        className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm focus:border-amber-500 focus:outline-none" />
                                </div>
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Phone (optional)</label>
                                    <input type="tel" value={form.member_phone} onChange={e => handleChange('member_phone', e.target.value)} maxLength={20}
                                        placeholder="xxx-xxxx"
                                        className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm focus:border-amber-500 focus:outline-none" />
                                </div>
                            </div>
                            <div>
                                <label className="text-xs text-slate-400 block mb-1">Date of Deposit <span className="text-red-400">*</span></label>
                                <input type="date" value={form.submission_date} onChange={e => handleChange('submission_date', e.target.value)}
                                    className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm focus:border-amber-500 focus:outline-none" />
                            </div>
                            {/* Honeypot - hidden from users, bots fill it */}
                            <input type="text" value={hp} onChange={e => setHp(e.target.value)} 
                                style={{position:'absolute',left:'-9999px',opacity:0,height:0}} tabIndex={-1} autoComplete="off" name="website" />
                        </div>

                        {/* Conference Funds */}
                        <div className="bg-slate-800/70 rounded-xl border border-slate-700 p-4 space-y-2">
                            <h3 className="text-sm font-semibold text-blue-400 mb-1">Conference Funds</h3>
                            {CONF_FIELDS.map(renderField)}
                        </div>

                        {/* Church Funds */}
                        <div className="bg-slate-800/70 rounded-xl border border-slate-700 p-4 space-y-2">
                            <h3 className="text-sm font-semibold text-emerald-400 mb-1">Church Funds</h3>
                            {CHURCH_FIELDS.map(renderField)}
                        </div>

                        {/* Total */}
                        <div className="bg-slate-800/70 rounded-xl border border-amber-500/30 p-4">
                            <div className="flex items-center justify-between">
                                <span className="text-lg font-semibold text-white">Total Amount</span>
                                <span className="text-2xl font-bold text-amber-400">${totalAmount.toFixed(2)}</span>
                            </div>
                        </div>

                        {/* Deposit Screenshot */}
                        <div className="bg-slate-800/70 rounded-xl border border-slate-700 p-4">
                            <h3 className="text-sm font-semibold text-amber-400 mb-2">Deposit Screenshot <span className="text-red-400">*</span></h3>
                            <p className="text-xs text-slate-500 mb-3">Upload a screenshot or photo of your bank deposit confirmation</p>
                            
                            {previewUrl ? (
                                <div className="relative">
                                    <img src={previewUrl} alt="Deposit screenshot" className="w-full rounded-lg border border-slate-600 max-h-64 object-contain bg-slate-900" />
                                    <button onClick={() => { setScreenshot(null); setPreviewUrl(null); if(fileRef.current) fileRef.current.value=''; }}
                                        className="absolute top-2 right-2 bg-red-500/80 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs hover:bg-red-500">âœ•</button>
                                </div>
                            ) : (
                                <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-dashed border-slate-600 rounded-xl cursor-pointer hover:border-amber-500/50 transition-colors">
                                    <span className="text-3xl mb-1">ðŸ“·</span>
                                    <span className="text-sm text-slate-400">Tap to upload image</span>
                                    <span className="text-xs text-slate-500">JPG, PNG â€” Max 5MB</span>
                                    <input ref={fileRef} type="file" accept="image/*" capture="environment" onChange={handleFile} className="hidden" />
                                </label>
                            )}
                        </div>

                        {/* Error */}
                        {error && (
                            <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-3 text-red-400 text-sm">{error}</div>
                        )}

                        {/* Submit */}
                        <button onClick={handleSubmit} disabled={submitting}
                            className={`w-full py-3 rounded-xl font-bold text-lg transition-all ${submitting ? 'bg-slate-600 text-slate-400 cursor-wait' : 'bg-amber-500 text-slate-900 hover:bg-amber-400 active:scale-[0.98]'}`}>
                            {submitting ? 'Submitting...' : 'Submit Tithe Slip'}
                        </button>

                        {/* Footer */}
                        <p className="text-center text-xs text-slate-600 pb-4">
                            ðŸ”’ Your information is encrypted and sent securely.<br/>
                            This form only submits data â€” it cannot access any church records.
                        </p>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('app')).render(<TitheSubmissionForm />);
    </script>
</body>
</html>
