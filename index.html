<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diego Martin SDA Church - Treasury Management System</title>
    
    <!-- Open Graph / Social Media Preview -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Diego Martin SDA Church - Treasury Management System">
    <meta property="og:description" content="Cloud-based church financial management. Track tithes, expenses, deposits, projects, budgets, and generate reports with forecasting.">
    <meta property="og:image" content="https://i.imgur.com/cukX9IZ.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Diego Martin SDA Church - Treasury Management System">
    <meta name="twitter:description" content="Cloud-based church financial management. Track tithes, expenses, deposits, projects, budgets, and generate reports with forecasting.">
    <meta name="twitter:image" content="https://i.imgur.com/cukX9IZ.png">
    
    <!-- General Meta -->
    <meta name="description" content="Diego Martin SDA Church Treasury Management System - Track tithes, offerings, expenses, deposits, projects, budgets and generate financial reports.">
    <meta name="theme-color" content="#f59e0b">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚õ™</text></svg>">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { font-family: system-ui, -apple-system, sans-serif; }
        body { margin: 0; background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); min-height: 100vh; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
        /* Fix dropdown option visibility */
        select { background-color: #0f172a !important; color: #fff !important; }
        select option { background-color: #1e293b !important; color: #fff !important; padding: 8px; }
        select option:hover, select option:checked { background-color: #334155 !important; }
        @media print { body { background: white; } .no-print { display: none; } }
    </style>
</head>
<body>
    <div id="root">
        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;">
            <div style="background: #1e293b; border-radius: 16px; padding: 24px; max-width: 400px; text-align: center; border: 1px solid #334155;">
                <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 12px; margin: 0 auto 16px; display: flex; align-items: center; justify-content: center;">
                    <span style="font-size: 24px;">‚õ™</span>
                </div>
                <h1 style="color: white; margin: 0 0 8px;">Diego Martin SDA Church</h1>
                <p style="color: #f59e0b; margin: 0 0 16px;">Treasury Management System</p>
                <div style="background: #0f172a; border-radius: 8px; padding: 12px;">
                    <p style="color: #94a3b8; margin: 0; font-size: 14px;">Loading application...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Load Supabase dynamically
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js';
        script.onload = function() {
            console.log('Supabase loaded successfully');
            window.SUPABASE_READY = true;
            if (window.startApp) window.startApp();
        };
        script.onerror = function() {
            console.error('Failed to load Supabase');
            document.getElementById('root').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;"><div style="background: #1e293b; border-radius: 16px; padding: 24px; max-width: 400px; text-align: center; border: 1px solid #ef4444;"><h1 style="color: #ef4444; margin: 0 0 16px;">Connection Error</h1><p style="color: #94a3b8; margin: 0 0 16px;">Could not load required libraries. Please check your internet connection.</p><button onclick="location.reload()" style="background: #f59e0b; color: #0f172a; border: none; padding: 12px 24px; border-radius: 8px; font-weight: bold; cursor: pointer;">Try Again</button></div></div>';
        };
        document.head.appendChild(script);
    </script>
    
    <script type="text/babel">
        const { useState, useEffect, createContext, useContext } = React;

        // Supabase Configuration
        const SUPABASE_URL = 'https://vpaiplblmairbcftfbym.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwYWlwbGJsbWFpcmJjZnRmYnltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0ODc3ODQsImV4cCI6MjA4NDA2Mzc4NH0.Gy-FIH1T2nLpaI-TZ6o-w5KPjJNJUw9hrnnKACSxnkg';

        const AuthContext = createContext(null);

        // Field definitions
        const CONFERENCE_FIELDS = [
            { key: 'tithe', label: "Tithes" },
            { key: 'special_offering', label: 'Special Offering' },
            { key: 'ingathering', label: 'Ingathering' },
            { key: 'radio', label: '3ABN/Radio' },
            { key: 'nehemiah', label: 'Nehemiah' },
            { key: 'sabbath_school', label: 'Sabbath School' },
        ];

        const CHURCH_FIELDS = [
            { key: 'budget_covenant', label: 'Budget Covenant/Offerings' },
            { key: 'welfare', label: 'Welfare' },
            { key: 'project', label: 'Church Building Fund' },
            { key: 'school', label: 'Contributions to School' },
            { key: 'pos_band', label: "Children's Home" },
            { key: 'books', label: 'Refunds' },
            { key: 'raffa_house', label: 'Choir' },
            { key: 'tv', label: 'Special Projects' },
            { key: 'government_fund', label: 'Church Project' },
            { key: 'messages_of_hope', label: 'Messages of Hope Radio' },
        ];

        const EXPENSE_CATEGORIES = [
            'Administration', 'Adventurer Club', 'Anniversary', 'AY',
            'Board Expenses', 'Children\'s Ministry', 'Church Building', 'Church Building Aircondition',
            'Community Services', 'Crusade', 'Deaconry', 'Education', 'Elders',
            'Electricity - T&TEC', 'Family Life', 'Gifts', 'Health', 'Hospitality',
            'Insurance', 'Internet - FLOW', 'Janitorial', 'Music/Communication',
            'Other', 'Personal Ministries', 'POS Band', 'Religious Liberty',
            'Sabbath School', 'Sabbath School - Quarterlies', 'School - Wesport',
            'Stationery', 'Telephone - TSTT', 'Treasury/Stipend', 'VBS',
            'Water - WASA', 'Women Ministry'
        ];

        // 2025 Historical Data - Placeholder (pending audit)
        const HISTORICAL_DATA_2025 = {
            tithe: {},
            churchIncome: {},
            expenses: {},
            conferenceFunds: {},
            totals: { tithe: 0, churchIncome: 0, expenses: 0, conferenceFunds: 0 }
        };

        const MONTH_NAMES = ['', 'January', 'February', 'March', 'April', 'May', 'June', 
                            'July', 'August', 'September', 'October', 'November', 'December'];

        const DEPARTMENTS = ['', ...EXPENSE_CATEGORIES];
        const ALL_FIELDS = [...CONFERENCE_FIELDS, ...CHURCH_FIELDS];

        const fmt = (v) => (parseFloat(v) || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        const fmtCur = (v) => '$' + fmt(v);

        // Main App
        function App() {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [loadingMessage, setLoadingMessage] = useState('Connecting to database...');
            const [error, setError] = useState(null);
            const [supabaseClient, setSupabaseClient] = useState(null);

            const initApp = () => {
                setLoading(true);
                setError(null);
                setLoadingMessage('Connecting to database...');
                
                try {
                    if (!window.supabase) {
                        setError('Supabase library not loaded. Please check your internet connection and refresh.');
                        setLoading(false);
                        return;
                    }

                    const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    setSupabaseClient(client);

                    // Add timeout for slow connections
                    const timeout = setTimeout(() => {
                        setLoadingMessage('Still connecting... This may take a moment on slower connections.');
                    }, 5000);

                    const errorTimeout = setTimeout(() => {
                        setLoading(false);
                        setError('Connection is taking too long. Please check your internet and try again.');
                    }, 15000);

                    client.auth.getSession().then(({ data: { session }, error }) => {
                        clearTimeout(timeout);
                        clearTimeout(errorTimeout);
                        if (error) {
                            console.error('Session error:', error);
                        }
                        setUser(session?.user ?? null);
                        setLoading(false);
                    }).catch(err => {
                        clearTimeout(timeout);
                        clearTimeout(errorTimeout);
                        setError('Failed to connect. Please check your internet and try again.');
                        setLoading(false);
                    });

                    client.auth.onAuthStateChange((_event, session) => {
                        setUser(session?.user ?? null);
                    });
                } catch (e) {
                    console.error('Init error:', e);
                    setError(e.message);
                    setLoading(false);
                }
            };

            useEffect(() => {
                if (window.SUPABASE_READY) {
                    initApp();
                } else {
                    window.startApp = initApp;
                    // Fallback if Supabase script loaded but flag not set
                    setTimeout(() => {
                        if (loading && !supabaseClient) {
                            initApp();
                        }
                    }, 2000);
                }
            }, []);

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-slate-400 mb-4">{loadingMessage}</p>
                            <button onClick={() => window.location.reload()} className="px-4 py-2 bg-slate-700 text-slate-300 rounded-lg text-sm hover:bg-slate-600">
                                Refresh Page
                            </button>
                        </div>
                    </div>
                );
            }

            if (error) {
                return (
                    <div className="min-h-screen flex items-center justify-center p-4">
                        <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-6 max-w-md text-center">
                            <h1 className="text-xl font-bold text-red-400 mb-3">Connection Error</h1>
                            <p className="text-slate-300 mb-4">{error}</p>
                            <div className="space-y-2">
                                <button onClick={initApp} className="w-full px-4 py-2 bg-amber-500 text-slate-900 rounded-lg font-semibold">Try Again</button>
                                <button onClick={() => window.location.reload()} className="w-full px-4 py-2 bg-slate-700 text-slate-300 rounded-lg">Refresh Page</button>
                            </div>
                            <p className="text-xs text-slate-500 mt-4">If problem persists, try using a different browser or check your internet connection.</p>
                        </div>
                    </div>
                );
            }

            return (
                <AuthContext.Provider value={{ user, supabase: supabaseClient }}>
                    {user ? <TreasurerApp /> : <AuthPage />}
                </AuthContext.Provider>
            );
        }

        // Auth Page
        function AuthPage() {
            const { supabase } = useContext(AuthContext);
            const [isLogin, setIsLogin] = useState(true);
            const [isForgotPassword, setIsForgotPassword] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [fullName, setFullName] = useState('');
            const [role, setRole] = useState('treasurer');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [message, setMessage] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');
                setMessage('');

                try {
                    if (isForgotPassword) {
                        const { error } = await supabase.auth.resetPasswordForEmail(email, {
                            redirectTo: window.location.origin + window.location.pathname
                        });
                        if (error) throw error;
                        setMessage('Password reset email sent! Check your inbox.');
                        setIsForgotPassword(false);
                    } else if (isLogin) {
                        const { error } = await supabase.auth.signInWithPassword({ email, password });
                        if (error) throw error;
                    } else {
                        const { error } = await supabase.auth.signUp({
                            email,
                            password,
                            options: { data: { full_name: fullName, role: role } }
                        });
                        if (error) throw error;
                        setMessage('Account created! Check your email to verify, then sign in.');
                        setIsLogin(true);
                    }
                } catch (err) {
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            };

            const switchMode = (mode) => {
                setIsLogin(mode === 'login');
                setIsForgotPassword(mode === 'forgot');
                setError('');
                setMessage('');
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4">
                    <div className="w-full max-w-md">
                        <div className="text-center mb-8">
                            <div className="w-16 h-16 bg-gradient-to-br from-amber-400 to-amber-600 rounded-2xl flex items-center justify-center mx-auto mb-4 shadow-lg text-2xl">‚õ™</div>
                            <h1 className="text-2xl font-bold text-white">Diego Martin SDA Church</h1>
                            <p className="text-amber-400">Treasury Management System</p>
                        </div>

                        <div className="bg-slate-800 rounded-2xl border border-slate-700 p-6">
                            <h2 className="text-xl font-bold text-white mb-6 text-center">
                                {isForgotPassword ? 'Reset Password' : (isLogin ? 'Sign In' : 'Create Account')}
                            </h2>

                            {error && <div className="bg-red-500/10 border border-red-500/30 text-red-400 rounded-lg p-3 mb-4 text-sm">{error}</div>}
                            {message && <div className="bg-emerald-500/10 border border-emerald-500/30 text-emerald-400 rounded-lg p-3 mb-4 text-sm">{message}</div>}

                            <form onSubmit={handleSubmit} className="space-y-4">
                                {!isLogin && !isForgotPassword && (
                                    <>
                                        <div>
                                            <label className="block text-sm text-slate-400 mb-1">Full Name</label>
                                            <input type="text" value={fullName} onChange={(e) => setFullName(e.target.value)} className="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-xl text-white" placeholder="Your name" required />
                                        </div>
                                        <div>
                                            <label className="block text-sm text-slate-400 mb-1">Role</label>
                                            <select value={role} onChange={(e) => setRole(e.target.value)} className="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-xl text-white">
                                                <option value="treasurer">Treasurer</option>
                                                <option value="assistant_treasurer">Assistant Treasurer</option>
                                                <option value="pastor">Pastor (View Only)</option>
                                                <option value="clerk">Church Clerk (View Only)</option>
                                            </select>
                                            <p className="text-xs text-slate-500 mt-1">
                                                {role === 'pastor' || role === 'clerk' ? 'üëÅÔ∏è View-only access' : '‚úèÔ∏è Full edit access'}
                                            </p>
                                        </div>
                                    </>
                                )}
                                <div>
                                    <label className="block text-sm text-slate-400 mb-1">Email</label>
                                    <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} className="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-xl text-white" placeholder="your@email.com" required />
                                </div>
                                {!isForgotPassword && (
                                    <div>
                                        <label className="block text-sm text-slate-400 mb-1">Password</label>
                                        <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} className="w-full px-4 py-3 bg-slate-900 border border-slate-600 rounded-xl text-white" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minLength={6} />
                                    </div>
                                )}
                                <button type="submit" disabled={loading} className="w-full py-3 bg-amber-500 text-slate-900 rounded-xl font-bold hover:bg-amber-400 disabled:opacity-50">
                                    {loading ? 'Please wait...' : (isForgotPassword ? 'Send Reset Link' : (isLogin ? 'Sign In' : 'Create Account'))}
                                </button>
                            </form>

                            <div className="mt-6 text-center space-y-2">
                                {isLogin && !isForgotPassword && (
                                    <button onClick={() => switchMode('forgot')} className="text-slate-400 hover:text-amber-400 text-sm block w-full">
                                        Forgot your password?
                                    </button>
                                )}
                                <button onClick={() => switchMode(isLogin ? 'signup' : 'login')} className="text-amber-400 hover:underline text-sm">
                                    {isLogin || isForgotPassword ? "Don't have an account? Sign up" : "Already have an account? Sign in"}
                                </button>
                                {isForgotPassword && (
                                    <button onClick={() => switchMode('login')} className="text-slate-400 hover:text-amber-400 text-sm block w-full">
                                        Back to Sign In
                                    </button>
                                )}
                            </div>
                        </div>

                        <p className="text-center text-slate-500 text-xs mt-4">
                            By signing up, you agree to use this system responsibly for church treasury purposes only.
                        </p>
                    </div>
                </div>
            );
        }

        // Main Treasurer App
        function TreasurerApp() {
            const { user, supabase } = useContext(AuthContext);
            const [titheEntries, setTitheEntries] = useState([]);
            const [expenses, setExpenses] = useState([]);
            const [deposits, setDeposits] = useState([]);
            const [budgetItems, setBudgetItems] = useState([]);
            const [projects, setProjects] = useState([]);
            const [cheques, setCheques] = useState([]);
            const [settings, setSettings] = useState({ previous_balance: 0, unit_trust: 79082.04, revolving_fund: 597996.24 });
            const [view, setView] = useState('dashboard');
            const [editingItem, setEditingItem] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(null);
            const [loading, setLoading] = useState(true);
            
            // Search state
            const [showSearch, setShowSearch] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            
            // Keyboard shortcut for search (Ctrl+K or Cmd+K)
            useEffect(() => {
                const handleKeyDown = (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                        e.preventDefault();
                        setShowSearch(true);
                    }
                    if (e.key === 'Escape' && showSearch) {
                        setShowSearch(false);
                        setSearchQuery('');
                    }
                };
                document.addEventListener('keydown', handleKeyDown);
                return () => document.removeEventListener('keydown', handleKeyDown);
            }, [showSearch]);

            // Role-based access control
            const userRole = user?.user_metadata?.role || 'treasurer';
            const userName = user?.user_metadata?.full_name || user?.email?.split('@')[0] || 'User';
            const canEdit = !['pastor', 'clerk'].includes(userRole);
            const roleLabels = {
                'treasurer': { label: 'Treasurer', color: 'bg-amber-500', icon: 'üí∞' },
                'assistant_treasurer': { label: 'Asst. Treasurer', color: 'bg-emerald-500', icon: 'üìä' },
                'pastor': { label: 'Pastor', color: 'bg-purple-500', icon: 'üëÅÔ∏è' },
                'clerk': { label: 'Clerk', color: 'bg-blue-500', icon: 'üëÅÔ∏è' }
            };
            const currentRole = roleLabels[userRole] || roleLabels['treasurer'];

            const loadData = async () => {
                try {
                    const [titheRes, expenseRes, depositRes, settingsRes, budgetRes, projectsRes] = await Promise.all([
                        supabase.from('tithe_entries').select('*').order('date', { ascending: false }),
                        supabase.from('expenses').select('*').order('created_at', { ascending: false }),
                        supabase.from('deposits').select('*').order('date', { ascending: false }),
                        supabase.from('settings').select('*').single(),
                        supabase.from('budget_items').select('*').order('category', { ascending: true }),
                        supabase.from('projects').select('*').order('created_at', { ascending: false })
                    ]);
                    if (titheRes.data) setTitheEntries(titheRes.data);
                    if (expenseRes.data) setExpenses(expenseRes.data);
                    if (depositRes.data) setDeposits(depositRes.data);
                    if (settingsRes.data) setSettings(settingsRes.data);
                    if (budgetRes.data) setBudgetItems(budgetRes.data);
                    if (projectsRes.data) setProjects(projectsRes.data);
                    
                    // Load cheques separately to avoid breaking if table doesn't exist
                    try {
                        const chequesRes = await supabase.from('cheques').select('*').order('date', { ascending: false });
                        if (chequesRes.data) setCheques(chequesRes.data);
                    } catch (e) {
                        console.log('Cheques table not available yet');
                    }
                } catch (err) {
                    console.error('Load error:', err);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => { loadData(); }, []);

            // Handle navigation events from child components
            useEffect(() => {
                const handleNavigate = (e) => {
                    setView(e.detail.view);
                    setEditingItem(e.detail.item);
                };
                window.addEventListener('navigate', handleNavigate);
                return () => window.removeEventListener('navigate', handleNavigate);
            }, []);

            const handleSignOut = async () => { await supabase.auth.signOut(); };

            const saveTitheEntry = async (entry) => {
                try {
                    // Convert empty strings to 0 for numeric fields
                    const numericFields = ['tithe', 'special_offering', 'ingathering', 'radio', 'nehemiah', 'budget_covenant', 'sabbath_school', 'welfare', 'pos_band', 'school', 'project', 'books', 'raffa_house', 'tv', 'government_fund', 'messages_of_hope', 'total_received', 'total_conf_fund', 'total_church_fund', 'slip_number'];
                    const cleanedEntry = { ...entry };
                    numericFields.forEach(field => {
                        if (cleanedEntry[field] === '' || cleanedEntry[field] === null || cleanedEntry[field] === undefined) {
                            cleanedEntry[field] = 0;
                        } else {
                            cleanedEntry[field] = parseFloat(cleanedEntry[field]) || 0;
                        }
                    });
                    
                    // Handle project_id - must be null not empty string for UUID
                    if (!cleanedEntry.project_id || cleanedEntry.project_id === '') {
                        delete cleanedEntry.project_id;
                    }
                    
                    const data = { ...cleanedEntry, created_by: user.id, created_by_email: user.email, updated_at: new Date().toISOString() };
                    
                    let result;
                    if (entry.id) {
                        result = await supabase.from('tithe_entries').update(data).eq('id', entry.id);
                    } else {
                        delete data.id;
                        result = await supabase.from('tithe_entries').insert(data);
                    }
                    
                    if (result.error) {
                        console.error('Save error:', result.error);
                        alert('Error saving: ' + result.error.message);
                        return;
                    }
                    loadData();
                    setEditingItem(null);
                    setView('tithe');
                } catch (err) {
                    console.error('Exception:', err);
                    alert('Error: ' + err.message);
                }
            };

            const saveExpense = async (entry) => {
                try {
                    // Convert empty strings to 0 for numeric fields
                    const cleanedEntry = { ...entry };
                    if (cleanedEntry.amount === '' || cleanedEntry.amount === null) cleanedEntry.amount = 0;
                    else cleanedEntry.amount = parseFloat(cleanedEntry.amount) || 0;
                    if (cleanedEntry.voucher_number === '' || cleanedEntry.voucher_number === null) cleanedEntry.voucher_number = null;
                    
                    // Handle project_id - must be null not empty string for UUID
                    if (!cleanedEntry.project_id || cleanedEntry.project_id === '') {
                        delete cleanedEntry.project_id;
                    }
                    
                    // Handle attachment_url - remove if empty
                    if (!cleanedEntry.attachment_url || cleanedEntry.attachment_url === '') {
                        delete cleanedEntry.attachment_url;
                    }
                    
                    const data = { ...cleanedEntry, created_by: user.id, created_by_email: user.email };
                    let result;
                    if (entry.id) {
                        result = await supabase.from('expenses').update(data).eq('id', entry.id);
                    } else {
                        delete data.id;
                        result = await supabase.from('expenses').insert(data);
                    }
                    
                    // If attachment_url column error, retry without it
                    if (result.error && result.error.message.includes('attachment_url')) {
                        delete data.attachment_url;
                        if (entry.id) {
                            result = await supabase.from('expenses').update(data).eq('id', entry.id);
                        } else {
                            result = await supabase.from('expenses').insert(data);
                        }
                    }
                    
                    if (result.error) {
                        console.error('Save error:', result.error);
                        alert('Error saving: ' + result.error.message);
                        return;
                    }
                    loadData();
                    setEditingItem(null);
                    setView('expenses');
                } catch (err) {
                    console.error('Exception:', err);
                    alert('Error: ' + err.message);
                }
            };

            const saveDeposit = async (entry) => {
                try {
                    // Convert empty strings to 0 for numeric fields
                    const cleanedEntry = { ...entry };
                    if (cleanedEntry.cash === '' || cleanedEntry.cash === null) cleanedEntry.cash = 0;
                    else cleanedEntry.cash = parseFloat(cleanedEntry.cash) || 0;
                    if (cleanedEntry.cheques === '' || cleanedEntry.cheques === null) cleanedEntry.cheques = 0;
                    else cleanedEntry.cheques = parseFloat(cleanedEntry.cheques) || 0;
                    if (cleanedEntry.total === '' || cleanedEntry.total === null) cleanedEntry.total = 0;
                    else cleanedEntry.total = parseFloat(cleanedEntry.total) || 0;
                    
                    const data = { ...cleanedEntry, created_by: user.id, created_by_email: user.email };
                    let result;
                    if (entry.id) {
                        result = await supabase.from('deposits').update(data).eq('id', entry.id);
                    } else {
                        delete data.id;
                        result = await supabase.from('deposits').insert(data);
                    }
                    if (result.error) {
                        console.error('Save error:', result.error);
                        alert('Error saving: ' + result.error.message);
                        return;
                    }
                    loadData();
                    setEditingItem(null);
                    setView('deposits');
                } catch (err) {
                    console.error('Exception:', err);
                    alert('Error: ' + err.message);
                }
            };

            const saveCheque = async (entry) => {
                try {
                    const cleanedEntry = { ...entry };
                    if (cleanedEntry.amount === '' || cleanedEntry.amount === null) cleanedEntry.amount = 0;
                    else cleanedEntry.amount = parseFloat(cleanedEntry.amount) || 0;
                    
                    const data = { ...cleanedEntry, created_by: user.id, created_by_email: user.email };
                    let result;
                    if (entry.id) {
                        result = await supabase.from('cheques').update(data).eq('id', entry.id);
                    } else {
                        delete data.id;
                        result = await supabase.from('cheques').insert(data);
                    }
                    if (result.error) {
                        console.error('Save error:', result.error);
                        alert('Error saving cheque: ' + result.error.message);
                        return;
                    }
                    loadData();
                    setEditingItem(null);
                    setView('cheques');
                } catch (err) {
                    console.error('Exception:', err);
                    alert('Error: ' + err.message);
                }
            };

            const handleDelete = async (type, id) => {
                if (type === 'tithe') await supabase.from('tithe_entries').delete().eq('id', id);
                else if (type === 'expense') await supabase.from('expenses').delete().eq('id', id);
                else if (type === 'deposit') await supabase.from('deposits').delete().eq('id', id);
                else if (type === 'cheque') await supabase.from('cheques').delete().eq('id', id);
                loadData();
                setShowDeleteConfirm(null);
            };

            const saveSettings = async (newSettings) => {
                await supabase.from('settings').update(newSettings).eq('id', 1);
                setSettings(newSettings);
            };

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <div className="text-center">
                            <div className="w-12 h-12 border-4 border-amber-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-slate-400">Loading data...</p>
                        </div>
                    </div>
                );
            }

            const navItems = [
                { key: 'dashboard', label: 'Dashboard' },
                { key: 'tithe', label: 'Tithes' },
                { key: 'expenses', label: 'Expenses' },
                { key: 'projects', label: 'Projects' },
                { key: 'budget', label: 'Budget' },
                { key: 'forecasting', label: 'Forecasting' },
                { key: 'reports', label: 'Reports' },
                { key: 'statement', label: 'Statement' },
            ];

            const titheTotals = calculateTitheTotals(titheEntries, expenses);
            const expenseTotal = expenses.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);

            // Search function
            const getSearchResults = () => {
                if (!searchQuery || searchQuery.length < 2) return { tithes: [], expenses: [], projects: [] };
                const q = searchQuery.toLowerCase();
                
                const tithes = titheEntries.filter(t => 
                    t.name?.toLowerCase().includes(q) || 
                    t.date?.includes(q) ||
                    String(t.slip_number)?.includes(q)
                ).slice(0, 10);
                
                const expenseResults = expenses.filter(e => 
                    e.description?.toLowerCase().includes(q) || 
                    e.category?.toLowerCase().includes(q) ||
                    e.department?.toLowerCase().includes(q) ||
                    e.date?.includes(q) ||
                    e.cheque_number?.includes(q)
                ).slice(0, 10);
                
                const projectResults = (projects || []).filter(p => 
                    p.name?.toLowerCase().includes(q) || 
                    p.description?.toLowerCase().includes(q)
                ).slice(0, 10);
                
                return { tithes, expenses: expenseResults, projects: projectResults };
            };
            
            const searchResults = getSearchResults();
            const totalResults = searchResults.tithes.length + searchResults.expenses.length + searchResults.projects.length;

            return (
                <div className="min-h-screen">
                    {/* Header */}
                    <header className="bg-slate-800/90 border-b border-amber-500/20 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-3 py-2">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <div className="w-9 h-9 bg-gradient-to-br from-amber-400 to-amber-600 rounded-lg flex items-center justify-center shadow-lg">‚õ™</div>
                                    <div className="hidden sm:block">
                                        <h1 className="text-sm font-bold text-white">Diego Martin SDA Church</h1>
                                        <p className="text-amber-400/80 text-xs">Treasury Management System</p>
                                    </div>
                                </div>
                                <nav className="flex gap-1 flex-wrap">
                                    {navItems.map(item => (
                                        <button key={item.key} onClick={() => { setEditingItem(null); setView(item.key); }} className={`px-2 py-1.5 rounded-lg text-xs font-medium ${view === item.key || view.startsWith(item.key) ? 'bg-amber-500 text-slate-900' : 'bg-slate-700/50 text-slate-300 hover:bg-slate-700'}`}>
                                            {item.label}
                                        </button>
                                    ))}
                                </nav>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => setShowSearch(true)} className="p-1.5 rounded-lg bg-slate-700/50 text-slate-300 hover:bg-slate-700 hover:text-white" title="Search (Ctrl+K)">
                                        üîç
                                    </button>
                                    <div className="hidden sm:flex items-center gap-2">
                                        <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${currentRole.color} text-white`}>
                                            {currentRole.icon} {currentRole.label}
                                        </span>
                                        <span className="text-xs text-slate-400">{userName}</span>
                                    </div>
                                    <button onClick={handleSignOut} className="px-2 py-1.5 rounded-lg text-xs bg-slate-700 text-slate-300 hover:bg-red-600">Sign Out</button>
                                </div>
                            </div>
                            {!canEdit && (
                                <div className="mt-2 bg-purple-500/10 border border-purple-500/30 rounded-lg px-3 py-1.5 text-xs text-purple-300 text-center">
                                    üëÅÔ∏è You have view-only access. Contact the treasurer if you need to make changes.
                                </div>
                            )}
                        </div>
                    </header>

                    {/* Search Modal */}
                    {showSearch && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-start justify-center pt-20 px-4" onClick={() => setShowSearch(false)}>
                            <div className="bg-slate-800 rounded-xl border border-slate-600 w-full max-w-2xl shadow-2xl" onClick={e => e.stopPropagation()}>
                                <div className="p-4 border-b border-slate-700">
                                    <div className="flex items-center gap-3">
                                        <span className="text-xl">üîç</span>
                                        <input 
                                            type="text" 
                                            placeholder="Search tithes, expenses, projects..." 
                                            value={searchQuery}
                                            onChange={e => setSearchQuery(e.target.value)}
                                            className="flex-1 bg-transparent text-white text-lg outline-none placeholder-slate-500"
                                            autoFocus
                                        />
                                        <button onClick={() => setShowSearch(false)} className="text-slate-400 hover:text-white">‚úï</button>
                                    </div>
                                </div>
                                
                                {searchQuery.length >= 2 ? (
                                    <div className="max-h-96 overflow-y-auto">
                                        {totalResults === 0 ? (
                                            <div className="p-8 text-center text-slate-400">
                                                <p className="text-4xl mb-2">üîç</p>
                                                <p>No results found for "{searchQuery}"</p>
                                            </div>
                                        ) : (
                                            <div className="p-2">
                                                {/* Tithe Results */}
                                                {searchResults.tithes.length > 0 && (
                                                    <div className="mb-3">
                                                        <p className="text-xs text-amber-400 font-semibold px-2 py-1">TITHES ({searchResults.tithes.length})</p>
                                                        {searchResults.tithes.map(t => (
                                                            <div 
                                                                key={t.id} 
                                                                onClick={() => { setShowSearch(false); setSearchQuery(''); setView('tithe'); }}
                                                                className="flex items-center justify-between px-3 py-2 hover:bg-slate-700/50 rounded-lg cursor-pointer"
                                                            >
                                                                <div>
                                                                    <p className="text-white text-sm font-medium">{t.name}</p>
                                                                    <p className="text-slate-400 text-xs">Slip #{t.slip_number} ‚Ä¢ {t.date}</p>
                                                                </div>
                                                                <span className="text-amber-400 font-medium">{fmtCur(t.total_received)}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                                
                                                {/* Expense Results */}
                                                {searchResults.expenses.length > 0 && (
                                                    <div className="mb-3">
                                                        <p className="text-xs text-red-400 font-semibold px-2 py-1">EXPENSES ({searchResults.expenses.length})</p>
                                                        {searchResults.expenses.map(e => (
                                                            <div 
                                                                key={e.id} 
                                                                onClick={() => { setShowSearch(false); setSearchQuery(''); setView('expenses'); }}
                                                                className="flex items-center justify-between px-3 py-2 hover:bg-slate-700/50 rounded-lg cursor-pointer"
                                                            >
                                                                <div>
                                                                    <p className="text-white text-sm font-medium">{e.description}</p>
                                                                    <p className="text-slate-400 text-xs">{e.category} ‚Ä¢ {e.date}{e.cheque_number ? ` ‚Ä¢ Chq#${e.cheque_number}` : ''}</p>
                                                                </div>
                                                                <span className="text-red-400 font-medium">{fmtCur(e.amount)}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                                
                                                {/* Project Results */}
                                                {searchResults.projects.length > 0 && (
                                                    <div className="mb-3">
                                                        <p className="text-xs text-emerald-400 font-semibold px-2 py-1">PROJECTS ({searchResults.projects.length})</p>
                                                        {searchResults.projects.map(p => (
                                                            <div 
                                                                key={p.id} 
                                                                onClick={() => { setShowSearch(false); setSearchQuery(''); setView('projects'); }}
                                                                className="flex items-center justify-between px-3 py-2 hover:bg-slate-700/50 rounded-lg cursor-pointer"
                                                            >
                                                                <div>
                                                                    <p className="text-white text-sm font-medium">{p.name}</p>
                                                                    <p className="text-slate-400 text-xs">{p.status} ‚Ä¢ Target: {fmtCur(p.target_amount)}</p>
                                                                </div>
                                                                <span className={`text-xs px-2 py-0.5 rounded ${p.status === 'Active' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-500/20 text-slate-400'}`}>{p.status}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                ) : (
                                    <div className="p-8 text-center text-slate-400">
                                        <p className="text-sm">Type at least 2 characters to search</p>
                                        <p className="text-xs mt-2 text-slate-500">Search by name, date, slip #, description, category, cheque #, etc.</p>
                                    </div>
                                )}
                                
                                <div className="p-3 border-t border-slate-700 flex justify-between text-xs text-slate-500">
                                    <span>Press ESC to close</span>
                                    <span>{totalResults} result{totalResults !== 1 ? 's' : ''}</span>
                                </div>
                            </div>
                        </div>
                    )}

                    <main className="max-w-7xl mx-auto px-3 py-4">
                        {/* Dashboard */}
                        {view === 'dashboard' && (
                            <div className="space-y-4">
                                <div className="grid grid-cols-2 lg:grid-cols-5 gap-3">
                                    <div className="bg-gradient-to-br from-amber-500/20 to-transparent rounded-xl border border-amber-500/30 p-3">
                                        <p className="text-xs text-slate-400">Total Received</p>
                                        <p className="text-lg font-bold text-white">{fmtCur(titheTotals.totalReceived)}</p>
                                        <p className="text-xs text-slate-500">{titheEntries.length} entries</p>
                                    </div>
                                    <div className="bg-gradient-to-br from-cyan-500/20 to-transparent rounded-xl border border-cyan-500/30 p-3">
                                        <p className="text-xs text-slate-400">Church Income</p>
                                        <p className="text-lg font-bold text-cyan-400">{fmtCur(titheTotals.churchOperating)}</p>
                                        <p className="text-xs text-slate-500">60% (BC - School - CH)</p>
                                    </div>
                                    <div className="bg-gradient-to-br from-emerald-500/20 to-transparent rounded-xl border border-emerald-500/30 p-3">
                                        <p className="text-xs text-slate-400">Conference Funds</p>
                                        <p className="text-lg font-bold text-white">{fmtCur(titheTotals.grandTotalConference)}</p>
                                        <p className="text-xs text-slate-500">Tithe + 40%</p>
                                    </div>
                                    <div className="bg-gradient-to-br from-red-500/20 to-transparent rounded-xl border border-red-500/30 p-3">
                                        <p className="text-xs text-slate-400">Total Expenses</p>
                                        <p className="text-lg font-bold text-white">{fmtCur(expenseTotal)}</p>
                                        <p className="text-xs text-slate-500">{expenses.length} payments</p>
                                    </div>
                                    <div className="bg-gradient-to-br from-blue-500/20 to-transparent rounded-xl border border-blue-500/30 p-3">
                                        <p className="text-xs text-slate-400">Total Tithe Income</p>
                                        <p className="text-lg font-bold text-white">{fmtCur(titheTotals.tithe)}</p>
                                        <p className="text-xs text-slate-500">Tithe only</p>
                                    </div>
                                </div>
                                
                                {/* Charts Section */}
                                {(() => {
                                    const currentYear = new Date().getFullYear();
                                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                    
                                    // Calculate monthly data
                                    const monthlyIncome = Array(12).fill(0);
                                    const monthlyExpenses = Array(12).fill(0);
                                    const monthlyTithe = Array(12).fill(0);
                                    
                                    titheEntries.forEach(e => {
                                        const d = new Date(e.date);
                                        if (d.getFullYear() === currentYear) {
                                            monthlyIncome[d.getMonth()] += parseFloat(e.total_received) || 0;
                                            monthlyTithe[d.getMonth()] += parseFloat(e.tithe) || 0;
                                        }
                                    });
                                    
                                    expenses.forEach(e => {
                                        const d = new Date(e.date);
                                        if (d.getFullYear() === currentYear) {
                                            monthlyExpenses[d.getMonth()] += parseFloat(e.amount) || 0;
                                        }
                                    });
                                    
                                    const maxIncomeExpense = Math.max(...monthlyIncome, ...monthlyExpenses, 1);
                                    const maxTithe = Math.max(...monthlyTithe, 1);
                                    
                                    return (
                                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                            {/* Income vs Expenses Chart */}
                                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                                <h3 className="text-sm font-semibold text-white mb-4">Income vs Expenses ({currentYear})</h3>
                                                <div className="flex items-end justify-between gap-1 h-40">
                                                    {months.map((month, idx) => (
                                                        <div key={month} className="flex-1 flex flex-col items-center gap-1">
                                                            <div className="w-full flex gap-0.5 items-end h-32">
                                                                <div className="flex-1 bg-amber-500 rounded-t transition-all" style={{ height: `${(monthlyIncome[idx] / maxIncomeExpense) * 100}%`, minHeight: monthlyIncome[idx] > 0 ? '4px' : '0' }} title={`Income: ${fmtCur(monthlyIncome[idx])}`}></div>
                                                                <div className="flex-1 bg-red-500 rounded-t transition-all" style={{ height: `${(monthlyExpenses[idx] / maxIncomeExpense) * 100}%`, minHeight: monthlyExpenses[idx] > 0 ? '4px' : '0' }} title={`Expenses: ${fmtCur(monthlyExpenses[idx])}`}></div>
                                                            </div>
                                                            <span className="text-xs text-slate-500">{month}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                                <div className="flex justify-center gap-6 mt-3">
                                                    <div className="flex items-center gap-2"><div className="w-3 h-3 bg-amber-500 rounded"></div><span className="text-xs text-slate-400">Income</span></div>
                                                    <div className="flex items-center gap-2"><div className="w-3 h-3 bg-red-500 rounded"></div><span className="text-xs text-slate-400">Expenses</span></div>
                                                </div>
                                            </div>
                                            
                                            {/* Conference Funds Breakdown */}
                                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                                <h3 className="text-sm font-semibold text-white mb-4">Conference Funds Breakdown</h3>
                                                <div className="space-y-3">
                                                    {(() => {
                                                        const confItems = [
                                                            { label: 'Tithe', value: titheTotals.tithe || 0, color: 'bg-emerald-500' },
                                                            { label: 'Special Offering', value: titheTotals.special_offering || 0, color: 'bg-blue-500' },
                                                            { label: 'Ingathering', value: titheTotals.ingathering || 0, color: 'bg-purple-500' },
                                                            { label: '3ABN/Radio', value: titheTotals.radio || 0, color: 'bg-pink-500' },
                                                            { label: '40% Church Offering', value: titheTotals.percentage40 || 0, color: 'bg-amber-500' },
                                                        ];
                                                        const maxConf = Math.max(...confItems.map(i => i.value), 1);
                                                        return confItems.map(item => (
                                                            <div key={item.label} className="flex items-center gap-3">
                                                                <span className="text-xs text-slate-400 w-32 truncate">{item.label}</span>
                                                                <div className="flex-1 h-4 bg-slate-700 rounded-full overflow-hidden">
                                                                    <div className={`h-full ${item.color} rounded-full transition-all`} style={{ width: `${(item.value / maxConf) * 100}%` }}></div>
                                                                </div>
                                                                <span className="text-xs text-white w-20 text-right">{fmtCur(item.value)}</span>
                                                            </div>
                                                        ));
                                                    })()}
                                                    <div className="pt-2 border-t border-slate-700 flex justify-between">
                                                        <span className="text-sm font-semibold text-emerald-400">Total to Conference</span>
                                                        <span className="text-sm font-bold text-emerald-400">{fmtCur(titheTotals.grandTotalConference)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            {/* Monthly Tithe Chart */}
                                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                                <h3 className="text-sm font-semibold text-white mb-4">Monthly Tithe ({currentYear})</h3>
                                                <div className="flex items-end justify-between gap-1 h-40">
                                                    {months.map((month, idx) => (
                                                        <div key={month} className="flex-1 flex flex-col items-center gap-1">
                                                            <div className="w-full flex justify-center items-end h-32">
                                                                <div className="w-full bg-emerald-500 rounded-t transition-all" style={{ height: `${(monthlyTithe[idx] / maxTithe) * 100}%`, minHeight: monthlyTithe[idx] > 0 ? '4px' : '0' }} title={fmtCur(monthlyTithe[idx])}></div>
                                                            </div>
                                                            <span className="text-xs text-slate-500">{month}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                                <div className="mt-3 text-center">
                                                    <span className="text-xs text-slate-400">Total Tithe: </span>
                                                    <span className="text-sm font-bold text-emerald-400">{fmtCur(titheTotals.tithe)}</span>
                                                </div>
                                            </div>
                                            
                                            {/* Church Funds Breakdown */}
                                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                                <h3 className="text-sm font-semibold text-white mb-4">Church Funds Breakdown</h3>
                                                <div className="space-y-3">
                                                    {(() => {
                                                        const churchItems = [
                                                            { label: 'Budget Covenant', value: titheTotals.budget_covenant || 0, color: 'bg-cyan-500' },
                                                            { label: 'Welfare', value: titheTotals.welfare || 0, color: 'bg-orange-500' },
                                                            { label: 'Church Building Fund', value: titheTotals.project || 0, color: 'bg-purple-500' },
                                                            { label: 'School', value: titheTotals.school || 0, color: 'bg-yellow-500' },
                                                            { label: 'Other', value: (titheTotals.books || 0) + (titheTotals.raffa_house || 0) + (titheTotals.tv || 0) + (titheTotals.pos_band || 0) + (titheTotals.government_fund || 0), color: 'bg-slate-500' },
                                                        ];
                                                        const maxChurch = Math.max(...churchItems.map(i => i.value), 1);
                                                        return churchItems.map(item => (
                                                            <div key={item.label} className="flex items-center gap-3">
                                                                <span className="text-xs text-slate-400 w-32 truncate">{item.label}</span>
                                                                <div className="flex-1 h-4 bg-slate-700 rounded-full overflow-hidden">
                                                                    <div className={`h-full ${item.color} rounded-full transition-all`} style={{ width: `${(item.value / maxChurch) * 100}%` }}></div>
                                                                </div>
                                                                <span className="text-xs text-white w-20 text-right">{fmtCur(item.value)}</span>
                                                            </div>
                                                        ));
                                                    })()}
                                                    <div className="pt-2 border-t border-slate-700 flex justify-between">
                                                        <span className="text-sm font-semibold text-blue-400">Total Church Funds</span>
                                                        <span className="text-sm font-bold text-blue-400">{fmtCur(titheTotals.totalChurchFund)}</span>
                                                    </div>
                                                    <div className="flex justify-between text-xs">
                                                        <span className="text-slate-500">60% Local Operating</span>
                                                        <span className="text-slate-400">{fmtCur(titheTotals.churchOperating)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })()}
                            </div>
                        )}

                        {/* Tithe List */}
                        {view === 'tithe' && (
                            <TitheListView titheEntries={titheEntries} expenses={expenses} canEdit={canEdit} setEditingItem={setEditingItem} setView={setView} setShowDeleteConfirm={setShowDeleteConfirm} />
                        )}

                        {/* Tithe Entry Form */}
                        {view === 'tithe-entry' && (
                            <TitheForm onSubmit={saveTitheEntry} onCancel={() => setView('tithe')} initialData={editingItem} titheEntries={titheEntries} projects={projects} />
                        )}

                        {/* Expenses List */}
                        {view === 'expenses' && (
                            <ExpenseListView expenses={expenses} canEdit={canEdit} setEditingItem={setEditingItem} setView={setView} setShowDeleteConfirm={setShowDeleteConfirm} supabase={supabase} loadData={loadData} />
                        )}

                        {/* Expense Form */}
                        {view === 'expense-entry' && (
                            <ExpenseForm onSubmit={saveExpense} onCancel={() => setView('expenses')} initialData={editingItem} nextVoucher={expenses.length + 1} supabase={supabase} projects={projects} />
                        )}


                        {/* Projects */}
                        {view === 'projects' && (
                            <ProjectsSection 
                                projects={projects}
                                titheEntries={titheEntries}
                                expenses={expenses}
                                supabase={supabase}
                                user={user}
                                onUpdate={loadData}
                                canEdit={canEdit}
                            />
                        )}

                        {/* Project Form */}
                        {view === 'project-entry' && (
                            <ProjectForm 
                                onSubmit={async (project) => {
                                    try {
                                        const data = { 
                                            ...project, 
                                            target_amount: project.target_amount === '' ? null : parseFloat(project.target_amount) || null,
                                            opening_balance: project.opening_balance === '' ? 0 : parseFloat(project.opening_balance) || 0,
                                            created_by: user.id, 
                                            created_by_email: user.email 
                                        };
                                        if (project.id) {
                                            await supabase.from('projects').update(data).eq('id', project.id);
                                        } else {
                                            delete data.id;
                                            const { error } = await supabase.from('projects').insert(data);
                                            if (error) throw error;
                                        }
                                        loadData();
                                        setEditingItem(null);
                                        setView('projects');
                                    } catch (err) {
                                        alert('Error saving project: ' + err.message);
                                    }
                                }}
                                onCancel={() => { setEditingItem(null); setView('projects'); }}
                                initialData={editingItem}
                            />
                        )}

                        {/* Budget */}
                        {view === 'budget' && (
                            <BudgetSection 
                                budgetItems={budgetItems} 
                                expenses={expenses} 
                                supabase={supabase}
                                user={user}
                                onUpdate={loadData}
                            />
                        )}

                        {/* Forecasting */}
                        {view === 'forecasting' && (
                            <ForecastingSection 
                                titheEntries={titheEntries}
                                expenses={expenses}
                                deposits={deposits}
                                settings={settings}
                            />
                        )}


                        {/* Reports */}
                        {view === 'reports' && (
                            <ReportsSection titheEntries={titheEntries} expenses={expenses} deposits={deposits} projects={projects} settings={settings} />
                        )}

                        {/* Financial Statement */}
                        {view === 'statement' && (
                            <FinancialStatement 
                                titheEntries={titheEntries} 
                                expenses={expenses} 
                                deposits={deposits} 
                                settings={settings}
                                saveSettings={saveSettings}
                                projects={projects}
                            />
                        )}
                    </main>

                    {/* Delete Confirm Modal */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50">
                            <div className="bg-slate-800 rounded-xl p-5 max-w-sm w-full mx-4 border border-slate-700">
                                <h3 className="text-lg font-bold text-white mb-2">Confirm Delete</h3>
                                <p className="text-slate-400 text-sm mb-4">Are you sure?</p>
                                <div className="flex gap-2 justify-end">
                                    <button onClick={() => setShowDeleteConfirm(null)} className="px-3 py-2 rounded-lg bg-slate-700 text-slate-300 text-sm">Cancel</button>
                                    <button onClick={() => handleDelete(showDeleteConfirm.type, showDeleteConfirm.id)} className="px-3 py-2 rounded-lg bg-red-600 text-white text-sm">Delete</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Tithe Form Component
        // Tithe List Component with date range filtering
        function TitheListView({ titheEntries, expenses, canEdit, setEditingItem, setView, setShowDeleteConfirm }) {
            const [titheStartDate, setTitheStartDate] = useState(new Date().getFullYear() + '-01-01');
            const [titheEndDate, setTitheEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [titheMemberFilter, setTitheMemberFilter] = useState('');
            
            const filtered = titheEntries.filter(e => {
                const matchDate = e.date >= titheStartDate && e.date <= titheEndDate;
                const matchMember = !titheMemberFilter || e.name.toLowerCase().includes(titheMemberFilter.toLowerCase());
                return matchDate && matchMember;
            }).sort((a, b) => {
                if (a.date !== b.date) return b.date.localeCompare(a.date);
                return (parseInt(b.slip_number) || 0) - (parseInt(a.slip_number) || 0);
            });
            
            const totals = calculateTitheTotals(filtered, expenses.filter(e => e.date >= titheStartDate && e.date <= titheEndDate));
            
            return (
            <div className="space-y-3">
                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-3">
                    <div className="flex flex-wrap gap-3 items-end">
                        <div><label className="text-xs text-slate-400 block mb-1">From</label><input type="date" value={titheStartDate} onChange={e => setTitheStartDate(e.target.value)} className="px-2 py-1.5 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm" /></div>
                        <div><label className="text-xs text-slate-400 block mb-1">To</label><input type="date" value={titheEndDate} onChange={e => setTitheEndDate(e.target.value)} className="px-2 py-1.5 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm" /></div>
                        <div className="flex-1 min-w-[150px]"><label className="text-xs text-slate-400 block mb-1">Member</label><input type="text" placeholder="Filter by name..." value={titheMemberFilter} onChange={e => setTitheMemberFilter(e.target.value)} className="w-full px-2 py-1.5 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm" /></div>
                        {canEdit && <button onClick={() => { setEditingItem(null); setView('tithe-entry'); }} className="px-3 py-2 bg-amber-500 text-slate-900 rounded-lg text-sm font-medium">+ New Entry</button>}
                    </div>
                </div>
                
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-2">
                    <div className="bg-gradient-to-br from-amber-500/20 to-transparent rounded-xl border border-amber-500/30 p-3">
                        <p className="text-xs text-slate-400">Total Received</p>
                        <p className="text-lg font-bold text-amber-400">{fmtCur(totals.totalReceived)}</p>
                        <p className="text-xs text-slate-500">{filtered.length} entries</p>
                    </div>
                    <div className="bg-gradient-to-br from-emerald-500/20 to-transparent rounded-xl border border-emerald-500/30 p-3">
                        <p className="text-xs text-slate-400">Conference Funds</p>
                        <p className="text-lg font-bold text-emerald-400">{fmtCur(totals.grandTotalConference)}</p>
                    </div>
                    <div className="bg-gradient-to-br from-cyan-500/20 to-transparent rounded-xl border border-cyan-500/30 p-3">
                        <p className="text-xs text-slate-400">Church Funds</p>
                        <p className="text-lg font-bold text-cyan-400">{fmtCur(totals.totalChurchFund)}</p>
                    </div>
                    <div className="bg-gradient-to-br from-blue-500/20 to-transparent rounded-xl border border-blue-500/30 p-3">
                        <p className="text-xs text-slate-400">Church Income (60%)</p>
                        <p className="text-lg font-bold text-blue-400">{fmtCur(totals.churchOperating)}</p>
                    </div>
                </div>
                
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-3">
                    <div className="bg-slate-800/50 rounded-xl border border-emerald-500/30 p-3">
                        <h4 className="text-xs font-semibold text-emerald-400 mb-2">CONFERENCE FUNDS</h4>
                        <div className="space-y-1">
                            {CONFERENCE_FIELDS.map(f => (
                                <div key={f.key} className="flex justify-between text-sm">
                                    <span className="text-slate-400">{f.label}</span>
                                    <span className="text-white">{fmtCur(totals[f.key] || 0)}</span>
                                </div>
                            ))}
                            <div className="flex justify-between text-sm font-semibold pt-1 border-t border-slate-700">
                                <span className="text-slate-400">40% Church Offering</span>
                                <span className="text-amber-400">{fmtCur(totals.percentage40 || 0)}</span>
                            </div>
                            <div className="flex justify-between text-sm font-bold pt-1 border-t border-emerald-500/30">
                                <span className="text-emerald-400">Grand Total to Conference</span>
                                <span className="text-emerald-400">{fmtCur(totals.grandTotalConference)}</span>
                            </div>
                        </div>
                    </div>
                    <div className="bg-slate-800/50 rounded-xl border border-cyan-500/30 p-3">
                        <h4 className="text-xs font-semibold text-cyan-400 mb-2">CHURCH FUNDS</h4>
                        <div className="space-y-1">
                            {CHURCH_FIELDS.map(f => (
                                <div key={f.key} className="flex justify-between text-sm">
                                    <span className="text-slate-400">{f.label}</span>
                                    <span className="text-white">{fmtCur(totals[f.key] || 0)}</span>
                                </div>
                            ))}
                            <div className="flex justify-between text-sm font-bold pt-1 border-t border-cyan-500/30">
                                <span className="text-cyan-400">Total Church Funds</span>
                                <span className="text-cyan-400">{fmtCur(totals.totalChurchFund)}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div className="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                    <table className="w-full text-sm">
                        <thead><tr className="border-b border-slate-700 bg-slate-800/50">
                            <th className="px-3 py-2 text-left text-amber-400">Date</th>
                            <th className="px-3 py-2 text-center text-amber-400">Slip #</th>
                            <th className="px-3 py-2 text-left text-amber-400">Name</th>
                            <th className="px-3 py-2 text-right text-amber-400">Tithe</th>
                            <th className="px-3 py-2 text-right text-amber-400">Total</th>
                            <th className="px-3 py-2 text-left text-amber-400">By</th>
                            <th className="px-3 py-2 text-center text-amber-400">Actions</th>
                        </tr></thead>
                        <tbody>
                            {filtered.map(e => (
                                <tr key={e.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                    <td className="px-3 py-2 text-slate-300">{e.date}</td>
                                    <td className="px-3 py-2 text-center text-blue-400">{e.slip_number || '-'}</td>
                                    <td className="px-3 py-2 text-white">{e.name}</td>
                                    <td className="px-3 py-2 text-right text-emerald-400">{fmtCur(e.tithe)}</td>
                                    <td className="px-3 py-2 text-right text-amber-400 font-semibold">{fmtCur(e.total_received)}</td>
                                    <td className="px-3 py-2 text-slate-500 text-xs">{e.created_by_email?.split('@')[0]}</td>
                                    <td className="px-3 py-2 text-center">
                                        {canEdit ? (
                                            <>
                                                <button onClick={() => { setEditingItem(e); setView('tithe-entry'); }} className="px-2 py-1 rounded bg-slate-700 text-slate-300 text-xs mr-1 hover:bg-blue-600">Edit</button>
                                                <button onClick={() => setShowDeleteConfirm({ type: 'tithe', id: e.id })} className="px-2 py-1 rounded bg-slate-700 text-slate-300 text-xs hover:bg-red-600">Del</button>
                                            </>
                                        ) : <span className="text-slate-500 text-xs">View only</span>}
                                    </td>
                                </tr>
                            ))}
                            {filtered.length === 0 && <tr><td colSpan="7" className="px-3 py-8 text-center text-slate-500">No entries in selected range</td></tr>}
                        </tbody>
                        {filtered.length > 0 && (
                            <tfoot><tr className="bg-slate-700/30 font-semibold">
                                <td colSpan="3" className="px-3 py-2 text-white">Totals ({filtered.length} entries)</td>
                                <td className="px-3 py-2 text-right text-emerald-400">{fmtCur(totals.tithe || 0)}</td>
                                <td className="px-3 py-2 text-right text-amber-400">{fmtCur(totals.totalReceived)}</td>
                                <td colSpan="2"></td>
                            </tr></tfoot>
                        )}
                    </table>
                </div>
            </div>
            );
        }

        // Expense List Component with date range filtering and cheque status
        function ExpenseListView({ expenses, canEdit, setEditingItem, setView, setShowDeleteConfirm, supabase, loadData }) {
            const [expStartDate, setExpStartDate] = useState(new Date().getFullYear() + '-01-01');
            const [expEndDate, setExpEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [chequeFilter, setChequeFilter] = useState('all');
            
            const toggleChequeStatus = async (expense) => {
                const newStatus = expense.cheque_status === 'Cashed' ? 'Uncashed' : 'Cashed';
                try {
                    await supabase.from('expenses').update({ cheque_status: newStatus }).eq('id', expense.id);
                    loadData();
                } catch (err) {
                    alert('Error updating status: ' + err.message);
                }
            };
            
            const filtered = expenses.filter(e => {
                const matchDate = e.date >= expStartDate && e.date <= expEndDate;
                const matchCheque = chequeFilter === 'all' || 
                    (chequeFilter === 'cashed' && e.cheque_status === 'Cashed') ||
                    (chequeFilter === 'uncashed' && e.cheque_number && e.cheque_status !== 'Cashed');
                return matchDate && matchCheque;
            });
            
            const total = filtered.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
            const chequeExpenses = expenses.filter(e => e.cheque_number && e.date >= expStartDate && e.date <= expEndDate);
            const cashedTotal = chequeExpenses.filter(e => e.cheque_status === 'Cashed').reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
            const uncashedTotal = chequeExpenses.filter(e => e.cheque_status !== 'Cashed').reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
            const cashedCount = chequeExpenses.filter(e => e.cheque_status === 'Cashed').length;
            const uncashedCount = chequeExpenses.filter(e => e.cheque_status !== 'Cashed').length;
            
            const deptTotals = {};
            filtered.forEach(e => {
                const dept = e.department || 'Uncategorized';
                deptTotals[dept] = (deptTotals[dept] || 0) + (parseFloat(e.amount) || 0);
            });
            
            return (
            <div className="space-y-3">
                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-3">
                    <div className="flex flex-wrap gap-3 items-end">
                        <div><label className="text-xs text-slate-400 block mb-1">From</label><input type="date" value={expStartDate} onChange={e => setExpStartDate(e.target.value)} className="px-2 py-1.5 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm" /></div>
                        <div><label className="text-xs text-slate-400 block mb-1">To</label><input type="date" value={expEndDate} onChange={e => setExpEndDate(e.target.value)} className="px-2 py-1.5 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm" /></div>
                        <div>
                            <label className="text-xs text-slate-400 block mb-1">Cheque Status</label>
                            <select value={chequeFilter} onChange={e => setChequeFilter(e.target.value)} className="px-2 py-1.5 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm">
                                <option value="all">All Expenses</option>
                                <option value="cashed">Cashed Cheques</option>
                                <option value="uncashed">Uncashed Cheques</option>
                            </select>
                        </div>
                        {canEdit && <button onClick={() => { setEditingItem(null); setView('expense-entry'); }} className="px-3 py-2 bg-red-500 text-white rounded-lg text-sm font-medium">+ New Expense</button>}
                    </div>
                </div>
                
                <div className="grid grid-cols-2 lg:grid-cols-4 gap-2">
                    <div className="bg-gradient-to-br from-red-500/20 to-transparent rounded-xl border border-red-500/30 p-3">
                        <p className="text-xs text-slate-400">Total Expenses</p>
                        <p className="text-lg font-bold text-red-400">{fmtCur(total)}</p>
                        <p className="text-xs text-slate-500">{filtered.length} payments</p>
                    </div>
                    <div className="bg-gradient-to-br from-amber-500/20 to-transparent rounded-xl border border-amber-500/30 p-3">
                        <p className="text-xs text-slate-400">Departments</p>
                        <p className="text-lg font-bold text-amber-400">{Object.keys(deptTotals).length}</p>
                    </div>
                    <div className="bg-gradient-to-br from-emerald-500/20 to-transparent rounded-xl border border-emerald-500/30 p-3 cursor-pointer hover:border-emerald-400" onClick={() => setChequeFilter('cashed')}>
                        <p className="text-xs text-slate-400">Cashed Cheques</p>
                        <p className="text-lg font-bold text-emerald-400">{fmtCur(cashedTotal)}</p>
                        <p className="text-xs text-slate-500">{cashedCount} cheques</p>
                    </div>
                    <div className="bg-gradient-to-br from-orange-500/20 to-transparent rounded-xl border border-orange-500/30 p-3 cursor-pointer hover:border-orange-400" onClick={() => setChequeFilter('uncashed')}>
                        <p className="text-xs text-slate-400">Uncashed Cheques</p>
                        <p className="text-lg font-bold text-orange-400">{fmtCur(uncashedTotal)}</p>
                        <p className="text-xs text-slate-500">{uncashedCount} cheques</p>
                    </div>
                </div>

                <div className="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                    <table className="w-full text-sm">
                        <thead><tr className="border-b border-slate-700 bg-slate-800/50">
                            <th className="px-3 py-2 text-left text-red-400">Date</th>
                            <th className="px-3 py-2 text-left text-red-400">Description</th>
                            <th className="px-3 py-2 text-left text-red-400">Department</th>
                            <th className="px-3 py-2 text-left text-red-400">Cheque #</th>
                            <th className="px-3 py-2 text-center text-red-400">Status</th>
                            <th className="px-3 py-2 text-right text-red-400">Amount</th>
                            <th className="px-3 py-2 text-center text-red-400">üìé</th>
                            <th className="px-3 py-2 text-center text-red-400">Actions</th>
                        </tr></thead>
                        <tbody>
                            {filtered.map(e => (
                                <tr key={e.id} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                    <td className="px-3 py-2 text-slate-300">{e.date}</td>
                                    <td className="px-3 py-2 text-white">{e.description}</td>
                                    <td className="px-3 py-2 text-slate-400">{e.department || '-'}</td>
                                    <td className="px-3 py-2 text-slate-400">{e.cheque_number || '-'}</td>
                                    <td className="px-3 py-2 text-center">
                                        {e.cheque_number ? (
                                            <button onClick={() => canEdit && toggleChequeStatus(e)} className={`px-2 py-0.5 rounded-full text-xs font-medium ${canEdit ? 'cursor-pointer hover:opacity-80' : ''} ${e.cheque_status === 'Cashed' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-amber-500/20 text-amber-400'}`} title={canEdit ? 'Click to toggle Cashed/Uncashed' : ''}>
                                                {e.cheque_status === 'Cashed' ? '‚úì Cashed' : '‚óã Uncashed'}
                                            </button>
                                        ) : <span className="text-slate-600">-</span>}
                                    </td>
                                    <td className="px-3 py-2 text-right text-red-400 font-semibold">{fmtCur(e.amount)}</td>
                                    <td className="px-3 py-2 text-center">
                                        {e.attachment_url ? (
                                            <a href={e.attachment_url} target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:text-blue-300" title="View attachment">üìÑ</a>
                                        ) : '-'}
                                    </td>
                                    <td className="px-3 py-2 text-center">
                                        {canEdit ? (
                                            <>
                                                <button onClick={() => { setEditingItem(e); setView('expense-entry'); }} className="px-2 py-1 rounded bg-slate-700 text-slate-300 text-xs mr-1 hover:bg-blue-600">Edit</button>
                                                <button onClick={() => setShowDeleteConfirm({ type: 'expense', id: e.id })} className="px-2 py-1 rounded bg-slate-700 text-slate-300 text-xs hover:bg-red-600">Del</button>
                                            </>
                                        ) : <span className="text-slate-500 text-xs">View only</span>}
                                    </td>
                                </tr>
                            ))}
                            {filtered.length === 0 && <tr><td colSpan="8" className="px-3 py-8 text-center text-slate-500">No expenses in selected range</td></tr>}
                        </tbody>
                        {filtered.length > 0 && (
                            <tfoot><tr className="bg-slate-700/30 font-semibold">
                                <td colSpan="5" className="px-3 py-2 text-white">Total ({filtered.length} expenses)</td>
                                <td className="px-3 py-2 text-right text-red-400">{fmtCur(total)}</td>
                                <td colSpan="2"></td>
                            </tr></tfoot>
                        )}
                    </table>
                </div>
            </div>
            );
        }

        function TitheForm({ onSubmit, onCancel, initialData, titheEntries, projects }) {
            // Calculate next slip number for a given date
            const getNextSlipForDate = (date) => {
                const entriesForDate = titheEntries.filter(e => e.date === date);
                return entriesForDate.length + 1;
            };
            
            const today = new Date().toISOString().split('T')[0];
            const initialSlip = initialData ? initialData.slip_number : getNextSlipForDate(today);
            
            // Parse existing project_links if it's a string
            const parseProjectLinks = (data) => {
                if (!data) return {};
                if (typeof data === 'string') {
                    try { return JSON.parse(data); } catch { return {}; }
                }
                return data || {};
            };
            
            const [form, setForm] = useState(initialData ? {
                ...initialData,
                project_links: parseProjectLinks(initialData.project_links)
            } : { 
                date: today, slip_number: initialSlip, name: '', tithe: '', special_offering: '', ingathering: '', radio: '', nehemiah: '', budget_covenant: '', sabbath_school: '', welfare: '', pos_band: '', school: '', project: '', books: '', raffa_house: '', tv: '', government_fund: '', messages_of_hope: '', project_links: {} 
            });
            const [saving, setSaving] = useState(false);
            const [showNameSuggestions, setShowNameSuggestions] = useState(false);
            
            // Get unique names for autocomplete
            const uniqueNames = [...new Set(titheEntries.map(e => e.name))].sort();
            const filteredNames = uniqueNames.filter(name => 
                name.toLowerCase().includes((form.name || '').toLowerCase()) && name.toLowerCase() !== (form.name || '').toLowerCase()
            );
            
            // Update slip number when date changes (only for new entries)
            const handleDateChange = (newDate) => {
                if (!initialData) {
                    const nextSlip = getNextSlipForDate(newDate);
                    setForm(p => ({ ...p, date: newDate, slip_number: nextSlip }));
                } else {
                    setForm(p => ({ ...p, date: newDate }));
                }
            };
            
            const handleNameChange = (value) => {
                setForm(p => ({ ...p, name: value }));
                setShowNameSuggestions(value.length > 0);
            };
            
            const selectName = (name) => {
                setForm(p => ({ ...p, name: name }));
                setShowNameSuggestions(false);
            };
            
            const handleChange = (k, v) => setForm(p => ({ ...p, [k]: v }));
            
            // Handle project link changes
            const handleProjectLink = (fieldKey, projectId) => {
                setForm(p => ({
                    ...p,
                    project_links: {
                        ...p.project_links,
                        [fieldKey]: projectId || undefined
                    }
                }));
            };
            
            const confTotal = CONFERENCE_FIELDS.reduce((s, f) => s + (parseFloat(form[f.key]) || 0), 0);
            const churchTotal = CHURCH_FIELDS.reduce((s, f) => s + (parseFloat(form[f.key]) || 0), 0);
            const totalReceived = confTotal + churchTotal;
            
            const handleSubmit = async (e) => { 
                e.preventDefault(); 
                setSaving(true);
                // Clean up project_links - remove empty values and stringify
                const cleanedLinks = Object.fromEntries(
                    Object.entries(form.project_links || {}).filter(([k, v]) => v)
                );
                await onSubmit({ 
                    ...form, 
                    total_received: totalReceived, 
                    total_conf_fund: confTotal, 
                    total_church_fund: churchTotal,
                    project_links: Object.keys(cleanedLinks).length > 0 ? JSON.stringify(cleanedLinks) : null
                }); 
                setSaving(false);
            };
            const inputCls = "w-full px-2 py-2 bg-slate-900/50 border border-slate-600 rounded-lg text-white text-sm";
            const activeProjects = (projects || []).filter(p => p.status === 'Active');

            return (
                <div className="max-w-4xl mx-auto bg-slate-800/50 rounded-xl border border-slate-700">
                    <div className="p-4 border-b border-slate-700 bg-amber-500/10">
                        <h2 className="text-lg font-bold text-white">{initialData ? 'Edit' : 'New'} Tithe Entry</h2>
                    </div>
                    <form onSubmit={handleSubmit} className="p-4 space-y-4">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            <div><label className="text-xs text-slate-400">Date</label><input type="date" value={form.date} onChange={e => handleDateChange(e.target.value)} className={inputCls} required /></div>
                            <div><label className="text-xs text-slate-400">Slip #</label><input type="number" value={form.slip_number} onChange={e => handleChange('slip_number', e.target.value)} className={inputCls} /></div>
                            <div className="col-span-2 relative">
                                <label className="text-xs text-slate-400">Name</label>
                                <input 
                                    type="text" 
                                    value={form.name} 
                                    onChange={e => handleNameChange(e.target.value)} 
                                    onFocus={() => setShowNameSuggestions(form.name.length > 0)}
                                    onBlur={() => setTimeout(() => setShowNameSuggestions(false), 200)}
                                    className={inputCls} 
                                    required 
                                    autoComplete="off"
                                />
                                {showNameSuggestions && filteredNames.length > 0 && (
                                    <div className="absolute z-10 w-full mt-1 bg-slate-800 border border-slate-600 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                                        {filteredNames.slice(0, 10).map(name => (
                                            <div 
                                                key={name} 
                                                className="px-3 py-2 hover:bg-slate-700 cursor-pointer text-white text-sm"
                                                onMouseDown={() => selectName(name)}
                                            >
                                                {name}
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        </div>
                        <div className="border-t border-slate-700 pt-3">
                            <h3 className="text-sm font-semibold text-emerald-400 mb-2">Conference Funds</h3>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                                {CONFERENCE_FIELDS.map(f => (
                                    <div key={f.key}><label className="text-xs text-slate-400">{f.label}</label><input type="number" step="0.01" value={form[f.key]} onChange={e => handleChange(f.key, e.target.value)} placeholder="0.00" className={inputCls} /></div>
                                ))}
                            </div>
                            <div className="mt-2 p-2 bg-emerald-500/10 rounded-lg flex justify-between text-sm"><span className="text-emerald-400">Subtotal</span><span className="text-white font-bold">{fmtCur(confTotal)}</span></div>
                        </div>
                        <div className="border-t border-slate-700 pt-3">
                            <h3 className="text-sm font-semibold text-blue-400 mb-2">Church Funds</h3>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-2">
                                {CHURCH_FIELDS.map(f => (
                                    <div key={f.key}>
                                        <label className="text-xs text-slate-400">{f.label}</label>
                                        <input type="number" step="0.01" value={form[f.key]} onChange={e => handleChange(f.key, e.target.value)} placeholder="0.00" className={inputCls} />
                                        {/* Show project link dropdown if amount > 0 and projects exist */}
                                        {parseFloat(form[f.key]) > 0 && activeProjects.length > 0 && (
                                            <select 
                                                value={(form.project_links || {})[f.key] || ''} 
                                                onChange={e => handleProjectLink(f.key, e.target.value)} 
                                                className="w-full mt-1 px-2 py-1 border border-purple-500/50 rounded text-xs"
                                            >
                                                <option value="">-- Link to project --</option>
                                                {activeProjects.map(p => (
                                                    <option key={p.id} value={p.id}>{p.name}</option>
                                                ))}
                                            </select>
                                        )}
                                    </div>
                                ))}
                            </div>
                            {/* Summary of linked projects */}
                            {Object.keys(form.project_links || {}).filter(k => form.project_links[k]).length > 0 && (
                                <div className="mt-3 p-2 bg-purple-500/10 rounded-lg border border-purple-500/30">
                                    <p className="text-xs text-purple-400 font-medium mb-1">Linked to Projects:</p>
                                    <div className="space-y-1">
                                        {Object.entries(form.project_links || {}).filter(([k, v]) => v).map(([fieldKey, projectId]) => {
                                            const field = CHURCH_FIELDS.find(f => f.key === fieldKey);
                                            const project = activeProjects.find(p => p.id === projectId);
                                            const amount = parseFloat(form[fieldKey]) || 0;
                                            return field && project ? (
                                                <div key={fieldKey} className="flex justify-between text-xs">
                                                    <span className="text-slate-400">{field.label} ‚Üí <span className="text-purple-300">{project.name}</span></span>
                                                    <span className="text-purple-400">{fmtCur(amount)}</span>
                                                </div>
                                            ) : null;
                                        })}
                                    </div>
                                </div>
                            )}
                            <div className="mt-2 p-2 bg-blue-500/10 rounded-lg flex justify-between text-sm"><span className="text-blue-400">Subtotal</span><span className="text-white font-bold">{fmtCur(churchTotal)}</span></div>
                        </div>
                        <div className="p-3 bg-amber-500/20 rounded-lg flex justify-between items-center border border-amber-500/30">
                            <span className="text-slate-300">Total</span><span className="text-2xl font-bold text-amber-400">{fmtCur(totalReceived)}</span>
                        </div>
                        <div className="flex gap-2 justify-end">
                            <button type="button" onClick={onCancel} className="px-4 py-2 rounded-lg bg-slate-700 text-slate-300 text-sm">Cancel</button>
                            <button type="submit" disabled={saving} className="px-4 py-2 rounded-lg bg-amber-500 text-slate-900 font-semibold text-sm disabled:opacity-50">{saving ? 'Saving...' : 'Save'}</button>
                        </div>
                    </form>
                </div>
            );
        }

        // Expense Form Component
        function ExpenseForm({ onSubmit, onCancel, initialData, nextVoucher, supabase, projects }) {
            const [form, setForm] = useState(initialData || { date: new Date().toISOString().split('T')[0], description: '', category: '', department: '', cheque_number: '', cheque_status: 'Uncashed', voucher_number: nextVoucher, amount: '', attachment_url: '', project_id: '' });
            const [saving, setSaving] = useState(false);
            const [uploading, setUploading] = useState(false);
            const [fileName, setFileName] = useState(initialData?.attachment_url ? 'Attachment exists' : '');
            const handleChange = (k, v) => setForm(p => ({ ...p, [k]: v }));
            const activeProjects = (projects || []).filter(p => p.status === 'Active');
            
            const handleFileUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Check file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size must be less than 5MB');
                    return;
                }
                
                setUploading(true);
                setFileName(file.name);
                
                try {
                    // Create unique filename
                    const fileExt = file.name.split('.').pop();
                    const uniqueName = `${Date.now()}_${Math.random().toString(36).substr(2, 9)}.${fileExt}`;
                    
                    // Upload to Supabase Storage
                    const { data, error } = await supabase.storage
                        .from('expenses-attachments')
                        .upload(uniqueName, file);
                    
                    if (error) {
                        console.error('Upload error:', error);
                        alert('Upload failed: ' + error.message);
                        setFileName('');
                        setUploading(false);
                        return;
                    }
                    
                    // Get public URL
                    const { data: urlData } = supabase.storage
                        .from('expenses-attachments')
                        .getPublicUrl(uniqueName);
                    
                    handleChange('attachment_url', urlData.publicUrl);
                    setFileName(file.name + ' ‚úì');
                } catch (err) {
                    console.error('Upload error:', err);
                    alert('Upload failed: ' + err.message);
                    setFileName('');
                }
                setUploading(false);
            };
            
            const handleSubmit = async (e) => { e.preventDefault(); setSaving(true); await onSubmit(form); setSaving(false); };
            const inputCls = "w-full px-3 py-2 bg-slate-900/50 border border-slate-600 rounded-lg text-white text-sm";

            return (
                <div className="max-w-2xl mx-auto bg-slate-800/50 rounded-xl border border-slate-700">
                    <div className="p-4 border-b border-slate-700 bg-red-500/10">
                        <h2 className="text-lg font-bold text-white">{initialData ? 'Edit' : 'New'} Expense</h2>
                    </div>
                    <form onSubmit={handleSubmit} className="p-4 space-y-4">
                        <div className="grid grid-cols-2 gap-3">
                            <div><label className="text-xs text-slate-400">Date</label><input type="date" value={form.date} onChange={e => handleChange('date', e.target.value)} className={inputCls} required /></div>
                            <div><label className="text-xs text-slate-400">Voucher #</label><input type="number" value={form.voucher_number} onChange={e => handleChange('voucher_number', e.target.value)} className={inputCls} /></div>
                        </div>
                        <div><label className="text-xs text-slate-400">Category</label>
                            <select value={form.category} onChange={e => { 
                                handleChange('category', e.target.value); 
                                handleChange('description', e.target.value);
                                // Auto-link to project if project category selected
                                const selectedProject = activeProjects.find(p => p.name === e.target.value);
                                if (selectedProject) {
                                    handleChange('project_id', selectedProject.id);
                                }
                            }} className={inputCls}>
                                <option value="">Select...</option>
                                {EXPENSE_CATEGORIES.map(c => <option key={c} value={c}>{c}</option>)}
                                {activeProjects.length > 0 && (
                                    <>
                                        <option disabled>‚îÄ‚îÄ‚îÄ‚îÄ Projects ‚îÄ‚îÄ‚îÄ‚îÄ</option>
                                        {activeProjects.map(p => <option key={`proj-${p.id}`} value={p.name}>{p.name}</option>)}
                                    </>
                                )}
                            </select>
                        </div>
                        <div><label className="text-xs text-slate-400">Description</label><input type="text" value={form.description} onChange={e => handleChange('description', e.target.value)} className={inputCls} required /></div>
                        <div className="grid grid-cols-2 gap-3">
                            <div><label className="text-xs text-slate-400">Department</label>
                                <select value={form.department} onChange={e => handleChange('department', e.target.value)} className={inputCls}>
                                    {DEPARTMENTS.map(d => <option key={d} value={d}>{d || '- None -'}</option>)}
                                </select>
                            </div>
                            <div><label className="text-xs text-slate-400">Cheque #</label><input type="text" value={form.cheque_number} onChange={e => handleChange('cheque_number', e.target.value)} className={inputCls} /></div>
                        </div>
                        {form.cheque_number && (
                            <div><label className="text-xs text-slate-400">Cheque Status</label>
                                <select value={form.cheque_status || 'Uncashed'} onChange={e => handleChange('cheque_status', e.target.value)} className={inputCls}>
                                    <option value="Uncashed">Uncashed</option>
                                    <option value="Cashed">Cashed</option>
                                </select>
                            </div>
                        )}
                        <div><label className="text-xs text-slate-400">Amount</label><input type="number" step="0.01" value={form.amount} onChange={e => handleChange('amount', e.target.value)} className={inputCls} required /></div>
                        
                        {/* Project Selection */}
                        {activeProjects.length > 0 && (
                            <div className="p-3 bg-purple-500/10 rounded-lg border border-purple-500/30">
                                <label className="text-xs text-purple-400 block mb-1">Link to Project (Optional)</label>
                                <select value={form.project_id || ''} onChange={e => handleChange('project_id', e.target.value)} className={inputCls}>
                                    <option value="">-- No Project --</option>
                                    {activeProjects.map(p => (
                                        <option key={p.id} value={p.id}>{p.name}</option>
                                    ))}
                                </select>
                            </div>
                        )}
                        
                        {/* File Upload */}
                        <div>
                            <label className="text-xs text-slate-400 block mb-1">Attachment (Receipt/Invoice/Document)</label>
                            <div className="flex items-center gap-2">
                                <label className={`flex-1 flex items-center justify-center gap-2 px-4 py-3 border-2 border-dashed border-slate-600 rounded-lg cursor-pointer hover:border-amber-500 hover:bg-slate-700/30 transition-colors ${uploading ? 'opacity-50' : ''}`}>
                                    <span className="text-xl">{uploading ? '‚è≥' : 'üìé'}</span>
                                    <span className="text-sm text-slate-400">
                                        {uploading ? 'Uploading...' : fileName || 'Click to upload image, PDF, or document'}
                                    </span>
                                    <input type="file" accept="image/*,.pdf,.doc,.docx,.xls,.xlsx" onChange={handleFileUpload} className="hidden" disabled={uploading} />
                                </label>
                                {form.attachment_url && (
                                    <a href={form.attachment_url} target="_blank" rel="noopener noreferrer" className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-500">View</a>
                                )}
                            </div>
                            {form.attachment_url && <p className="text-xs text-emerald-400 mt-1">‚úì File attached</p>}
                        </div>
                        
                        <div className="flex gap-2 justify-end">
                            <button type="button" onClick={onCancel} className="px-4 py-2 rounded-lg bg-slate-700 text-slate-300 text-sm">Cancel</button>
                            <button type="submit" disabled={saving || uploading} className="px-4 py-2 rounded-lg bg-red-500 text-white font-semibold text-sm disabled:opacity-50">{saving ? 'Saving...' : 'Save'}</button>
                        </div>
                    </form>
                </div>
            );
        }

        // Deposit Form Component
        function DepositForm({ onSubmit, onCancel, initialData }) {
            const [form, setForm] = useState(initialData || { date: new Date().toISOString().split('T')[0], description: 'RBC', cash: '', cheques: '' });
            const [saving, setSaving] = useState(false);
            const handleChange = (k, v) => setForm(p => ({ ...p, [k]: v }));
            const total = (parseFloat(form.cash) || 0) + (parseFloat(form.cheques) || 0);
            const handleSubmit = async (e) => { e.preventDefault(); setSaving(true); await onSubmit({ ...form, total }); setSaving(false); };
            const inputCls = "w-full px-3 py-2 bg-slate-900/50 border border-slate-600 rounded-lg text-white text-sm";

            return (
                <div className="max-w-lg mx-auto bg-slate-800/50 rounded-xl border border-slate-700">
                    <div className="p-4 border-b border-slate-700 bg-blue-500/10">
                        <h2 className="text-lg font-bold text-white">{initialData ? 'Edit' : 'New'} Deposit</h2>
                    </div>
                    <form onSubmit={handleSubmit} className="p-4 space-y-4">
                        <div className="grid grid-cols-2 gap-3">
                            <div><label className="text-xs text-slate-400">Date</label><input type="date" value={form.date} onChange={e => handleChange('date', e.target.value)} className={inputCls} required /></div>
                            <div><label className="text-xs text-slate-400">Bank</label><input type="text" value={form.description} onChange={e => handleChange('description', e.target.value)} className={inputCls} /></div>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <div><label className="text-xs text-slate-400">Cash</label><input type="number" step="0.01" value={form.cash} onChange={e => handleChange('cash', e.target.value)} placeholder="0.00" className={inputCls} /></div>
                            <div><label className="text-xs text-slate-400">Cheques</label><input type="number" step="0.01" value={form.cheques} onChange={e => handleChange('cheques', e.target.value)} placeholder="0.00" className={inputCls} /></div>
                        </div>
                        <div className="p-3 bg-blue-500/20 rounded-lg flex justify-between border border-blue-500/30">
                            <span className="text-slate-300">Total</span><span className="text-xl font-bold text-blue-400">{fmtCur(total)}</span>
                        </div>
                        <div className="flex gap-2 justify-end">
                            <button type="button" onClick={onCancel} className="px-4 py-2 rounded-lg bg-slate-700 text-slate-300 text-sm">Cancel</button>
                            <button type="submit" disabled={saving} className="px-4 py-2 rounded-lg bg-blue-500 text-white font-semibold text-sm disabled:opacity-50">{saving ? 'Saving...' : 'Save'}</button>
                        </div>
                    </form>
                </div>
            );
        }

        // Cheque Record Form
        function ChequeForm({ onSubmit, onCancel, initialData }) {
            const [form, setForm] = useState(initialData || { 
                cheque_number: '', 
                date: new Date().toISOString().split('T')[0], 
                details: '', 
                department: '', 
                amount: '',
                status: 'Uncashed'
            });
            const [saving, setSaving] = useState(false);
            const handleChange = (k, v) => setForm(p => ({ ...p, [k]: v }));
            const handleSubmit = async (e) => { e.preventDefault(); setSaving(true); await onSubmit(form); setSaving(false); };
            const inputCls = "w-full px-3 py-2 bg-slate-900/50 border border-slate-600 rounded-lg text-white text-sm";

            return (
                <div className="max-w-lg mx-auto bg-slate-800/50 rounded-xl border border-slate-700">
                    <div className="p-4 border-b border-slate-700 bg-amber-500/10">
                        <h2 className="text-lg font-bold text-white">{initialData ? 'Edit' : 'New'} Cheque Record</h2>
                    </div>
                    <form onSubmit={handleSubmit} className="p-4 space-y-4">
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="text-xs text-slate-400">Check Number *</label>
                                <input type="text" value={form.cheque_number} onChange={e => handleChange('cheque_number', e.target.value)} placeholder="e.g. 001234" className={inputCls} required />
                            </div>
                            <div>
                                <label className="text-xs text-slate-400">Date *</label>
                                <input type="date" value={form.date} onChange={e => handleChange('date', e.target.value)} className={inputCls} required />
                            </div>
                        </div>
                        <div>
                            <label className="text-xs text-slate-400">Details / Payee *</label>
                            <input type="text" value={form.details} onChange={e => handleChange('details', e.target.value)} placeholder="Who is the cheque made out to?" className={inputCls} required />
                        </div>
                        <div className="grid grid-cols-3 gap-3">
                            <div>
                                <label className="text-xs text-slate-400">Department</label>
                                <select value={form.department} onChange={e => handleChange('department', e.target.value)} className={inputCls}>
                                    <option value="">Select Department</option>
                                    {EXPENSE_CATEGORIES.map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs text-slate-400">Amount *</label>
                                <input type="number" step="0.01" value={form.amount} onChange={e => handleChange('amount', e.target.value)} placeholder="0.00" className={inputCls} required />
                            </div>
                            <div>
                                <label className="text-xs text-slate-400">Status *</label>
                                <select value={form.status || 'Uncashed'} onChange={e => handleChange('status', e.target.value)} className={inputCls}>
                                    <option value="Uncashed">Uncashed</option>
                                    <option value="Cashed">Cashed</option>
                                </select>
                            </div>
                        </div>
                        <div className="p-3 bg-red-500/20 rounded-lg flex justify-between border border-red-500/30">
                            <span className="text-slate-300">Cheque Amount</span>
                            <span className="text-xl font-bold text-red-400">{fmtCur(parseFloat(form.amount) || 0)}</span>
                        </div>
                        <div className="flex gap-2 justify-end">
                            <button type="button" onClick={onCancel} className="px-4 py-2 rounded-lg bg-slate-700 text-slate-300 text-sm">Cancel</button>
                            <button type="submit" disabled={saving} className="px-4 py-2 rounded-lg bg-amber-500 text-slate-900 font-semibold text-sm disabled:opacity-50">{saving ? 'Saving...' : 'Save Cheque'}</button>
                        </div>
                    </form>
                </div>
            );
        }

        // Financial Statement Component
        function FinancialStatement({ titheEntries, expenses, deposits, settings, saveSettings, projects }) {
            const { supabase } = useContext(AuthContext);
            const [month, setMonth] = useState(new Date().toISOString().slice(0, 7));
            const [prevBalance, setPrevBalance] = useState(settings.previous_balance || 0);
            const [unitTrust, setUnitTrust] = useState(settings.unit_trust || 79082.04);
            const [revolvingFund, setRevolvingFund] = useState(settings.revolving_fund || 597996.24);

            const monthStart = month + '-01';
            const monthEnd = month + '-31';
            const monthEntries = titheEntries.filter(e => e.date >= monthStart && e.date <= monthEnd);
            const monthExpenses = expenses.filter(e => e.date >= monthStart && e.date <= monthEnd);
            
            // Derive deposits from tithe entries (grouped by date)
            const monthDepositMap = {};
            monthEntries.forEach(e => {
                if (!monthDepositMap[e.date]) monthDepositMap[e.date] = 0;
                monthDepositMap[e.date] += parseFloat(e.total_received) || 0;
            });
            const monthDeposits = Object.entries(monthDepositMap).map(([date, total]) => ({ date, description: 'Tithe Collection', total })).sort((a, b) => a.date.localeCompare(b.date));
            
            // Previous months (year to date up to but not including current month)
            const yearStart = month.slice(0, 4) + '-01-01';
            const prevMonthEnd = new Date(month + '-01');
            prevMonthEnd.setDate(0); // Last day of previous month
            const prevMonthEndStr = prevMonthEnd.toISOString().slice(0, 10);
            const prevMonthEntries = titheEntries.filter(e => e.date >= yearStart && e.date <= prevMonthEndStr);
            const prevMonthExpenses = expenses.filter(e => e.date >= yearStart && e.date <= prevMonthEndStr);

            const thisMonthTotals = calculateTitheTotals(monthEntries, monthExpenses);
            const prevMonthTotals = calculateTitheTotals(prevMonthEntries, prevMonthExpenses);
            const allTimeTotals = calculateTitheTotals(titheEntries, expenses);

            const thisMonthExpenseTotal = monthExpenses.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
            const prevMonthExpenseTotal = prevMonthExpenses.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
            const allTimeExpenseTotal = expenses.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
            const depositTotal = monthDeposits.reduce((s, d) => s + (parseFloat(d.total) || 0), 0);

            const confFundPayment = thisMonthTotals.grandTotalConference;
            const endBalance = parseFloat(prevBalance) + depositTotal - confFundPayment - thisMonthExpenseTotal;
            const increaseDecrease = thisMonthTotals.churchOperating - thisMonthExpenseTotal;

            // Parse month properly to avoid timezone issues
            const [selectedYear, selectedMonth] = month.split('-').map(Number);
            const monthName = new Date(selectedYear, selectedMonth - 1, 15).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const lastDayOfMonth = new Date(selectedYear, selectedMonth, 0).getDate();
            const monthEndDate = `${new Date(selectedYear, selectedMonth - 1, 15).toLocaleDateString('en-US', { month: 'long' })} ${lastDayOfMonth}${lastDayOfMonth === 1 ? 'st' : lastDayOfMonth === 2 ? 'nd' : lastDayOfMonth === 3 ? 'rd' : 'th'} ${selectedYear}`;

            const handleSaveBalance = async () => {
                const newSettings = { 
                    ...settings, 
                    previous_balance: parseFloat(prevBalance) || 0,
                    unit_trust: parseFloat(unitTrust) || 0,
                    revolving_fund: parseFloat(revolvingFund) || 0
                };
                await supabase.from('settings').update(newSettings).eq('id', 1);
                saveSettings(newSettings);
            };

            // Get project financials for distribution of funds
            const getProjectBalance = (projectName) => {
                const project = projects.find(p => p.name.toLowerCase().includes(projectName.toLowerCase()));
                if (!project) return 0;
                const openingBalance = parseFloat(project.opening_balance) || 0;
                let income = 0;
                titheEntries.forEach(t => {
                    if (t.project_id === project.id) {
                        income += (parseFloat(t.project) || 0) + (parseFloat(t.government_fund) || 0);
                    }
                    if (t.project_links) {
                        try {
                            const links = typeof t.project_links === 'string' ? JSON.parse(t.project_links) : t.project_links;
                            Object.entries(links).forEach(([fieldKey, linkedProjectId]) => {
                                if (linkedProjectId === project.id) {
                                    income += parseFloat(t[fieldKey]) || 0;
                                }
                            });
                        } catch (e) { }
                    }
                });
                const spent = expenses.filter(e => e.project_id === project.id).reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                return openingBalance + income - spent;
            };

            // Export Financial Statement in exact format
            const exportFinancialStatement = () => {
                // Calculate totals for this month and previous months
                const tmTotals = thisMonthTotals;
                const pmTotals = prevMonthTotals;
                
                // Total to date = this month + previous months
                const ttdTithe = (tmTotals.tithe || 0) + (pmTotals.tithe || 0);
                const ttdSabbathSchool = (tmTotals.sabbath_school || 0) + (pmTotals.sabbath_school || 0);
                const ttdIngathering = (tmTotals.ingathering || 0) + (pmTotals.ingathering || 0);
                const ttdNehemiah = (tmTotals.nehemiah || 0) + (pmTotals.nehemiah || 0);
                const ttdCommunityHospital = 0; // Add if you have this field
                const ttd3ABN = (tmTotals.radio_3abn || 0) + (pmTotals.radio_3abn || 0);
                const tmSubTotalConf = (tmTotals.tithe || 0) + (tmTotals.sabbath_school || 0) + (tmTotals.ingathering || 0) + (tmTotals.nehemiah || 0) + (tmTotals.radio_3abn || 0);
                const pmSubTotalConf = (pmTotals.tithe || 0) + (pmTotals.sabbath_school || 0) + (pmTotals.ingathering || 0) + (pmTotals.nehemiah || 0) + (pmTotals.radio_3abn || 0);
                const ttdSubTotalConf = tmSubTotalConf + pmSubTotalConf;
                
                // 40% calculation
                const tm40Percent = tmTotals.percentage40 || 0;
                const pm40Percent = pmTotals.percentage40 || 0;
                const ttd40Percent = tm40Percent + pm40Percent;
                
                const tmTotalConf = tmSubTotalConf + tm40Percent;
                const pmTotalConf = pmSubTotalConf + pm40Percent;
                const ttdTotalConf = ttdSubTotalConf + ttd40Percent;
                
                // Church Funds
                const tmBudgetCovenant = tmTotals.budget_covenant || 0;
                const pmBudgetCovenant = pmTotals.budget_covenant || 0;
                const ttdBudgetCovenant = tmBudgetCovenant + pmBudgetCovenant;
                
                const tmChildrensHome = tmTotals.pos_band || 0;
                const pmChildrensHome = pmTotals.pos_band || 0;
                const ttdChildrensHome = tmChildrensHome + pmChildrensHome;
                
                const tmSchool = tmTotals.school || 0;
                const pmSchool = pmTotals.school || 0;
                const ttdSchool = tmSchool + pmSchool;
                
                const tmBudgetCovenantAfterEdu = tmBudgetCovenant - tmChildrensHome - tmSchool;
                const pmBudgetCovenantAfterEdu = pmBudgetCovenant - pmChildrensHome - pmSchool;
                const ttdBudgetCovenantAfterEdu = ttdBudgetCovenant - ttdChildrensHome - ttdSchool;
                
                // Church Operating Income (60%)
                const tmChurchOperating = tmTotals.churchOperating || 0;
                const pmChurchOperating = pmTotals.churchOperating || 0;
                const ttdChurchOperating = tmChurchOperating + pmChurchOperating;
                
                // Get expense by category
                const getExpenseByCategory = (category, expenseList) => {
                    return expenseList.filter(e => 
                        (e.category && e.category.toLowerCase().includes(category.toLowerCase())) || 
                        (e.department && e.department.toLowerCase().includes(category.toLowerCase())) ||
                        (e.description && e.description.toLowerCase().includes(category.toLowerCase()))
                    ).reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
                };
                
                // Distribution of Funds calculations - use actual project data
                // Get all project balances (same as Fund Distribution Report)
                const allProjects = projects || [];
                const projectFunds = allProjects.map(p => {
                    const openingBalance = parseFloat(p.opening_balance) || 0;
                    let income = 0;
                    titheEntries.forEach(t => {
                        if (t.project_id === p.id) {
                            income += (parseFloat(t.project) || 0) + (parseFloat(t.government_fund) || 0);
                        }
                        if (t.project_links) {
                            try {
                                const links = typeof t.project_links === 'string' ? JSON.parse(t.project_links) : t.project_links;
                                Object.entries(links).forEach(([fieldKey, linkedProjectId]) => {
                                    if (linkedProjectId === p.id) {
                                        income += parseFloat(t[fieldKey]) || 0;
                                    }
                                });
                            } catch (e) { }
                        }
                    });
                    const spent = expenses.filter(e => e.project_id === p.id).reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                    return {
                        name: p.name,
                        balance: openingBalance + income - spent
                    };
                });
                const totalProjectFunds = projectFunds.reduce((s, p) => s + p.balance, 0);
                
                // Church Operating Income (60%)
                const churchOperatingIncome = allTimeTotals.churchOperating || 0;
                
                // Conference Funds to remit
                const conferenceFunds = allTimeTotals.grandTotalConference || 0;
                
                // Chequing account balance
                const totalDeposits = titheEntries.reduce((s, e) => s + (parseFloat(e.total_received) || 0), 0);
                const totalExpensesAll = expenses.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
                const chequingBalance = totalDeposits - totalExpensesAll;
                
                // Total Allocated Funds
                const totalAllocatedFunds = totalProjectFunds + churchOperatingIncome + conferenceFunds;
                
                // Church Reserve = Represented By Total - All other funds (balancing figure)
                const representedByTotal = parseFloat(unitTrust) + chequingBalance + parseFloat(revolvingFund);
                const churchReserve = representedByTotal - totalAllocatedFunds;
                
                // Build spreadsheet data
                const data = [];
                
                // Row 1: Header
                data.push([`DIEGO MARTIN SDA                                            FINANCIAL STATEMENT FOR ${monthName.toUpperCase()}`]);
                
                // Row 2: Conference Funds Header
                data.push(['CONFERENCE  FUNDS', 'THIS MONTH', 'PREVIOUS MONTHS', 'TOTAL TO DATE']);
                
                // Rows 3-8: Conference Fund Items
                data.push(['Tithes', tmTotals.tithe || 0, pmTotals.tithe || 0, ttdTithe]);
                data.push(['Sabbath School', tmTotals.sabbath_school || 0, pmTotals.sabbath_school || 0, ttdSabbathSchool]);
                data.push(['Ingathering', tmTotals.ingathering || 0, pmTotals.ingathering || 0, ttdIngathering]);
                data.push(['Nehemiah', tmTotals.nehemiah || 0, pmTotals.nehemiah || 0, ttdNehemiah]);
                data.push(['Community Hospital', 0, 0, 0]);
                data.push(['3ABN/Radio', tmTotals.radio_3abn || 0, pmTotals.radio_3abn || 0, ttd3ABN]);
                
                // Row 9: Sub Total
                data.push(['Sub Total of Conference Funds', tmSubTotalConf, pmSubTotalConf, ttdSubTotalConf]);
                
                // Row 10: Empty
                data.push([]);
                
                // Row 11-16: Church Contributions to Conference (40% calculation breakdown)
                data.push(['Church Contributions to Conference']);
                data.push(['Budget Covenant/Offerings', tmBudgetCovenant, pmBudgetCovenant, ttdBudgetCovenant]);
                data.push(["less: Children's HOME", -tmChildrensHome, -pmChildrensHome, -ttdChildrensHome]);
                data.push(['less: Contribution to School (Wesport)', -tmSchool, -pmSchool, -ttdSchool]);
                data.push(['Budget Covenant after contribution', tmBudgetCovenantAfterEdu, pmBudgetCovenantAfterEdu, ttdBudgetCovenantAfterEdu]);
                data.push(['40% of Total Church Offering to local Conference', tm40Percent, pm40Percent, ttd40Percent]);
                
                // Row 17: Total Conference Funds
                data.push(['Total Conference Funds', tmTotalConf, pmTotalConf, ttdTotalConf]);
                
                // Row: Empty
                data.push([]);
                
                // Church Funds Header
                data.push(['CHURCH FUNDS']);
                
                // Church Fund Items (Budget Covenant breakdown already shown above in Conference section)
                data.push(['Budget Covenant/Offerings', tmBudgetCovenant, pmBudgetCovenant, ttdBudgetCovenant]);
                data.push(["less: Children's HOME", -tmChildrensHome, -pmChildrensHome, -ttdChildrensHome]);
                data.push(['less: Contribution to School (Wesport)', -tmSchool, -pmSchool, -ttdSchool]);
                data.push(['Budget Covenant after Education contribution', tmBudgetCovenantAfterEdu, pmBudgetCovenantAfterEdu, ttdBudgetCovenantAfterEdu]);
                data.push(['Welfare', tmTotals.welfare || 0, pmTotals.welfare || 0, (tmTotals.welfare || 0) + (pmTotals.welfare || 0)]);
                data.push(['Church Building Fund', tmTotals.church_building || 0, pmTotals.church_building || 0, (tmTotals.church_building || 0) + (pmTotals.church_building || 0)]);
                data.push(['Contribution to School', tmTotals.school || 0, pmTotals.school || 0, ttdSchool]);
                data.push(["Children's Home", tmChildrensHome, pmChildrensHome, ttdChildrensHome]);
                data.push(['Choir', tmTotals.choir || 0, pmTotals.choir || 0, (tmTotals.choir || 0) + (pmTotals.choir || 0)]);
                data.push(['Special Project', tmTotals.special_project || 0, pmTotals.special_project || 0, (tmTotals.special_project || 0) + (pmTotals.special_project || 0)]);
                data.push(['Church Project', tmTotals.project || 0, pmTotals.project || 0, (tmTotals.project || 0) + (pmTotals.project || 0)]);
                data.push(['Messages of Hope Radio', tmTotals.messages_of_hope || 0, pmTotals.messages_of_hope || 0, (tmTotals.messages_of_hope || 0) + (pmTotals.messages_of_hope || 0)]);
                data.push(['Funeral Fund', tmTotals.funeral || 0, pmTotals.funeral || 0, (tmTotals.funeral || 0) + (pmTotals.funeral || 0)]);
                data.push(['Ministry Fund', 0, 0, 0]);
                data.push(['Camp', tmTotals.camp || 0, pmTotals.camp || 0, (tmTotals.camp || 0) + (pmTotals.camp || 0)]);
                data.push(['Refunds', tmTotals.refunds || 0, pmTotals.refunds || 0, (tmTotals.refunds || 0) + (pmTotals.refunds || 0)]);
                
                // Row 33: Total Church Income
                const tmTotalChurchIncome = tmTotals.totalChurchFund || 0;
                const pmTotalChurchIncome = pmTotals.totalChurchFund || 0;
                const ttdTotalChurchIncome = tmTotalChurchIncome + pmTotalChurchIncome;
                data.push(['TOTAL CHURCH INCOME', tmTotalChurchIncome, pmTotalChurchIncome, ttdTotalChurchIncome]);
                
                // Row 34: Less 40%
                data.push(['Less 40% to Local Conference', -tm40Percent, -pm40Percent, -ttd40Percent]);
                
                // Row 35: Total Church Operating Income
                data.push(['TOTAL CHURCH OPERATING INCOME', tmChurchOperating, pmChurchOperating, ttdChurchOperating]);
                
                // Row 36: Empty
                data.push([]);
                
                // Row 37: Expenditure Header
                data.push(['EXPENDITURE', 'THIS MONTH', 'PREVIOUS MONTHS', 'TOTAL TO DATE']);
                
                // List all departments with summed totals for this month
                EXPENSE_CATEGORIES.forEach(dept => {
                    if (!dept) return; // skip empty
                    const tmExp = monthExpenses.filter(e => e.department === dept).reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
                    const pmExp = prevMonthExpenses.filter(e => e.department === dept).reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
                    data.push([dept, tmExp, pmExp, tmExp + pmExp]);
                });
                
                // Total Expenses
                data.push(['TOTAL CHURCH  EXPENSES', thisMonthExpenseTotal, prevMonthExpenseTotal, thisMonthExpenseTotal + prevMonthExpenseTotal]);
                
                // Empty row
                data.push([]);
                
                // Reconciliation
                data.push(['Reconciliation  ']);
                data.push(['Balance From Previous Month', parseFloat(prevBalance)]);
                data.push(['Add: Church Operating Income (60%)', tmChurchOperating]);
                data.push(['Less: Total Church Expenses', -thisMonthExpenseTotal]);
                data.push([`Balance as at: ${monthEndDate}`, parseFloat(prevBalance) + tmChurchOperating - thisMonthExpenseTotal]);
                
                // Empty row
                data.push([]);
                
                // Distribution of Funds section
                data.push(['Distribution of Funds', '', 'Represented by ', '']);
                
                // Add all project funds dynamically
                projectFunds.forEach(p => {
                    data.push([p.name, p.balance, '', '']);
                });
                data.push(['Total Project Funds', totalProjectFunds, '', '']);
                data.push([]);
                data.push(['Church Operating Income (60%)', churchOperatingIncome, 'Unit Trust', parseFloat(unitTrust)]);
                data.push(['Conference Funds (to remit)', conferenceFunds, 'Chequing account', chequingBalance]);
                data.push(['Church Reserve', churchReserve, 'Revolving Fund', parseFloat(revolvingFund)]);
                data.push([]);
                
                const leftTotal = totalProjectFunds + churchOperatingIncome + conferenceFunds + churchReserve;
                const rightTotal = parseFloat(unitTrust) + chequingBalance + parseFloat(revolvingFund);
                data.push(['Totals', leftTotal, '', rightTotal]);
                
                // Empty row
                data.push([]);
                
                // Signature
                data.push(['Treasurer: ', ' Pastor: Ps. Morgavy Gittens']);
                data.push(['Date : ']);
                
                // Create workbook with formatting
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                // Set column widths
                ws['!cols'] = [
                    { wch: 55 },  // Column A
                    { wch: 18 },  // Column B
                    { wch: 20 },  // Column C
                    { wch: 18 }   // Column D
                ];
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Financial Statement');
                XLSX.writeFile(wb, `Financial_Statement_${month}.xlsx`);
            };

            return (
                <div className="space-y-4">
                    {/* Controls */}
                    <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4 no-print">
                        <div className="flex flex-wrap gap-3 items-end justify-between">
                            <div className="flex flex-wrap gap-3 items-end">
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Month</label>
                                    <input type="month" value={month} onChange={e => setMonth(e.target.value)} className="px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm" />
                                </div>
                                <button onClick={exportFinancialStatement} className="px-3 py-2 bg-emerald-600 text-white rounded-lg text-sm">üì• Export Statement</button>
                                <button onClick={() => window.print()} className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm">üñ®Ô∏è Print</button>
                            </div>
                        </div>
                        
                        {/* Distribution of Funds Settings */}
                        <div className="mt-4 pt-4 border-t border-slate-700">
                            <h4 className="text-xs text-slate-400 mb-2">Distribution of Funds Settings (for export)</h4>
                            <div className="flex flex-wrap gap-4 items-end">
                                <div>
                                    <label className="text-xs text-slate-500 block mb-1">Unit Trust Balance</label>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value={unitTrust} 
                                        onChange={e => setUnitTrust(e.target.value)} 
                                        className="px-2 py-1 bg-slate-900 border border-slate-600 rounded text-white text-sm w-32 text-right"
                                    />
                                </div>
                                <div>
                                    <label className="text-xs text-slate-500 block mb-1">Revolving Fund Balance</label>
                                    <input 
                                        type="number" 
                                        step="0.01" 
                                        value={revolvingFund} 
                                        onChange={e => setRevolvingFund(e.target.value)} 
                                        className="px-2 py-1 bg-slate-900 border border-slate-600 rounded text-white text-sm w-32 text-right"
                                    />
                                </div>
                                <button onClick={handleSaveBalance} className="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-500">üíæ Save Settings</button>
                            </div>
                        </div>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div className="bg-emerald-500/10 border border-emerald-500/30 rounded-xl p-4">
                            <p className="text-xs text-slate-400">Conference Funds</p>
                            <p className="text-xl font-bold text-emerald-400">{fmtCur(thisMonthTotals.grandTotalConference)}</p>
                            <p className="text-xs text-slate-500">This Month</p>
                        </div>
                        <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
                            <p className="text-xs text-slate-400">Church Operating</p>
                            <p className="text-xl font-bold text-blue-400">{fmtCur(thisMonthTotals.churchOperating)}</p>
                            <p className="text-xs text-slate-500">This Month</p>
                        </div>
                        <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
                            <p className="text-xs text-slate-400">Expenses</p>
                            <p className="text-xl font-bold text-red-400">{fmtCur(thisMonthExpenseTotal)}</p>
                            <p className="text-xs text-slate-500">This Month</p>
                        </div>
                        <div className="bg-amber-500/10 border border-amber-500/30 rounded-xl p-4">
                            <p className="text-xs text-slate-400">End Balance</p>
                            <p className="text-xl font-bold text-amber-400">{fmtCur(parseFloat(prevBalance) + increaseDecrease)}</p>
                            <p className="text-xs text-slate-500">{monthName}</p>
                        </div>
                    </div>

                    {/* Two Column Layout */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        {/* Left Column - Income & Expenses Summary */}
                        <div className="space-y-4">
                            {/* Conference Funds */}
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                <h3 className="text-sm font-semibold text-emerald-400 mb-2">Conference Funds</h3>
                                <table className="w-full text-sm">
                                    <thead><tr className="border-b border-slate-700"><th className="text-left text-slate-500 py-1">Item</th><th className="text-right text-slate-500">This Month</th><th className="text-right text-slate-500">Total</th></tr></thead>
                                    <tbody>
                                        {CONFERENCE_FIELDS.map(f => (
                                            <tr key={f.key} className="border-b border-slate-700/50">
                                                <td className="text-slate-400 py-1">{f.label}</td>
                                                <td className="text-right text-emerald-400">{fmtCur(thisMonthTotals[f.key])}</td>
                                                <td className="text-right text-slate-400">{fmtCur(allTimeTotals[f.key])}</td>
                                            </tr>
                                        ))}
                                        <tr className="font-bold border-t border-slate-600"><td className="text-slate-300 py-1">Sub Total Conference Funds</td><td className="text-right text-emerald-400">{fmtCur(thisMonthTotals.totalConfFund)}</td><td className="text-right text-slate-300">{fmtCur(allTimeTotals.totalConfFund)}</td></tr>
                                        
                                        {/* 40% Calculation Breakdown */}
                                        <tr className="bg-slate-700/30"><td colSpan="3" className="text-xs text-amber-400 py-2 font-semibold">CHURCH CONTRIBUTIONS TO CONFERENCE (40%)</td></tr>
                                        <tr><td className="text-slate-400 py-1 pl-4">Budget Covenant/Offerings</td><td className="text-right text-slate-300">{fmtCur(thisMonthTotals.budget_covenant)}</td><td className="text-right text-slate-400">{fmtCur(allTimeTotals.budget_covenant)}</td></tr>
                                        <tr><td className="text-red-400 py-1 pl-4">less: Children's HOME</td><td className="text-right text-red-400">-{fmtCur(thisMonthTotals.pos_band)}</td><td className="text-right text-red-300">-{fmtCur(allTimeTotals.pos_band)}</td></tr>
                                        <tr><td className="text-red-400 py-1 pl-4">less: Contribution to School (Wesport)</td><td className="text-right text-red-400">-{fmtCur(thisMonthTotals.school)}</td><td className="text-right text-red-300">-{fmtCur(allTimeTotals.school)}</td></tr>
                                        <tr className="border-t border-slate-600"><td className="text-slate-300 py-1 pl-4 font-medium">Budget Covenant after contribution</td><td className="text-right text-slate-300">{fmtCur(thisMonthTotals.baseFor40_60 || 0)}</td><td className="text-right text-slate-400">{fmtCur(allTimeTotals.baseFor40_60 || 0)}</td></tr>
                                        <tr><td className="text-amber-400 py-1 pl-4">40% of Total Church Offering</td><td className="text-right text-amber-400">{fmtCur(thisMonthTotals.percentage40)}</td><td className="text-right text-amber-300">{fmtCur(allTimeTotals.percentage40)}</td></tr>
                                        
                                        <tr className="font-bold bg-emerald-500/10"><td className="text-emerald-400 py-2">TOTAL CONFERENCE FUNDS</td><td className="text-right text-emerald-400">{fmtCur(thisMonthTotals.grandTotalConference)}</td><td className="text-right text-emerald-300">{fmtCur(allTimeTotals.grandTotalConference)}</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            {/* Church Funds */}
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                <h3 className="text-sm font-semibold text-blue-400 mb-2">Church Funds</h3>
                                <table className="w-full text-sm">
                                    <thead><tr className="border-b border-slate-700"><th className="text-left text-slate-500 py-1">Item</th><th className="text-right text-slate-500">This Month</th><th className="text-right text-slate-500">Total</th></tr></thead>
                                    <tbody>
                                        {CHURCH_FIELDS.map(f => (
                                            <tr key={f.key} className="border-b border-slate-700/50">
                                                <td className="text-slate-400 py-1">{f.label}</td>
                                                <td className="text-right text-blue-400">{fmtCur(thisMonthTotals[f.key])}</td>
                                                <td className="text-right text-slate-400">{fmtCur(allTimeTotals[f.key])}</td>
                                            </tr>
                                        ))}
                                        <tr className="font-bold border-t border-slate-600"><td className="text-slate-300 py-1">TOTAL CHURCH INCOME</td><td className="text-right text-blue-400">{fmtCur(thisMonthTotals.totalChurchFund)}</td><td className="text-right text-slate-300">{fmtCur(allTimeTotals.totalChurchFund)}</td></tr>
                                        <tr><td className="text-red-400 py-1">Less 40% to Local Conference</td><td className="text-right text-red-400">-{fmtCur(thisMonthTotals.percentage40)}</td><td className="text-right text-red-300">-{fmtCur(allTimeTotals.percentage40)}</td></tr>
                                        <tr className="font-bold bg-blue-500/10"><td className="text-blue-400 py-2">TOTAL CHURCH OPERATING INCOME (60%)</td><td className="text-right text-blue-400">{fmtCur(thisMonthTotals.churchOperating)}</td><td className="text-right text-blue-300">{fmtCur(allTimeTotals.churchOperating)}</td></tr>
                                    </tbody>
                                </table>
                            </div>

                            {/* Reconciliation */}
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                <h3 className="text-sm font-semibold text-amber-400 mb-2">Reconciliation</h3>
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between"><span className="text-slate-400">Church Operating Income</span><span className="text-white">{fmtCur(thisMonthTotals.churchOperating)}</span></div>
                                    <div className="flex justify-between"><span className="text-slate-400">Less: Total Expenses</span><span className="text-red-400">-{fmtCur(thisMonthExpenseTotal)}</span></div>
                                    <div className="flex justify-between border-t border-slate-700 pt-2"><span className="text-slate-300">Increase/Decrease</span><span className={increaseDecrease >= 0 ? 'text-emerald-400' : 'text-red-400'}>{fmtCur(increaseDecrease)}</span></div>
                                    <div className="flex justify-between"><span className="text-slate-400">Previous Balance</span><span className="text-white">{fmtCur(prevBalance)}</span></div>
                                    <div className="flex justify-between bg-amber-500/20 p-2 rounded-lg font-bold"><span className="text-amber-400">Balance as at {monthName}</span><span className="text-amber-400">{fmtCur(parseFloat(prevBalance) + increaseDecrease)}</span></div>
                                </div>
                            </div>
                        </div>

                        {/* Right Column - Monthly Details */}
                        <div className="space-y-4">
                            {/* Monthly Expenses Detail */}
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                <h3 className="text-sm font-semibold text-red-400 mb-2">Monthly Expenses - {monthName}</h3>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-xs">
                                        <thead><tr className="border-b border-slate-700">
                                            <th className="text-left text-slate-500 py-1">Date</th>
                                            <th className="text-left text-slate-500">Description</th>
                                            <th className="text-left text-slate-500">Dept</th>
                                            <th className="text-center text-slate-500">Chq#</th>
                                            <th className="text-right text-slate-500">Amount</th>
                                        </tr></thead>
                                        <tbody>
                                            {monthExpenses.map(e => (
                                                <tr key={e.id} className="border-b border-slate-700/50">
                                                    <td className="text-slate-400 py-1">{e.date}</td>
                                                    <td className="text-white">{e.description}</td>
                                                    <td className="text-slate-400">{e.department || '-'}</td>
                                                    <td className="text-center text-slate-400">{e.cheque_number || '-'}</td>
                                                    <td className="text-right text-red-400">{fmtCur(e.amount)}</td>
                                                </tr>
                                            ))}
                                            {monthExpenses.length === 0 && <tr><td colSpan="5" className="text-center text-slate-500 py-4">No expenses this month</td></tr>}
                                        </tbody>
                                        <tfoot><tr className="font-bold bg-red-500/10"><td colSpan="4" className="text-right text-red-400 py-2">TOTAL</td><td className="text-right text-red-400">{fmtCur(thisMonthExpenseTotal)}</td></tr></tfoot>
                                    </table>
                                </div>
                            </div>

                            {/* Monthly Deposits */}
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                <h3 className="text-sm font-semibold text-blue-400 mb-2">Monthly Deposits - {monthName}</h3>
                                <table className="w-full text-xs">
                                    <thead><tr className="border-b border-slate-700">
                                        <th className="text-left text-slate-500 py-1">Date</th>
                                        <th className="text-left text-slate-500">Description</th>
                                        <th className="text-right text-slate-500">Cash</th>
                                        <th className="text-right text-slate-500">Cheques</th>
                                        <th className="text-right text-slate-500">Total</th>
                                    </tr></thead>
                                    <tbody>
                                        {monthDeposits.map(d => (
                                            <tr key={d.id} className="border-b border-slate-700/50">
                                                <td className="text-slate-400 py-1">{d.date}</td>
                                                <td className="text-white">{d.description}</td>
                                                <td className="text-right text-slate-300">{d.cash ? fmtCur(d.cash) : '-'}</td>
                                                <td className="text-right text-slate-300">{d.cheques ? fmtCur(d.cheques) : '-'}</td>
                                                <td className="text-right text-blue-400">{fmtCur(d.total)}</td>
                                            </tr>
                                        ))}
                                        {monthDeposits.length === 0 && <tr><td colSpan="5" className="text-center text-slate-500 py-4">No deposits this month</td></tr>}
                                    </tbody>
                                    <tfoot><tr className="font-bold bg-blue-500/10"><td colSpan="4" className="text-right text-blue-400 py-2">TOTAL</td><td className="text-right text-blue-400">{fmtCur(depositTotal)}</td></tr></tfoot>
                                </table>
                            </div>

                            {/* Bank Reconciliation */}
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                <h3 className="text-sm font-semibold text-purple-400 mb-2">Chequing Account Reconciliation</h3>
                                <div className="space-y-2 text-sm">
                                    <div className="flex justify-between items-center">
                                        <span className="text-slate-400">Previous Balance</span>
                                        <div className="flex items-center gap-2">
                                            <input 
                                                type="number" 
                                                step="0.01" 
                                                value={prevBalance} 
                                                onChange={e => setPrevBalance(e.target.value)} 
                                                className="px-2 py-1 bg-slate-900 border border-slate-600 rounded text-white text-sm w-28 text-right"
                                            />
                                            <button onClick={handleSaveBalance} className="px-2 py-1 bg-purple-600 text-white rounded text-xs hover:bg-purple-500">Save</button>
                                        </div>
                                    </div>
                                    <div className="flex justify-between"><span className="text-slate-400">+ Total Deposits</span><span className="text-emerald-400">+{fmtCur(depositTotal)}</span></div>
                                    <div className="flex justify-between"><span className="text-slate-400">- Conference Fund Payment</span><span className="text-red-400">-{fmtCur(confFundPayment)}</span></div>
                                    <div className="flex justify-between"><span className="text-slate-400">- Total Expenses</span><span className="text-red-400">-{fmtCur(thisMonthExpenseTotal)}</span></div>
                                    <div className="flex justify-between bg-purple-500/20 p-2 rounded-lg font-bold border-t border-slate-700 mt-2"><span className="text-purple-400">Balance as at {monthName}</span><span className="text-purple-400">{fmtCur(endBalance)}</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        // Budget Section Component
        function BudgetSection({ budgetItems, expenses, supabase, user, onUpdate }) {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            const [selectedYear, setSelectedYear] = useState(currentYear);
            const [editMode, setEditMode] = useState(false);
            const [budgetForm, setBudgetForm] = useState({});
            const [saving, setSaving] = useState(false);
            const [startDate, setStartDate] = useState(new Date(currentYear, 0, 1).toISOString().split('T')[0]);
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [budgetView, setBudgetView] = useState('actual'); // actual, forecast
            const [forecastYear, setForecastYear] = useState(currentYear + 1);
            const [forecastAdjustments, setForecastAdjustments] = useState({});
            const [inflationRate, setInflationRate] = useState(5); // Default 5% inflation

            // Initialize budget form with current values
            useEffect(() => {
                const formData = {};
                EXPENSE_CATEGORIES.forEach(cat => {
                    const existing = budgetItems.find(b => b.year === selectedYear && b.category === cat);
                    formData[cat] = existing ? existing.budgeted_amount : '';
                });
                setBudgetForm(formData);
            }, [budgetItems, selectedYear]);

            // Filter expenses by date range
            const filteredExpenses = expenses.filter(e => e.date >= startDate && e.date <= endDate);

            // Calculate spent per category
            const getSpentByCategory = (category) => {
                return filteredExpenses
                    .filter(e => e.category === category || e.description === category)
                    .reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            };

            // Get budget for category
            const getBudgetForCategory = (category) => {
                const item = budgetItems.find(b => b.year === selectedYear && b.category === category);
                return item ? parseFloat(item.budgeted_amount) || 0 : 0;
            };

            // Calculate totals
            const totalBudget = EXPENSE_CATEGORIES.reduce((sum, cat) => sum + getBudgetForCategory(cat), 0);
            const totalSpent = EXPENSE_CATEGORIES.reduce((sum, cat) => sum + getSpentByCategory(cat), 0);
            const totalRemaining = totalBudget - totalSpent;

            // Save budget
            const handleSaveBudget = async () => {
                setSaving(true);
                try {
                    for (const category of EXPENSE_CATEGORIES) {
                        const amount = parseFloat(budgetForm[category]) || 0;
                        const existing = budgetItems.find(b => b.year === selectedYear && b.category === category);
                        
                        if (existing) {
                            // Update existing record (including to zero)
                            await supabase.from('budget_items').update({ 
                                budgeted_amount: amount,
                                updated_at: new Date().toISOString()
                            }).eq('id', existing.id);
                        } else if (amount > 0) {
                            // Only insert new records if amount > 0
                            await supabase.from('budget_items').insert({
                                year: selectedYear,
                                category: category,
                                budgeted_amount: amount,
                                created_by: user.id,
                                created_by_email: user.email
                            });
                        }
                    }
                    await onUpdate();
                    setEditMode(false);
                } catch (err) {
                    console.error('Save error:', err);
                    alert('Error saving budget: ' + err.message);
                }
                setSaving(false);
            };

            // Export budget report
            const exportBudgetReport = () => {
                try {
                    const headers = ['Department/Category', 'Budget', 'Spent', 'Remaining', '% Used'];
                    const data = EXPENSE_CATEGORIES.map(cat => {
                        const budget = getBudgetForCategory(cat);
                        const spent = getSpentByCategory(cat);
                        const remaining = budget - spent;
                        const pctUsed = budget > 0 ? ((spent / budget) * 100).toFixed(1) + '%' : '-';
                        return [cat, budget, spent, remaining, pctUsed];
                    }).filter(row => row[1] > 0 || row[2] > 0);
                    
                    data.push(['TOTALS', totalBudget, totalSpent, totalRemaining, totalBudget > 0 ? ((totalSpent / totalBudget) * 100).toFixed(1) + '%' : '-']);
                    
                    const ws = XLSX.utils.aoa_to_sheet([
                        [`Budget Report - ${selectedYear}`],
                        [`Date Range: ${startDate} to ${endDate}`],
                        [],
                        headers, 
                        ...data
                    ]);
                    ws['!cols'] = [{wch: 30}, {wch: 15}, {wch: 15}, {wch: 15}, {wch: 10}];
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Budget Report');
                    XLSX.writeFile(wb, `Budget_Report_${selectedYear}.xlsx`);
                } catch (err) {
                    console.error('Export error:', err);
                    alert('Export error: ' + err.message);
                }
            };

            // Calculate forecast data
            const getYearExpenses = (year) => {
                return expenses.filter(e => new Date(e.date).getFullYear() === year);
            };
            
            const getSpentByYearCategory = (year, category) => {
                return getYearExpenses(year)
                    .filter(e => e.category === category || e.description === category)
                    .reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            };
            
            const lastYearExpenses = getYearExpenses(currentYear - 1);
            const thisYearExpenses = getYearExpenses(currentYear);
            
            // Calculate annualized spending (project full year based on YTD)
            const monthsElapsed = currentMonth + 1;
            const annualizationFactor = 12 / monthsElapsed;
            
            const getForecastForCategory = (category) => {
                const thisYearSpent = getSpentByYearCategory(currentYear, category);
                const lastYearSpent = getSpentByYearCategory(currentYear - 1, category);
                const annualized = thisYearSpent * annualizationFactor;
                
                // Calculate growth rate
                const growthRate = lastYearSpent > 0 ? ((annualized - lastYearSpent) / lastYearSpent) : 0;
                
                // Base forecast = annualized + inflation
                const baseForecast = annualized * (1 + inflationRate / 100);
                
                // Apply manual adjustment if any
                const adjustment = parseFloat(forecastAdjustments[category]) || 0;
                
                return {
                    lastYear: lastYearSpent,
                    thisYearYTD: thisYearSpent,
                    annualized,
                    growthRate,
                    baseForecast,
                    adjustment,
                    forecast: baseForecast + adjustment
                };
            };
            
            const saveForecastAsBudget = async () => {
                setSaving(true);
                try {
                    for (const category of EXPENSE_CATEGORIES) {
                        const forecast = getForecastForCategory(category);
                        if (forecast.forecast > 0) {
                            const existing = budgetItems.find(b => b.year === forecastYear && b.category === category);
                            if (existing) {
                                await supabase.from('budget_items').update({ 
                                    budgeted_amount: Math.round(forecast.forecast * 100) / 100,
                                    updated_at: new Date().toISOString()
                                }).eq('id', existing.id);
                            } else {
                                await supabase.from('budget_items').insert({
                                    year: forecastYear,
                                    category: category,
                                    budgeted_amount: Math.round(forecast.forecast * 100) / 100,
                                    created_by: user.id,
                                    created_by_email: user.email
                                });
                            }
                        }
                    }
                    await onUpdate();
                    alert(`Budget for ${forecastYear} has been saved!`);
                } catch (err) {
                    console.error('Save error:', err);
                    alert('Error saving forecast: ' + err.message);
                }
                setSaving(false);
            };
            
            const exportForecastReport = () => {
                try {
                    const headers = ['Department/Category', `${currentYear-1} Actual`, `${currentYear} YTD`, `${currentYear} Annualized`, 'Growth %', `${forecastYear} Forecast`, 'Adjustment', 'Final Forecast'];
                    const data = EXPENSE_CATEGORIES.map(cat => {
                        const f = getForecastForCategory(cat);
                        if (f.lastYear === 0 && f.thisYearYTD === 0 && f.forecast === 0) return null;
                        return [cat, f.lastYear, f.thisYearYTD, f.annualized, (f.growthRate * 100).toFixed(1) + '%', f.baseForecast, f.adjustment, f.forecast];
                    }).filter(Boolean);
                    
                    const totalLastYear = EXPENSE_CATEGORIES.reduce((s, c) => s + getForecastForCategory(c).lastYear, 0);
                    const totalYTD = EXPENSE_CATEGORIES.reduce((s, c) => s + getForecastForCategory(c).thisYearYTD, 0);
                    const totalAnnualized = EXPENSE_CATEGORIES.reduce((s, c) => s + getForecastForCategory(c).annualized, 0);
                    const totalForecast = EXPENSE_CATEGORIES.reduce((s, c) => s + getForecastForCategory(c).forecast, 0);
                    
                    data.push(['TOTALS', totalLastYear, totalYTD, totalAnnualized, '', '', '', totalForecast]);
                    
                    const ws = XLSX.utils.aoa_to_sheet([
                        [`Budget Forecast for ${forecastYear}`],
                        [`Generated: ${new Date().toLocaleDateString()}`],
                        [`Inflation Rate: ${inflationRate}%`],
                        [],
                        headers, 
                        ...data
                    ]);
                    ws['!cols'] = [{wch: 30}, {wch: 15}, {wch: 15}, {wch: 18}, {wch: 12}, {wch: 18}, {wch: 12}, {wch: 18}];
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Budget Forecast');
                    XLSX.writeFile(wb, `Budget_Forecast_${forecastYear}.xlsx`);
                } catch (err) {
                    console.error('Export error:', err);
                    alert('Export error: ' + err.message);
                }
            };

            return (
                <div className="space-y-4">
                    {/* View Tabs */}
                    <div className="flex gap-2">
                        <button 
                            onClick={() => setBudgetView('actual')}
                            className={`px-4 py-2 rounded-lg text-sm font-medium ${budgetView === 'actual' ? 'bg-amber-500 text-slate-900' : 'bg-slate-700/50 text-slate-300 hover:bg-slate-600/50'}`}
                        >
                            üìä Budget vs Actual
                        </button>
                        <button 
                            onClick={() => setBudgetView('forecast')}
                            className={`px-4 py-2 rounded-lg text-sm font-medium ${budgetView === 'forecast' ? 'bg-purple-500 text-white' : 'bg-slate-700/50 text-slate-300 hover:bg-slate-600/50'}`}
                        >
                            üîÆ Forecasted Budget
                        </button>
                    </div>

                    {/* BUDGET VS ACTUAL VIEW */}
                    {budgetView === 'actual' && (
                        <>
                            {/* Controls */}
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                <div className="flex flex-wrap gap-3 items-end justify-between">
                                    <div className="flex flex-wrap gap-3 items-end">
                                        <div>
                                            <label className="text-xs text-slate-400 block mb-1">Budget Year</label>
                                            <select value={selectedYear} onChange={e => setSelectedYear(parseInt(e.target.value))} className="px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm">
                                                {[currentYear - 1, currentYear, currentYear + 1].map(y => (
                                                    <option key={y} value={y}>{y}</option>
                                                ))}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs text-slate-400 block mb-1">Start Date</label>
                                            <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm" />
                                        </div>
                                        <div>
                                            <label className="text-xs text-slate-400 block mb-1">End Date</label>
                                            <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm" />
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button onClick={() => setEditMode(!editMode)} className={`px-4 py-2 rounded-lg text-sm font-medium ${editMode ? 'bg-slate-600 text-white' : 'bg-amber-500 text-slate-900'}`}>
                                            {editMode ? 'Cancel Edit' : '‚úèÔ∏è Edit Budget'}
                                        </button>
                                        <button onClick={exportBudgetReport} className="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm">üì• Export Report</button>
                                    </div>
                                </div>
                            </div>

                            {/* Summary Cards */}
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-3">
                                <div className="p-4 bg-blue-500/10 rounded-xl border border-blue-500/30">
                                    <p className="text-xs text-slate-400">Total Budget</p>
                                    <p className="text-xl font-bold text-blue-400">{fmtCur(totalBudget)}</p>
                                    <p className="text-xs text-slate-500">{selectedYear}</p>
                                </div>
                                <div className="p-4 bg-red-500/10 rounded-xl border border-red-500/30">
                                    <p className="text-xs text-slate-400">Total Spent</p>
                                    <p className="text-xl font-bold text-red-400">{fmtCur(totalSpent)}</p>
                                    <p className="text-xs text-slate-500">{startDate} to {endDate}</p>
                                </div>
                                <div className={`p-4 rounded-xl border ${totalRemaining >= 0 ? 'bg-emerald-500/10 border-emerald-500/30' : 'bg-red-500/10 border-red-500/30'}`}>
                                    <p className="text-xs text-slate-400">Remaining</p>
                                    <p className={`text-xl font-bold ${totalRemaining >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{fmtCur(totalRemaining)}</p>
                                    <p className="text-xs text-slate-500">{totalBudget > 0 ? ((totalRemaining / totalBudget) * 100).toFixed(1) + '% left' : '-'}</p>
                                </div>
                                <div className="p-4 bg-amber-500/10 rounded-xl border border-amber-500/30">
                                    <p className="text-xs text-slate-400">% Used</p>
                                    <p className="text-xl font-bold text-amber-400">{totalBudget > 0 ? ((totalSpent / totalBudget) * 100).toFixed(1) + '%' : '0%'}</p>
                                    <p className="text-xs text-slate-500">of total budget</p>
                                </div>
                            </div>

                            {/* Budget Table */}
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                                <div className="p-3 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center">
                                    <h3 className="text-sm font-semibold text-amber-400">Budget vs Actual by Department</h3>
                                    {editMode && (
                                        <button onClick={handleSaveBudget} disabled={saving} className="px-4 py-2 bg-emerald-500 text-white rounded-lg text-sm font-medium disabled:opacity-50">
                                            {saving ? 'Saving...' : 'üíæ Save Budget'}
                                        </button>
                                    )}
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead>
                                            <tr className="border-b border-slate-700 bg-slate-800/50">
                                                <th className="px-3 py-2 text-left text-amber-400">Department/Category</th>
                                                <th className="px-3 py-2 text-right text-amber-400">{editMode ? 'Budget Amount' : 'Budget'}</th>
                                                <th className="px-3 py-2 text-right text-amber-400">Spent</th>
                                                <th className="px-3 py-2 text-right text-amber-400">Remaining</th>
                                                <th className="px-3 py-2 text-center text-amber-400">% Used</th>
                                                <th className="px-3 py-2 text-left text-amber-400">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {EXPENSE_CATEGORIES.map(cat => {
                                                const budget = editMode ? (parseFloat(budgetForm[cat]) || 0) : getBudgetForCategory(cat);
                                                const spent = getSpentByCategory(cat);
                                                const remaining = budget - spent;
                                                const pctUsed = budget > 0 ? (spent / budget) * 100 : 0;
                                                const status = budget === 0 ? 'no-budget' : pctUsed > 100 ? 'over' : pctUsed > 80 ? 'warning' : 'good';
                                                
                                                if (!editMode && budget === 0 && spent === 0) return null;
                                                
                                                return (
                                                    <tr key={cat} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                        <td className="px-3 py-2 text-white">{cat}</td>
                                                        <td className="px-3 py-2 text-right">
                                                            {editMode ? (
                                                                <input 
                                                                    type="number" 
                                                                    step="0.01"
                                                                    min="0"
                                                                    value={budgetForm[cat] === '' || budgetForm[cat] === undefined ? '' : budgetForm[cat]} 
                                                                    onChange={e => setBudgetForm({...budgetForm, [cat]: e.target.value})}
                                                                    className="w-24 px-2 py-1 bg-slate-900 border border-slate-600 rounded text-white text-sm text-right"
                                                                    placeholder="0.00"
                                                                />
                                                            ) : (
                                                                <span className="text-blue-400">{fmtCur(budget)}</span>
                                                            )}
                                                        </td>
                                                        <td className="px-3 py-2 text-right text-red-400">{fmtCur(spent)}</td>
                                                        <td className={`px-3 py-2 text-right font-semibold ${remaining >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{fmtCur(remaining)}</td>
                                                        <td className="px-3 py-2 text-center">
                                                            {budget > 0 && (
                                                                <div className="flex items-center gap-2">
                                                                    <div className="flex-1 h-2 bg-slate-700 rounded-full overflow-hidden">
                                                                        <div 
                                                                            className={`h-full ${pctUsed > 100 ? 'bg-red-500' : pctUsed > 80 ? 'bg-amber-500' : 'bg-emerald-500'}`}
                                                                            style={{width: `${Math.min(pctUsed, 100)}%`}}
                                                                        ></div>
                                                                    </div>
                                                                    <span className="text-xs text-slate-400 w-12">{pctUsed.toFixed(0)}%</span>
                                                                </div>
                                                            )}
                                                        </td>
                                                        <td className="px-3 py-2">
                                                            {status === 'over' && <span className="px-2 py-1 bg-red-500/20 text-red-400 rounded text-xs">Over Budget</span>}
                                                            {status === 'warning' && <span className="px-2 py-1 bg-amber-500/20 text-amber-400 rounded text-xs">Warning</span>}
                                                            {status === 'good' && <span className="px-2 py-1 bg-emerald-500/20 text-emerald-400 rounded text-xs">On Track</span>}
                                                            {status === 'no-budget' && spent > 0 && <span className="px-2 py-1 bg-slate-500/20 text-slate-400 rounded text-xs">No Budget</span>}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                        <tfoot>
                                            <tr className="font-bold bg-amber-500/10">
                                                <td className="px-3 py-3 text-amber-400">TOTALS</td>
                                                <td className="px-3 py-3 text-right text-blue-400">{fmtCur(editMode ? Object.values(budgetForm).reduce((s, v) => s + (parseFloat(v) || 0), 0) : totalBudget)}</td>
                                                <td className="px-3 py-3 text-right text-red-400">{fmtCur(totalSpent)}</td>
                                                <td className={`px-3 py-3 text-right ${totalRemaining >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{fmtCur(totalRemaining)}</td>
                                                <td className="px-3 py-3 text-center text-amber-400">{totalBudget > 0 ? ((totalSpent / totalBudget) * 100).toFixed(0) + '%' : '-'}</td>
                                                <td></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </>
                    )}

                    {/* FORECASTED BUDGET VIEW */}
                    {budgetView === 'forecast' && (() => {
                        const totalLastYear = EXPENSE_CATEGORIES.reduce((s, c) => s + getForecastForCategory(c).lastYear, 0);
                        const totalYTD = EXPENSE_CATEGORIES.reduce((s, c) => s + getForecastForCategory(c).thisYearYTD, 0);
                        const totalAnnualized = EXPENSE_CATEGORIES.reduce((s, c) => s + getForecastForCategory(c).annualized, 0);
                        const totalForecast = EXPENSE_CATEGORIES.reduce((s, c) => s + getForecastForCategory(c).forecast, 0);
                        const overallGrowth = totalLastYear > 0 ? ((totalAnnualized - totalLastYear) / totalLastYear * 100) : 0;
                        
                        return (
                            <>
                                {/* Forecast Controls */}
                                <div className="bg-slate-800/50 rounded-xl border border-purple-500/30 p-4">
                                    <div className="flex flex-wrap gap-4 items-end justify-between">
                                        <div className="flex flex-wrap gap-4 items-end">
                                            <div>
                                                <label className="text-xs text-slate-400 block mb-1">Forecast Year</label>
                                                <select value={forecastYear} onChange={e => setForecastYear(parseInt(e.target.value))} className="px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm">
                                                    {[currentYear + 1, currentYear + 2].map(y => (
                                                        <option key={y} value={y}>{y}</option>
                                                    ))}
                                                </select>
                                            </div>
                                            <div>
                                                <label className="text-xs text-slate-400 block mb-1">Inflation Rate %</label>
                                                <input 
                                                    type="number" 
                                                    step="0.5" 
                                                    value={inflationRate} 
                                                    onChange={e => setInflationRate(parseFloat(e.target.value) || 0)}
                                                    className="w-20 px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm"
                                                />
                                            </div>
                                        </div>
                                        <div className="flex gap-2">
                                            <button onClick={exportForecastReport} className="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm">üì• Export Forecast</button>
                                            <button onClick={saveForecastAsBudget} disabled={saving} className="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm font-medium disabled:opacity-50">
                                                {saving ? 'Saving...' : `üíæ Save as ${forecastYear} Budget`}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Forecast Summary Cards */}
                                <div className="grid grid-cols-2 lg:grid-cols-5 gap-3">
                                    <div className="p-4 bg-slate-700/30 rounded-xl border border-slate-600">
                                        <p className="text-xs text-slate-400">{currentYear - 1} Total</p>
                                        <p className="text-xl font-bold text-slate-300">{fmtCur(totalLastYear)}</p>
                                    </div>
                                    <div className="p-4 bg-blue-500/10 rounded-xl border border-blue-500/30">
                                        <p className="text-xs text-slate-400">{currentYear} YTD ({monthsElapsed} mo)</p>
                                        <p className="text-xl font-bold text-blue-400">{fmtCur(totalYTD)}</p>
                                    </div>
                                    <div className="p-4 bg-cyan-500/10 rounded-xl border border-cyan-500/30">
                                        <p className="text-xs text-slate-400">{currentYear} Annualized</p>
                                        <p className="text-xl font-bold text-cyan-400">{fmtCur(totalAnnualized)}</p>
                                    </div>
                                    <div className={`p-4 rounded-xl border ${overallGrowth >= 0 ? 'bg-amber-500/10 border-amber-500/30' : 'bg-emerald-500/10 border-emerald-500/30'}`}>
                                        <p className="text-xs text-slate-400">YoY Growth</p>
                                        <p className={`text-xl font-bold ${overallGrowth >= 0 ? 'text-amber-400' : 'text-emerald-400'}`}>
                                            {overallGrowth >= 0 ? '+' : ''}{overallGrowth.toFixed(1)}%
                                        </p>
                                    </div>
                                    <div className="p-4 bg-purple-500/10 rounded-xl border border-purple-500/30">
                                        <p className="text-xs text-slate-400">{forecastYear} Forecast</p>
                                        <p className="text-xl font-bold text-purple-400">{fmtCur(totalForecast)}</p>
                                    </div>
                                </div>
                                
                                {/* Methodology Note */}
                                <div className="bg-slate-700/30 rounded-lg p-3 text-xs text-slate-400">
                                    <span className="text-purple-400 font-medium">Forecast Methodology:</span> {currentYear} YTD spending √ó annualization factor ({annualizationFactor.toFixed(2)}) + {inflationRate}% inflation. Adjust individual categories as needed.
                                </div>
                                
                                {/* Forecast Table */}
                                <div className="bg-slate-800/50 rounded-xl border border-purple-500/30 overflow-hidden">
                                    <div className="p-3 border-b border-slate-700 bg-slate-800/50">
                                        <h3 className="text-sm font-semibold text-purple-400">üîÆ {forecastYear} Budget Forecast by Department</h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="border-b border-slate-700 bg-slate-800/50">
                                                    <th className="px-3 py-2 text-left text-purple-400">Department</th>
                                                    <th className="px-3 py-2 text-right text-slate-400">{currentYear - 1}</th>
                                                    <th className="px-3 py-2 text-right text-slate-400">{currentYear} YTD</th>
                                                    <th className="px-3 py-2 text-right text-slate-400">Annualized</th>
                                                    <th className="px-3 py-2 text-right text-slate-400">Growth</th>
                                                    <th className="px-3 py-2 text-right text-purple-400">Base Forecast</th>
                                                    <th className="px-3 py-2 text-right text-purple-400">Adjustment</th>
                                                    <th className="px-3 py-2 text-right text-purple-400 font-bold">Final Forecast</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {EXPENSE_CATEGORIES.map(cat => {
                                                    const f = getForecastForCategory(cat);
                                                    if (f.lastYear === 0 && f.thisYearYTD === 0) return null;
                                                    
                                                    return (
                                                        <tr key={cat} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                            <td className="px-3 py-2 text-white">{cat}</td>
                                                            <td className="px-3 py-2 text-right text-slate-400">{fmtCur(f.lastYear)}</td>
                                                            <td className="px-3 py-2 text-right text-blue-400">{fmtCur(f.thisYearYTD)}</td>
                                                            <td className="px-3 py-2 text-right text-cyan-400">{fmtCur(f.annualized)}</td>
                                                            <td className={`px-3 py-2 text-right ${f.growthRate >= 0 ? 'text-amber-400' : 'text-emerald-400'}`}>
                                                                {f.lastYear > 0 ? `${f.growthRate >= 0 ? '+' : ''}${(f.growthRate * 100).toFixed(0)}%` : '-'}
                                                            </td>
                                                            <td className="px-3 py-2 text-right text-slate-300">{fmtCur(f.baseForecast)}</td>
                                                            <td className="px-3 py-2 text-right">
                                                                <input 
                                                                    type="number" 
                                                                    step="100"
                                                                    value={forecastAdjustments[cat] || ''} 
                                                                    onChange={e => setForecastAdjustments({...forecastAdjustments, [cat]: e.target.value})}
                                                                    className="w-20 px-2 py-1 bg-slate-900 border border-slate-600 rounded text-white text-xs text-right"
                                                                    placeholder="¬±0"
                                                                />
                                                            </td>
                                                            <td className="px-3 py-2 text-right text-purple-400 font-bold">{fmtCur(f.forecast)}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                            <tfoot>
                                                <tr className="font-bold bg-purple-500/10">
                                                    <td className="px-3 py-3 text-purple-400">TOTALS</td>
                                                    <td className="px-3 py-3 text-right text-slate-400">{fmtCur(totalLastYear)}</td>
                                                    <td className="px-3 py-3 text-right text-blue-400">{fmtCur(totalYTD)}</td>
                                                    <td className="px-3 py-3 text-right text-cyan-400">{fmtCur(totalAnnualized)}</td>
                                                    <td className={`px-3 py-3 text-right ${overallGrowth >= 0 ? 'text-amber-400' : 'text-emerald-400'}`}>
                                                        {overallGrowth >= 0 ? '+' : ''}{overallGrowth.toFixed(0)}%
                                                    </td>
                                                    <td className="px-3 py-3 text-right text-slate-300">{fmtCur(totalAnnualized * (1 + inflationRate / 100))}</td>
                                                    <td className="px-3 py-3 text-right text-slate-400">{fmtCur(Object.values(forecastAdjustments).reduce((s, v) => s + (parseFloat(v) || 0), 0))}</td>
                                                    <td className="px-3 py-3 text-right text-purple-400 text-lg">{fmtCur(totalForecast)}</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                                
                                {/* Insights */}
                                <div className="bg-gradient-to-r from-purple-500/10 to-blue-500/10 rounded-xl border border-purple-500/30 p-4">
                                    <h4 className="text-sm font-semibold text-purple-400 mb-3">üí° Budget Forecast Insights</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div className="space-y-2">
                                            <p className="text-slate-300">
                                                <span className="text-white font-medium">Projected {forecastYear} expenses:</span> {fmtCur(totalForecast)}
                                            </p>
                                            <p className="text-slate-300">
                                                <span className="text-white font-medium">vs {currentYear - 1} actual:</span> {fmtCur(totalForecast - totalLastYear)} ({totalLastYear > 0 ? ((totalForecast - totalLastYear) / totalLastYear * 100).toFixed(1) : 0}%)
                                            </p>
                                            {(() => {
                                                const highGrowthCats = EXPENSE_CATEGORIES.filter(c => {
                                                    const f = getForecastForCategory(c);
                                                    return f.lastYear > 0 && f.growthRate > 0.2;
                                                });
                                                return highGrowthCats.length > 0 && (
                                                    <p className="text-amber-400">‚ö†Ô∏è High growth categories: {highGrowthCats.slice(0, 3).join(', ')}</p>
                                                );
                                            })()}
                                        </div>
                                        <div className="space-y-2">
                                            {(() => {
                                                const overBudgetCats = EXPENSE_CATEGORIES.filter(c => {
                                                    const f = getForecastForCategory(c);
                                                    const currentBudget = getBudgetForCategory(c);
                                                    return currentBudget > 0 && f.annualized > currentBudget;
                                                });
                                                return overBudgetCats.length > 0 && (
                                                    <p className="text-red-400">üö® Categories projected over {currentYear} budget: {overBudgetCats.slice(0, 3).join(', ')}</p>
                                                );
                                            })()}
                                            <p className="text-slate-400 text-xs">
                                                Tip: Use the Adjustment column to fine-tune forecasts for known changes (e.g., planned projects, new expenses, cost cuts).
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </>
                        );
                    })()}
                </div>
            );
        }

        // Projects Section Component
        function ProjectsSection({ projects, titheEntries, expenses, supabase, user, onUpdate, canEdit }) {
            const [selectedProject, setSelectedProject] = useState(null);
            const [showDeleteConfirm, setShowDeleteConfirm] = useState(null);

            const deleteProject = async (id) => {
                try {
                    await supabase.from('projects').delete().eq('id', id);
                    onUpdate();
                    setShowDeleteConfirm(null);
                } catch (err) {
                    alert('Error: ' + err.message);
                }
            };

            const toggleStatus = async (project) => {
                const newStatus = project.status === 'Active' ? 'Completed' : 'Active';
                await supabase.from('projects').update({ status: newStatus }).eq('id', project.id);
                onUpdate();
            };

            // Calculate project financials - supports both old project_id and new project_links
            const getProjectFinancials = (projectId) => {
                const project = projects.find(p => p.id === projectId);
                const openingBalance = parseFloat(project?.opening_balance) || 0;
                
                // Calculate income from tithe entries
                let income = 0;
                titheEntries.forEach(t => {
                    // Support old project_id field (backward compatibility)
                    if (t.project_id === projectId) {
                        income += (parseFloat(t.project) || 0) + (parseFloat(t.government_fund) || 0);
                    }
                    
                    // Support new project_links JSON field
                    if (t.project_links) {
                        try {
                            const links = typeof t.project_links === 'string' ? JSON.parse(t.project_links) : t.project_links;
                            Object.entries(links).forEach(([fieldKey, linkedProjectId]) => {
                                if (linkedProjectId === projectId) {
                                    income += parseFloat(t[fieldKey]) || 0;
                                }
                            });
                        } catch (e) { /* ignore parse errors */ }
                    }
                });
                
                const spent = expenses
                    .filter(e => e.project_id === projectId)
                    .reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                const totalIncome = openingBalance + income;
                return { openingBalance, income, totalIncome, spent, balance: totalIncome - spent };
            };

            // Get tithe entries linked to a project (for display/export)
            const getProjectTithes = (projectId) => {
                return titheEntries.filter(t => {
                    // Check old project_id
                    if (t.project_id === projectId) return true;
                    
                    // Check new project_links
                    if (t.project_links) {
                        try {
                            const links = typeof t.project_links === 'string' ? JSON.parse(t.project_links) : t.project_links;
                            return Object.values(links).includes(projectId);
                        } catch (e) { return false; }
                    }
                    return false;
                });
            };

            const exportProjectReport = (project) => {
                try {
                    const financials = getProjectFinancials(project.id);
                    const projectTithes = getProjectTithes(project.id);
                    const projectExpenses = expenses.filter(e => e.project_id === project.id);
                    
                    const data = [
                        ['PROJECT REPORT'],
                        [project.name],
                        [`Status: ${project.status}`],
                        [`Generated: ${new Date().toLocaleDateString()}`],
                        [],
                        ['SUMMARY'],
                        ['Target Amount', project.target_amount || 0],
                        financials.openingBalance > 0 ? ['Opening Balance (B/F)', financials.openingBalance] : [],
                        ['Income (New Contributions)', financials.income],
                        ['Total Income', financials.totalIncome],
                        ['Total Expenses', financials.spent],
                        ['Balance', financials.balance],
                        project.target_amount ? ['Progress', `${((financials.totalIncome / project.target_amount) * 100).toFixed(1)}%`] : [],
                        [],
                        ['INCOME (Contributions)'],
                        ['Date', 'Member', 'Amount'],
                        ...projectTithes.map(t => [t.date, t.name, (parseFloat(t.project) || 0) + (parseFloat(t.government_fund) || 0)]),
                        [],
                        ['EXPENSES'],
                        ['Date', 'Description', 'Cheque #', 'Amount'],
                        ...projectExpenses.map(e => [e.date, e.description, e.cheque_number || '', parseFloat(e.amount) || 0])
                    ].filter(row => row.length > 0);
                    
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!cols'] = [{wch: 15}, {wch: 25}, {wch: 12}, {wch: 12}];
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Project Report');
                    XLSX.writeFile(wb, `Project_${project.name.replace(/\s+/g, '_')}_Report.xlsx`);
                } catch (err) {
                    alert('Export error: ' + err.message);
                }
            };

            return (
                <div className="space-y-4">
                    {/* Delete Confirmation Modal */}
                    {showDeleteConfirm && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                            <div className="bg-slate-800 rounded-xl p-6 max-w-sm border border-slate-700">
                                <h3 className="text-lg font-bold text-white mb-2">Delete Project?</h3>
                                <p className="text-slate-400 mb-4">This will not delete linked tithes or expenses, but they will no longer be associated with this project.</p>
                                <div className="flex gap-2 justify-end">
                                    <button onClick={() => setShowDeleteConfirm(null)} className="px-4 py-2 rounded-lg bg-slate-700 text-slate-300">Cancel</button>
                                    <button onClick={() => deleteProject(showDeleteConfirm)} className="px-4 py-2 rounded-lg bg-red-500 text-white">Delete</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Header */}
                    <div className="flex justify-between items-center">
                        <h2 className="text-xl font-bold text-white">Projects</h2>
                        {canEdit && <button onClick={() => window.dispatchEvent(new CustomEvent('navigate', { detail: { view: 'project-entry', item: null } }))} className="px-3 py-2 bg-purple-500 text-white rounded-lg text-sm font-medium">+ New Project</button>}
                    </div>

                    {/* Projects Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        {projects.map(project => {
                            const financials = getProjectFinancials(project.id);
                            const progress = project.target_amount ? (financials.totalIncome / project.target_amount) * 100 : 0;
                            
                            return (
                                <div key={project.id} className={`bg-slate-800/50 rounded-xl border ${project.status === 'Active' ? 'border-purple-500/50' : 'border-slate-700'} overflow-hidden`}>
                                    <div className={`p-4 ${project.status === 'Active' ? 'bg-purple-500/10' : 'bg-slate-700/30'}`}>
                                        <div className="flex justify-between items-start">
                                            <div>
                                                <h3 className="text-lg font-bold text-white">{project.name}</h3>
                                                <span className={`text-xs px-2 py-0.5 rounded-full ${project.status === 'Active' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-slate-600 text-slate-400'}`}>
                                                    {project.status}
                                                </span>
                                            </div>
                                            {canEdit && (
                                                <div className="flex gap-1">
                                                    <button onClick={() => window.dispatchEvent(new CustomEvent('navigate', { detail: { view: 'project-entry', item: project } }))} className="p-1.5 rounded bg-slate-700 text-slate-300 text-xs hover:bg-blue-600">‚úèÔ∏è</button>
                                                    <button onClick={() => setShowDeleteConfirm(project.id)} className="p-1.5 rounded bg-slate-700 text-slate-300 text-xs hover:bg-red-600">üóëÔ∏è</button>
                                                </div>
                                            )}
                                        </div>
                                        {project.description && <p className="text-sm text-slate-400 mt-1">{project.description}</p>}
                                    </div>
                                    
                                    <div className="p-4 space-y-3">
                                        {project.target_amount > 0 && (
                                            <div>
                                                <div className="flex justify-between text-xs text-slate-400 mb-1">
                                                    <span>Target: {fmtCur(project.target_amount)}</span>
                                                    <span>{progress.toFixed(0)}%</span>
                                                </div>
                                                <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                                                    <div className={`h-full ${progress >= 100 ? 'bg-emerald-500' : 'bg-purple-500'}`} style={{ width: `${Math.min(progress, 100)}%` }}></div>
                                                </div>
                                            </div>
                                        )}
                                        
                                        <div className="grid grid-cols-2 gap-2 text-center">
                                            {financials.openingBalance > 0 && (
                                                <div className="p-2 bg-purple-500/10 rounded-lg">
                                                    <p className="text-xs text-slate-400">Bal B/F</p>
                                                    <p className="text-sm font-bold text-purple-400">{fmtCur(financials.openingBalance)}</p>
                                                </div>
                                            )}
                                            <div className="p-2 bg-emerald-500/10 rounded-lg">
                                                <p className="text-xs text-slate-400">{financials.openingBalance > 0 ? 'New Income' : 'Income'}</p>
                                                <p className="text-sm font-bold text-emerald-400">{fmtCur(financials.income)}</p>
                                            </div>
                                            <div className="p-2 bg-red-500/10 rounded-lg">
                                                <p className="text-xs text-slate-400">Expenses</p>
                                                <p className="text-sm font-bold text-red-400">{fmtCur(financials.spent)}</p>
                                            </div>
                                            <div className={`p-2 rounded-lg ${financials.balance >= 0 ? 'bg-blue-500/10' : 'bg-amber-500/10'}`}>
                                                <p className="text-xs text-slate-400">Balance</p>
                                                <p className={`text-sm font-bold ${financials.balance >= 0 ? 'text-blue-400' : 'text-amber-400'}`}>{fmtCur(financials.balance)}</p>
                                            </div>
                                        </div>
                                        
                                        <div className="flex gap-2">
                                            {canEdit && (
                                                <button onClick={() => toggleStatus(project)} className={`flex-1 px-3 py-1.5 rounded-lg text-xs font-medium ${project.status === 'Active' ? 'bg-slate-700 text-slate-300 hover:bg-slate-600' : 'bg-emerald-600 text-white hover:bg-emerald-500'}`}>
                                                    {project.status === 'Active' ? 'Mark Complete' : 'Reactivate'}
                                                </button>
                                            )}
                                            <button onClick={() => exportProjectReport(project)} className="px-3 py-1.5 bg-amber-600 text-white rounded-lg text-xs font-medium hover:bg-amber-500">üì• Export</button>
                                        </div>
                                    </div>
                                </div>
                            );
                        })}
                        
                        {projects.length === 0 && (
                            <div className="col-span-full text-center py-12 text-slate-500">
                                <p className="text-4xl mb-2">üìã</p>
                                <p>No projects yet. Create one to start tracking!</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        // Project Form Component
        function ProjectForm({ onSubmit, onCancel, initialData }) {
            const [form, setForm] = useState(initialData || { name: '', description: '', target_amount: '', opening_balance: '', status: 'Active', start_date: new Date().toISOString().split('T')[0] });
            const [saving, setSaving] = useState(false);
            const handleChange = (k, v) => setForm(p => ({ ...p, [k]: v }));
            const handleSubmit = async (e) => { e.preventDefault(); setSaving(true); await onSubmit(form); setSaving(false); };
            const inputCls = "w-full px-3 py-2 bg-slate-900/50 border border-slate-600 rounded-lg text-white text-sm";

            return (
                <div className="max-w-lg mx-auto bg-slate-800/50 rounded-xl border border-slate-700">
                    <div className="p-4 border-b border-slate-700 bg-purple-500/10">
                        <h2 className="text-lg font-bold text-white">{initialData ? 'Edit' : 'New'} Project</h2>
                    </div>
                    <form onSubmit={handleSubmit} className="p-4 space-y-4">
                        <div>
                            <label className="text-xs text-slate-400">Project Name *</label>
                            <input type="text" value={form.name} onChange={e => handleChange('name', e.target.value)} className={inputCls} required placeholder="e.g., Building Fund 2025" />
                        </div>
                        <div>
                            <label className="text-xs text-slate-400">Description</label>
                            <textarea value={form.description} onChange={e => handleChange('description', e.target.value)} className={inputCls} rows="2" placeholder="Optional description..." />
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="text-xs text-slate-400">Target Amount (Optional)</label>
                                <input type="number" step="0.01" value={form.target_amount} onChange={e => handleChange('target_amount', e.target.value)} className={inputCls} placeholder="0.00" />
                            </div>
                            <div>
                                <label className="text-xs text-slate-400">Opening Balance</label>
                                <input type="number" step="0.01" value={form.opening_balance} onChange={e => handleChange('opening_balance', e.target.value)} className={inputCls} placeholder="0.00" />
                                <p className="text-xs text-slate-500 mt-1">Balance brought forward</p>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="text-xs text-slate-400">Start Date</label>
                                <input type="date" value={form.start_date} onChange={e => handleChange('start_date', e.target.value)} className={inputCls} />
                            </div>
                            <div>
                                <label className="text-xs text-slate-400">Status</label>
                                <select value={form.status} onChange={e => handleChange('status', e.target.value)} className={inputCls}>
                                    <option value="Active">Active</option>
                                    <option value="Completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        <div className="flex gap-2 justify-end">
                            <button type="button" onClick={onCancel} className="px-4 py-2 rounded-lg bg-slate-700 text-slate-300 text-sm">Cancel</button>
                            <button type="submit" disabled={saving} className="px-4 py-2 rounded-lg bg-purple-500 text-white font-semibold text-sm disabled:opacity-50">{saving ? 'Saving...' : 'Save'}</button>
                        </div>
                    </form>
                </div>
            );
        }

        // Forecasting Section Component
        function ForecastingSection({ titheEntries, expenses, deposits, settings }) {
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth();
            const lastYear = currentYear - 1;
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const [viewMode, setViewMode] = useState('overview'); // overview, yoy, tithe, projection
            
            // Calculate monthly data for current year from database
            const getMonthlyData = (entries, year, field = 'total_received') => {
                const data = Array(12).fill(0);
                entries.forEach(e => {
                    const d = new Date(e.date);
                    if (d.getFullYear() === year) {
                        data[d.getMonth()] += parseFloat(e[field]) || 0;
                    }
                });
                return data;
            };
            
            const getMonthlyExpenses = (year) => {
                const data = Array(12).fill(0);
                expenses.forEach(e => {
                    const d = new Date(e.date);
                    if (d.getFullYear() === year) {
                        data[d.getMonth()] += parseFloat(e.amount) || 0;
                    }
                });
                return data;
            };
            
            const getMonthlyDeposits = (year) => {
                const data = Array(12).fill(0);
                titheEntries.forEach(e => {
                    const dt = new Date(e.date);
                    if (dt.getFullYear() === year) {
                        data[dt.getMonth()] += parseFloat(e.total_received) || 0;
                    }
                });
                return data;
            };
            
            // Current year data (2026) from database
            // Church income = (Budget Covenant - School - Children's Home) * 60%
            const thisYearBudgetCovenant = getMonthlyData(titheEntries, currentYear, 'budget_covenant');
            const thisYearSchool = getMonthlyData(titheEntries, currentYear, 'school');
            const thisYearChildrensHome = getMonthlyData(titheEntries, currentYear, 'pos_band');
            // Wesport expenses by month
            const thisYearWesport = Array(12).fill(0);
            expenses.forEach(e => {
                const dt = new Date(e.date);
                if (dt.getFullYear() === currentYear && (e.category === 'School - Wesport' || e.department === 'School - Wesport')) {
                    thisYearWesport[dt.getMonth()] += parseFloat(e.amount) || 0;
                }
            });
            const thisYearIncome = thisYearBudgetCovenant.map((v, i) => (v - (thisYearSchool[i] || 0) - (thisYearChildrensHome[i] || 0) - (thisYearWesport[i] || 0)) * 0.6);
            const thisYearTithe = getMonthlyData(titheEntries, currentYear, 'tithe');
            const thisYearExpenses = getMonthlyExpenses(currentYear);
            const thisYearDeposits = getMonthlyDeposits(currentYear);
            
            // 2025 Historical Data (hardcoded from financial statements)
            const lastYearTithe = Array(12).fill(0).map((_, i) => HISTORICAL_DATA_2025.tithe[i + 1] || 0);
            const lastYearBudgetCovenant = Array(12).fill(0).map((_, i) => HISTORICAL_DATA_2025.churchIncome[i + 1] || 0);
            const lastYearIncome = lastYearBudgetCovenant.map(v => v * 0.6); // Historical already adjusted
            const lastYearExpenses = Array(12).fill(0).map((_, i) => HISTORICAL_DATA_2025.expenses[i + 1] || 0);
            
            // YTD calculations (only count months up to current)
            const ytdIncome = thisYearIncome.slice(0, currentMonth + 1).reduce((s, v) => s + v, 0);
            const ytdExpenses = thisYearExpenses.slice(0, currentMonth + 1).reduce((s, v) => s + v, 0);
            const ytdDeposits = thisYearDeposits.slice(0, currentMonth + 1).reduce((s, v) => s + v, 0);
            const ytdTitheTotal = thisYearTithe.slice(0, currentMonth + 1).reduce((s, v) => s + v, 0);
            
            // 2025 same period totals
            const lastYearSamePeriodIncome = lastYearIncome.slice(0, currentMonth + 1).reduce((s, v) => s + v, 0);
            const lastYearSamePeriodExpenses = lastYearExpenses.slice(0, currentMonth + 1).reduce((s, v) => s + v, 0);
            const lastYearSamePeriodTithe = lastYearTithe.slice(0, currentMonth + 1).reduce((s, v) => s + v, 0);
            const lastYearTotalIncome = HISTORICAL_DATA_2025.totals.churchIncome * 0.6; // 60% kept
            const lastYearTotalExpenses = HISTORICAL_DATA_2025.totals.expenses;
            const lastYearTotalTithe = HISTORICAL_DATA_2025.totals.tithe;
            
            // Calculate averages and projections
            const monthsElapsed = currentMonth + 1;
            const avgMonthlyIncome = ytdIncome / monthsElapsed;
            const avgMonthlyExpenses = ytdExpenses / monthsElapsed;
            const avgMonthlyTithe = ytdTitheTotal / monthsElapsed;
            const remainingMonths = 12 - monthsElapsed;
            
            // Seasonal projection: Use 2025 patterns for remaining months
            const getSeasonalProjection = (ytdActual, lastYearMonthlyData) => {
                if (monthsElapsed >= 12) return ytdActual;
                const lastYearYTD = lastYearMonthlyData.slice(0, monthsElapsed).reduce((s, v) => s + v, 0);
                const lastYearTotal = lastYearMonthlyData.reduce((s, v) => s + v, 0);
                if (lastYearYTD === 0) return ytdActual * (12 / monthsElapsed);
                const growthRate = lastYearYTD > 0 ? ytdActual / lastYearYTD : 1;
                const lastYearRemaining = lastYearTotal - lastYearYTD;
                return ytdActual + (lastYearRemaining * growthRate);
            };
            
            // Year-end projections (using 2025 seasonal patterns)
            const projectedYearEndIncome = getSeasonalProjection(ytdIncome, lastYearIncome);
            const projectedYearEndExpenses = getSeasonalProjection(ytdExpenses, lastYearExpenses);
            const projectedYearEndTithe = getSeasonalProjection(ytdTitheTotal, lastYearTithe);
            const projectedNetPosition = projectedYearEndIncome - projectedYearEndExpenses;
            
            // Conference fund projection (Tithe + 40% of (Budget Covenant - School - Children's Home))
            const ytdTithe = getMonthlyData(titheEntries, currentYear, 'tithe').slice(0, currentMonth + 1).reduce((s, v) => s + v, 0);
            const ytdBaseFor40 = thisYearBudgetCovenant.slice(0, currentMonth + 1).reduce((s, v) => s + v, 0) 
                - thisYearSchool.slice(0, currentMonth + 1).reduce((s, v) => s + v, 0)
                - thisYearChildrensHome.slice(0, currentMonth + 1).reduce((s, v) => s + v, 0);
            const ytdConferenceFund = ytdTithe + (ytdBaseFor40 * 0.4);
            // For projection: if churchOperating = base * 0.6, then 40% = churchOperating * (0.4/0.6)
            const projectedConferenceFund = projectedYearEndTithe + (projectedYearEndIncome * (0.4 / 0.6));
            
            // Trend calculations (YoY change vs 2025)
            const incomeChangePercent = lastYearSamePeriodIncome > 0 ? ((ytdIncome - lastYearSamePeriodIncome) / lastYearSamePeriodIncome * 100) : 0;
            const expenseChangePercent = lastYearSamePeriodExpenses > 0 ? ((ytdExpenses - lastYearSamePeriodExpenses) / lastYearSamePeriodExpenses * 100) : 0;
            const titheChangePercent = lastYearSamePeriodTithe > 0 ? ((ytdTitheTotal - lastYearSamePeriodTithe) / lastYearSamePeriodTithe * 100) : 0;
            
            // 6-month cash flow projection (using 2025 seasonal patterns)
            const startingBalance = parseFloat(settings.previous_balance) || 0;
            const currentBalance = startingBalance + ytdDeposits - ytdExpenses;
            const cashFlowProjection = [];
            let runningBalance = currentBalance;
            for (let i = 0; i < 6; i++) {
                const futureMonthIdx = (currentMonth + 1 + i) % 12;
                // Use 2025 data as baseline with growth/decline rate applied
                const baseInflow = lastYearIncome[futureMonthIdx] || avgMonthlyIncome;
                const baseOutflow = lastYearExpenses[futureMonthIdx] || avgMonthlyExpenses;
                const growthMultiplier = lastYearSamePeriodIncome > 0 ? ytdIncome / lastYearSamePeriodIncome : 1;
                const expenseMultiplier = lastYearSamePeriodExpenses > 0 ? ytdExpenses / lastYearSamePeriodExpenses : 1;
                const projectedInflow = baseInflow * growthMultiplier;
                const projectedOutflow = baseOutflow * expenseMultiplier;
                runningBalance = runningBalance + projectedInflow - projectedOutflow;
                cashFlowProjection.push({
                    month: months[futureMonthIdx],
                    balance: runningBalance,
                    inflow: projectedInflow,
                    outflow: projectedOutflow
                });
            }
            
            // Alerts
            const alerts = [];
            if (avgMonthlyExpenses > avgMonthlyIncome && currentBalance > 0) {
                const monthsUntilNegative = currentBalance / (avgMonthlyExpenses - avgMonthlyIncome);
                alerts.push({ type: 'danger', message: `At current pace, expenses exceed income. Cash reserves may deplete in ${Math.ceil(monthsUntilNegative)} months.` });
            }
            if (titheChangePercent < -10) {
                alerts.push({ type: 'warning', message: `Tithe is down ${Math.abs(titheChangePercent).toFixed(1)}% compared to 2025 same period.` });
            }
            if (titheChangePercent > 10) {
                alerts.push({ type: 'success', message: `Tithe is up ${titheChangePercent.toFixed(1)}% compared to 2025 same period! üéâ` });
            }
            if (incomeChangePercent < -10) {
                alerts.push({ type: 'warning', message: `Church income is down ${Math.abs(incomeChangePercent).toFixed(1)}% compared to 2025 same period.` });
            }
            if (expenseChangePercent > 20) {
                alerts.push({ type: 'warning', message: `Expenses are up ${expenseChangePercent.toFixed(1)}% compared to 2025 same period.` });
            }
            if (projectedNetPosition < 0) {
                alerts.push({ type: 'danger', message: `Projected year-end deficit: ${fmtCur(Math.abs(projectedNetPosition))}` });
            }
            if (cashFlowProjection.some(p => p.balance < 0)) {
                const negMonth = cashFlowProjection.find(p => p.balance < 0);
                alerts.push({ type: 'danger', message: `Cash balance projected to go negative in ${negMonth.month}.` });
            }
            if (alerts.length === 0) {
                alerts.push({ type: 'success', message: 'Financial health looks good! Income exceeds expenses and cash flow is positive.' });
            }
            
            // Member giving analysis
            const getMemberStats = () => {
                const thisYearMembers = new Set(titheEntries.filter(e => new Date(e.date).getFullYear() === currentYear).map(e => e.name));
                const lastYearMembers = new Set(titheEntries.filter(e => new Date(e.date).getFullYear() === lastYear).map(e => e.name));
                
                const retained = [...thisYearMembers].filter(m => lastYearMembers.has(m)).length;
                const newGivers = [...thisYearMembers].filter(m => !lastYearMembers.has(m)).length;
                const lapsed = [...lastYearMembers].filter(m => !thisYearMembers.has(m)).length;
                
                return { total: thisYearMembers.size, retained, newGivers, lapsed };
            };
            const memberStats = getMemberStats();
            
            // Top givers change analysis
            const getTopGiversChange = () => {
                const thisYearTotals = {};
                const lastYearTotals = {};
                
                titheEntries.forEach(e => {
                    const year = new Date(e.date).getFullYear();
                    const amount = parseFloat(e.total_received) || 0;
                    if (year === currentYear) {
                        thisYearTotals[e.name] = (thisYearTotals[e.name] || 0) + amount;
                    } else if (year === lastYear) {
                        lastYearTotals[e.name] = (lastYearTotals[e.name] || 0) + amount;
                    }
                });
                
                const allMembers = [...new Set([...Object.keys(thisYearTotals), ...Object.keys(lastYearTotals)])];
                const changes = allMembers.map(name => ({
                    name,
                    thisYear: thisYearTotals[name] || 0,
                    lastYear: lastYearTotals[name] || 0,
                    change: (thisYearTotals[name] || 0) - (lastYearTotals[name] || 0)
                })).filter(m => m.thisYear > 0 || m.lastYear > 0);
                
                const increasing = changes.filter(m => m.change > 100).sort((a, b) => b.change - a.change).slice(0, 5);
                const decreasing = changes.filter(m => m.change < -100).sort((a, b) => a.change - b.change).slice(0, 5);
                
                return { increasing, decreasing };
            };
            const givingChanges = getTopGiversChange();
            
            // Seasonal pattern with 2025 data
            const seasonalPattern = months.map((month, idx) => ({
                month, 
                lastYear: lastYearIncome[idx], 
                lastYearTithe: lastYearTithe[idx],
                thisYear: idx <= currentMonth ? thisYearIncome[idx] : null,
                thisYearTithe: idx <= currentMonth ? thisYearTithe[idx] : null
            }));
            
            const maxTitheBar = Math.max(...lastYearTithe, ...thisYearTithe.slice(0, currentMonth + 1), 1);
            const maxIncomeBar = Math.max(...lastYearIncome, ...thisYearIncome.slice(0, currentMonth + 1), 1);

            return (
                <div className="space-y-4">
                    {/* View Mode Tabs */}
                    <div className="flex gap-2 flex-wrap">
                        {[
                            { id: 'overview', label: 'üìä Overview', icon: '' },
                            { id: 'tithe', label: 'üí∞ Tithe Analysis', icon: '' },
                            { id: 'projection', label: 'üîÆ Projections', icon: '' },
                            { id: 'givingPatterns', label: 'üìà Giving Patterns', icon: '' }
                        ].map(tab => (
                            <button
                                key={tab.id}
                                onClick={() => setViewMode(tab.id)}
                                className={`px-4 py-2 rounded-lg text-sm font-medium transition-all ${
                                    viewMode === tab.id 
                                        ? 'bg-amber-500 text-slate-900' 
                                        : 'bg-slate-700/50 text-slate-300 hover:bg-slate-600/50'
                                }`}
                            >
                                {tab.label}
                            </button>
                        ))}
                    </div>

                    {/* Alerts Panel */}
                    <div className="space-y-2">
                        {alerts.map((alert, idx) => (
                            <div key={idx} className={`p-3 rounded-lg border flex items-center gap-3 ${
                                alert.type === 'danger' ? 'bg-red-500/10 border-red-500/30 text-red-400' :
                                alert.type === 'warning' ? 'bg-amber-500/10 border-amber-500/30 text-amber-400' :
                                'bg-emerald-500/10 border-emerald-500/30 text-emerald-400'
                            }`}>
                                <span className="text-xl">{alert.type === 'danger' ? 'üö®' : alert.type === 'warning' ? '‚ö†Ô∏è' : '‚úÖ'}</span>
                                <span className="text-sm">{alert.message}</span>
                            </div>
                        ))}
                    </div>

                    {/* OVERVIEW MODE */}
                    {viewMode === 'overview' && (
                        <>
                            {/* Year-End Projections */}
                            <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
                                <div className="bg-gradient-to-br from-blue-500/20 to-transparent rounded-xl border border-blue-500/30 p-4">
                                    <p className="text-xs text-slate-400">Projected Year-End Tithe</p>
                                    <p className="text-xl font-bold text-blue-400">{fmtCur(projectedYearEndTithe)}</p>
                                    <div className="flex items-center gap-1 mt-1">
                                        <span className={`text-xs ${titheChangePercent >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                            {titheChangePercent >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(titheChangePercent).toFixed(1)}%
                                        </span>
                                        <span className="text-xs text-slate-500">vs 2025</span>
                                    </div>
                                    <p className="text-xs text-slate-500 mt-1">2025: {fmtCur(lastYearTotalTithe)}</p>
                                </div>
                                <div className="bg-gradient-to-br from-amber-500/20 to-transparent rounded-xl border border-amber-500/30 p-4">
                                    <p className="text-xs text-slate-400">Projected Year-End Income</p>
                                    <p className="text-xl font-bold text-amber-400">{fmtCur(projectedYearEndIncome)}</p>
                                    <div className="flex items-center gap-1 mt-1">
                                        <span className={`text-xs ${incomeChangePercent >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                            {incomeChangePercent >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(incomeChangePercent).toFixed(1)}%
                                        </span>
                                        <span className="text-xs text-slate-500">vs 2025</span>
                                    </div>
                                    <p className="text-xs text-slate-500 mt-1">2025: {fmtCur(lastYearTotalIncome)}</p>
                                </div>
                                <div className="bg-gradient-to-br from-red-500/20 to-transparent rounded-xl border border-red-500/30 p-4">
                                    <p className="text-xs text-slate-400">Projected Year-End Expenses</p>
                                    <p className="text-xl font-bold text-red-400">{fmtCur(projectedYearEndExpenses)}</p>
                                    <div className="flex items-center gap-1 mt-1">
                                        <span className={`text-xs ${expenseChangePercent <= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                            {expenseChangePercent >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(expenseChangePercent).toFixed(1)}%
                                        </span>
                                        <span className="text-xs text-slate-500">vs 2025</span>
                                    </div>
                                    <p className="text-xs text-slate-500 mt-1">2025: {fmtCur(lastYearTotalExpenses)}</p>
                                </div>
                                <div className={`bg-gradient-to-br ${projectedNetPosition >= 0 ? 'from-emerald-500/20 border-emerald-500/30' : 'from-red-500/20 border-red-500/30'} to-transparent rounded-xl border p-4`}>
                                    <p className="text-xs text-slate-400">Projected Net Position</p>
                                    <p className={`text-xl font-bold ${projectedNetPosition >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{fmtCur(projectedNetPosition)}</p>
                                    <p className="text-xs text-slate-500 mt-1">{projectedNetPosition >= 0 ? 'Surplus' : 'Deficit'}</p>
                                    <p className="text-xs text-slate-500">2025 Net: {fmtCur(lastYearTotalIncome - lastYearTotalExpenses)}</p>
                                </div>
                            </div>
                        </>
                    )}

                    {/* TITHE ANALYSIS MODE */}
                    {viewMode === 'tithe' && (
                        <>
                            {/* Tithe KPIs */}
                            <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
                                <div className="bg-gradient-to-br from-blue-500/20 to-transparent rounded-xl border border-blue-500/30 p-4">
                                    <p className="text-xs text-slate-400">YTD Tithe ({currentYear})</p>
                                    <p className="text-xl font-bold text-blue-400">{fmtCur(ytdTitheTotal)}</p>
                                    <p className="text-xs text-slate-500 mt-1">2025 same period: {fmtCur(lastYearSamePeriodTithe)}</p>
                                </div>
                                <div className="bg-gradient-to-br from-amber-500/20 to-transparent rounded-xl border border-amber-500/30 p-4">
                                    <p className="text-xs text-slate-400">Avg Monthly Tithe</p>
                                    <p className="text-xl font-bold text-amber-400">{fmtCur(avgMonthlyTithe)}</p>
                                    <p className="text-xs text-slate-500 mt-1">2025 avg: {fmtCur(lastYearTotalTithe / 12)}</p>
                                </div>
                                <div className={`bg-gradient-to-br ${titheChangePercent >= 0 ? 'from-emerald-500/20 border-emerald-500/30' : 'from-red-500/20 border-red-500/30'} to-transparent rounded-xl border p-4`}>
                                    <p className="text-xs text-slate-400">YoY Change</p>
                                    <p className={`text-xl font-bold ${titheChangePercent >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                        {titheChangePercent >= 0 ? '+' : ''}{titheChangePercent.toFixed(1)}%
                                    </p>
                                    <p className="text-xs text-slate-500 mt-1">{fmtCur(ytdTitheTotal - lastYearSamePeriodTithe)} difference</p>
                                </div>
                                <div className="bg-gradient-to-br from-purple-500/20 to-transparent rounded-xl border border-purple-500/30 p-4">
                                    <p className="text-xs text-slate-400">Projected Year-End</p>
                                    <p className="text-xl font-bold text-purple-400">{fmtCur(projectedYearEndTithe)}</p>
                                    <p className="text-xs text-slate-500 mt-1">2025 total: {fmtCur(lastYearTotalTithe)}</p>
                                </div>
                            </div>

                            {/* Monthly Tithe Table */}
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                                <div className="p-3 border-b border-slate-700 bg-slate-800/50">
                                    <h3 className="text-sm font-semibold text-white">Monthly Tithe Detail</h3>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead><tr className="border-b border-slate-700 bg-slate-800/50">
                                            <th className="px-3 py-2 text-left text-slate-400">Month</th>
                                            <th className="px-3 py-2 text-right text-slate-400">2025 Tithe</th>
                                            <th className="px-3 py-2 text-right text-amber-400">2026 Tithe</th>
                                            <th className="px-3 py-2 text-right text-slate-400">Difference</th>
                                            <th className="px-3 py-2 text-right text-slate-400">% Change</th>
                                        </tr></thead>
                                        <tbody>
                                            {months.map((month, idx) => {
                                                const t2025 = lastYearTithe[idx];
                                                const t2026 = idx <= currentMonth ? thisYearTithe[idx] : null;
                                                const diff = t2026 !== null ? t2026 - t2025 : null;
                                                const pct = t2026 !== null && t2025 > 0 ? ((t2026 - t2025) / t2025 * 100) : null;
                                                
                                                return (
                                                    <tr key={month} className={`border-b border-slate-700/50 ${idx > currentMonth ? 'opacity-40' : ''}`}>
                                                        <td className="px-3 py-2 text-slate-300">{month}</td>
                                                        <td className="px-3 py-2 text-right text-slate-400">{fmtCur(t2025)}</td>
                                                        <td className="px-3 py-2 text-right text-amber-400">{t2026 !== null ? fmtCur(t2026) : '-'}</td>
                                                        <td className={`px-3 py-2 text-right ${diff !== null ? (diff >= 0 ? 'text-emerald-400' : 'text-red-400') : 'text-slate-500'}`}>
                                                            {diff !== null ? `${diff >= 0 ? '+' : ''}${fmtCur(diff)}` : '-'}
                                                        </td>
                                                        <td className={`px-3 py-2 text-right ${pct !== null ? (pct >= 0 ? 'text-emerald-400' : 'text-red-400') : 'text-slate-500'}`}>
                                                            {pct !== null ? `${pct >= 0 ? '+' : ''}${pct.toFixed(1)}%` : '-'}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                        <tfoot><tr className="font-bold bg-slate-700/30">
                                            <td className="px-3 py-2 text-white">TOTAL</td>
                                            <td className="px-3 py-2 text-right text-slate-300">{fmtCur(lastYearTotalTithe)}</td>
                                            <td className="px-3 py-2 text-right text-amber-400">{fmtCur(ytdTitheTotal)} (YTD)</td>
                                            <td className={`px-3 py-2 text-right ${ytdTitheTotal - lastYearSamePeriodTithe >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                {ytdTitheTotal - lastYearSamePeriodTithe >= 0 ? '+' : ''}{fmtCur(ytdTitheTotal - lastYearSamePeriodTithe)}
                                            </td>
                                            <td className={`px-3 py-2 text-right ${titheChangePercent >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                {titheChangePercent >= 0 ? '+' : ''}{titheChangePercent.toFixed(1)}%
                                            </td>
                                        </tr></tfoot>
                                    </table>
                                </div>
                            </div>

                            {/* Member Giving Analysis */}
                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
                                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                    <h3 className="text-sm font-semibold text-white mb-4">Member Giving Analysis</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="p-3 bg-blue-500/10 rounded-lg text-center">
                                            <p className="text-2xl font-bold text-blue-400">{memberStats.total}</p>
                                            <p className="text-xs text-slate-400">Active Givers</p>
                                        </div>
                                        <div className="p-3 bg-emerald-500/10 rounded-lg text-center">
                                            <p className="text-2xl font-bold text-emerald-400">{memberStats.newGivers}</p>
                                            <p className="text-xs text-slate-400">New This Year</p>
                                        </div>
                                        <div className="p-3 bg-amber-500/10 rounded-lg text-center">
                                            <p className="text-2xl font-bold text-amber-400">{memberStats.retained}</p>
                                            <p className="text-xs text-slate-400">Retained</p>
                                        </div>
                                        <div className="p-3 bg-red-500/10 rounded-lg text-center">
                                            <p className="text-2xl font-bold text-red-400">{memberStats.lapsed}</p>
                                            <p className="text-xs text-slate-400">Lapsed</p>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                    <h3 className="text-sm font-semibold text-emerald-400 mb-3">‚Üë Increasing Giving</h3>
                                    <div className="space-y-2">
                                        {givingChanges.increasing.length > 0 ? givingChanges.increasing.map((m, idx) => (
                                            <div key={idx} className="flex justify-between items-center text-sm">
                                                <span className="text-slate-300 truncate flex-1">{m.name}</span>
                                                <span className="text-emerald-400 font-medium">+{fmtCur(m.change)}</span>
                                            </div>
                                        )) : (
                                            <p className="text-xs text-slate-500">No significant increases</p>
                                        )}
                                    </div>
                                </div>

                                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                    <h3 className="text-sm font-semibold text-red-400 mb-3">‚Üì Decreasing Giving</h3>
                                    <div className="space-y-2">
                                        {givingChanges.decreasing.length > 0 ? givingChanges.decreasing.map((m, idx) => (
                                            <div key={idx} className="flex justify-between items-center text-sm">
                                                <span className="text-slate-300 truncate flex-1">{m.name}</span>
                                                <span className="text-red-400 font-medium">{fmtCur(m.change)}</span>
                                            </div>
                                        )) : (
                                            <p className="text-xs text-slate-500">No significant decreases</p>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </>
                    )}
                    {/* PROJECTION MODE */}
                    {viewMode === 'projection' && (
                        <>
                            {/* Year-End Projections */}
                            <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
                                <div className="bg-gradient-to-br from-amber-500/20 to-transparent rounded-xl border border-amber-500/30 p-4">
                                    <p className="text-xs text-slate-400">Projected Year-End Income</p>
                                    <p className="text-xl font-bold text-amber-400">{fmtCur(projectedYearEndIncome)}</p>
                                    <div className="flex items-center gap-1 mt-1">
                                        <span className={`text-xs ${incomeChangePercent >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                            {incomeChangePercent >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(incomeChangePercent).toFixed(1)}%
                                        </span>
                                        <span className="text-xs text-slate-500">vs 2025</span>
                                    </div>
                                </div>
                                <div className="bg-gradient-to-br from-red-500/20 to-transparent rounded-xl border border-red-500/30 p-4">
                                    <p className="text-xs text-slate-400">Projected Year-End Expenses</p>
                                    <p className="text-xl font-bold text-red-400">{fmtCur(projectedYearEndExpenses)}</p>
                                    <div className="flex items-center gap-1 mt-1">
                                        <span className={`text-xs ${expenseChangePercent <= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                            {expenseChangePercent >= 0 ? '‚Üë' : '‚Üì'} {Math.abs(expenseChangePercent).toFixed(1)}%
                                        </span>
                                        <span className="text-xs text-slate-500">vs 2025</span>
                                    </div>
                                </div>
                                <div className="bg-gradient-to-br from-emerald-500/20 to-transparent rounded-xl border border-emerald-500/30 p-4">
                                    <p className="text-xs text-slate-400">Projected Conference Funds</p>
                                    <p className="text-xl font-bold text-emerald-400">{fmtCur(projectedConferenceFund)}</p>
                                    <p className="text-xs text-slate-500 mt-1">Tithe + 40% offerings</p>
                                </div>
                                <div className={`bg-gradient-to-br ${projectedNetPosition >= 0 ? 'from-blue-500/20 border-blue-500/30' : 'from-red-500/20 border-red-500/30'} to-transparent rounded-xl border p-4`}>
                                    <p className="text-xs text-slate-400">Projected Net Position</p>
                                    <p className={`text-xl font-bold ${projectedNetPosition >= 0 ? 'text-blue-400' : 'text-red-400'}`}>{fmtCur(projectedNetPosition)}</p>
                                    <p className="text-xs text-slate-500 mt-1">{projectedNetPosition >= 0 ? 'Surplus' : 'Deficit'}</p>
                                </div>
                            </div>

                            {/* Charts Row */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                {/* 6-Month Cash Flow Projection */}
                                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                    <h3 className="text-sm font-semibold text-white mb-4">6-Month Cash Flow Projection (Based on 2025 Patterns)</h3>
                                    <div className="space-y-2">
                                        <div className="flex items-center justify-between text-xs text-slate-400 pb-2 border-b border-slate-700">
                                            <span>Current Balance:</span>
                                            <span className="font-bold text-white">{fmtCur(currentBalance)}</span>
                                        </div>
                                        {cashFlowProjection.map((proj, idx) => (
                                            <div key={idx} className="flex items-center gap-3">
                                                <span className="text-xs text-slate-400 w-8">{proj.month}</span>
                                                <div className="flex-1 h-6 bg-slate-700 rounded overflow-hidden relative">
                                                    <div 
                                                        className={`h-full ${proj.balance >= 0 ? 'bg-blue-500' : 'bg-red-500'} transition-all`} 
                                                        style={{ width: `${Math.min(Math.abs(proj.balance) / Math.max(...cashFlowProjection.map(p => Math.abs(p.balance)), 1) * 100, 100)}%` }}
                                                    ></div>
                                                </div>
                                                <span className={`text-xs font-medium w-24 text-right ${proj.balance >= 0 ? 'text-blue-400' : 'text-red-400'}`}>
                                                    {fmtCur(proj.balance)}
                                                </span>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="mt-3 pt-3 border-t border-slate-700 grid grid-cols-2 gap-2 text-xs">
                                        <div className="text-slate-400">Projected Inflow: <span className="text-emerald-400">{fmtCur(cashFlowProjection[0]?.inflow || 0)}</span></div>
                                        <div className="text-slate-400">Projected Outflow: <span className="text-red-400">{fmtCur(cashFlowProjection[0]?.outflow || 0)}</span></div>
                                    </div>
                                </div>

                                {/* Conference Remittance Planning */}
                                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                    <h3 className="text-sm font-semibold text-white mb-4">Conference Remittance Planning</h3>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="text-center p-3 bg-emerald-500/10 rounded-lg">
                                            <p className="text-xs text-slate-400">YTD Conference Funds</p>
                                            <p className="text-lg font-bold text-emerald-400">{fmtCur(ytdConferenceFund)}</p>
                                        </div>
                                        <div className="text-center p-3 bg-blue-500/10 rounded-lg">
                                            <p className="text-xs text-slate-400">Avg Monthly</p>
                                            <p className="text-lg font-bold text-blue-400">{fmtCur(ytdConferenceFund / monthsElapsed)}</p>
                                        </div>
                                        <div className="text-center p-3 bg-purple-500/10 rounded-lg">
                                            <p className="text-xs text-slate-400">Next Quarter Est.</p>
                                            <p className="text-lg font-bold text-purple-400">{fmtCur((ytdConferenceFund / monthsElapsed) * 3)}</p>
                                        </div>
                                        <div className="text-center p-3 bg-amber-500/10 rounded-lg">
                                            <p className="text-xs text-slate-400">Year-End Projection</p>
                                            <p className="text-lg font-bold text-amber-400">{fmtCur(projectedConferenceFund)}</p>
                                        </div>
                                    </div>
                                    <div className="mt-4 p-3 bg-slate-700/30 rounded-lg">
                                        <p className="text-xs text-slate-400">2025 Conference Funds: <span className="text-white font-medium">{fmtCur(HISTORICAL_DATA_2025.totals.conferenceFunds)}</span></p>
                                    </div>
                                </div>
                            </div>

                            {/* Monthly Breakdown Table */}
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                                <div className="p-3 border-b border-slate-700 bg-slate-800/50">
                                    <h3 className="text-sm font-semibold text-white">Monthly Performance: 2026 vs 2025</h3>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead><tr className="border-b border-slate-700 bg-slate-800/50">
                                            <th className="px-3 py-2 text-left text-slate-400">Month</th>
                                            <th className="px-3 py-2 text-right text-amber-400">2026 Income</th>
                                            <th className="px-3 py-2 text-right text-slate-500">2025 Income</th>
                                            <th className="px-3 py-2 text-right text-red-400">2026 Expenses</th>
                                            <th className="px-3 py-2 text-right text-slate-500">2025 Expenses</th>
                                            <th className="px-3 py-2 text-right text-blue-400">2026 Net</th>
                                        </tr></thead>
                                        <tbody>
                                            {months.map((month, idx) => {
                                                const income = idx <= currentMonth ? thisYearIncome[idx] : null;
                                                const expense = idx <= currentMonth ? thisYearExpenses[idx] : null;
                                                const net = income !== null ? income - expense : null;
                                                const lastIncome = lastYearIncome[idx];
                                                const lastExpense = lastYearExpenses[idx];
                                                
                                                return (
                                                    <tr key={month} className={`border-b border-slate-700/50 ${idx > currentMonth ? 'opacity-40' : ''}`}>
                                                        <td className="px-3 py-2 text-slate-300">{month}</td>
                                                        <td className="px-3 py-2 text-right text-amber-400">{income !== null ? fmtCur(income) : '-'}</td>
                                                        <td className="px-3 py-2 text-right text-slate-500">{fmtCur(lastIncome)}</td>
                                                        <td className="px-3 py-2 text-right text-red-400">{expense !== null ? fmtCur(expense) : '-'}</td>
                                                        <td className="px-3 py-2 text-right text-slate-500">{fmtCur(lastExpense)}</td>
                                                        <td className={`px-3 py-2 text-right font-medium ${net !== null ? (net >= 0 ? 'text-emerald-400' : 'text-red-400') : 'text-slate-500'}`}>
                                                            {net !== null ? fmtCur(net) : '-'}
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                        <tfoot><tr className="font-bold bg-slate-700/30">
                                            <td className="px-3 py-2 text-white">TOTALS</td>
                                            <td className="px-3 py-2 text-right text-amber-400">{fmtCur(ytdIncome)} (YTD)</td>
                                            <td className="px-3 py-2 text-right text-slate-400">{fmtCur(lastYearTotalIncome)}</td>
                                            <td className="px-3 py-2 text-right text-red-400">{fmtCur(ytdExpenses)} (YTD)</td>
                                            <td className="px-3 py-2 text-right text-slate-400">{fmtCur(lastYearTotalExpenses)}</td>
                                            <td className={`px-3 py-2 text-right ${(ytdIncome - ytdExpenses) >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>
                                                {fmtCur(ytdIncome - ytdExpenses)}
                                            </td>
                                        </tr></tfoot>
                                    </table>
                                </div>
                            </div>
                        </>
                    )}

                    {/* GIVING PATTERNS MODE */}
                    {viewMode === 'givingPatterns' && (() => {
                        // Calculate analytics for forecasting
                        const thisYearEntries = titheEntries.filter(e => new Date(e.date).getFullYear() === currentYear);
                        const lastYearEntries = titheEntries.filter(e => new Date(e.date).getFullYear() === lastYear);
                        
                        const totalTithe = thisYearEntries.reduce((s, e) => s + (parseFloat(e.tithe) || 0), 0);
                        const totalReceived = thisYearEntries.reduce((s, e) => s + (parseFloat(e.total_received) || 0), 0);
                        const totalOfferings = totalReceived - totalTithe;
                        const tithePercent = totalReceived > 0 ? (totalTithe / totalReceived * 100) : 0;
                        
                        // Member statistics
                        const memberStats = {};
                        thisYearEntries.forEach(e => {
                            if (!memberStats[e.name]) memberStats[e.name] = { tithe: 0, offerings: 0, total: 0, budgetCovenant: 0, entries: 0 };
                            memberStats[e.name].tithe += parseFloat(e.tithe) || 0;
                            memberStats[e.name].budgetCovenant += parseFloat(e.budget_covenant) || 0;
                            memberStats[e.name].total += parseFloat(e.total_received) || 0;
                            memberStats[e.name].entries += 1;
                        });
                        const memberList = Object.entries(memberStats).map(([name, data]) => ({ name, ...data })).sort((a, b) => b.total - a.total);
                        
                        const totalMembers = memberList.length;
                        const avgGiftPerMember = totalMembers > 0 ? totalReceived / totalMembers : 0;
                        const avgTithePerMember = totalMembers > 0 ? totalTithe / totalMembers : 0;
                        
                        // Top 10 analysis
                        const top10 = memberList.slice(0, 10);
                        const top10Total = top10.reduce((s, m) => s + m.total, 0);
                        const top10Percent = totalReceived > 0 ? (top10Total / totalReceived * 100) : 0;
                        
                        // Consistent vs Occasional
                        const consistentGivers = memberList.filter(m => m.entries >= 3).length;
                        const occasionalGivers = memberList.filter(m => m.entries < 3).length;
                        
                        // Budget Covenant participation
                        const budgetCovenantMembers = memberList.filter(m => m.budgetCovenant > 0).length;
                        const budgetCovenantParticipation = totalMembers > 0 ? (budgetCovenantMembers / totalMembers * 100) : 0;
                        
                        // Year over Year member comparison
                        const lastYearMemberSet = new Set(lastYearEntries.map(e => e.name));
                        const thisYearMemberSet = new Set(thisYearEntries.map(e => e.name));
                        const retainedMembers = memberList.filter(m => lastYearMemberSet.has(m.name)).length;
                        const newMembers = memberList.filter(m => !lastYearMemberSet.has(m.name)).length;
                        const lapsedMembers = [...lastYearMemberSet].filter(m => !thisYearMemberSet.has(m)).length;
                        
                        // Giving distribution
                        const givingBrackets = [
                            { label: '$0 - $100', min: 0, max: 100, count: 0, total: 0 },
                            { label: '$101 - $500', min: 101, max: 500, count: 0, total: 0 },
                            { label: '$501 - $1,000', min: 501, max: 1000, count: 0, total: 0 },
                            { label: '$1,001 - $5,000', min: 1001, max: 5000, count: 0, total: 0 },
                            { label: '$5,001+', min: 5001, max: Infinity, count: 0, total: 0 },
                        ];
                        memberList.forEach(m => {
                            const bracket = givingBrackets.find(b => m.total >= b.min && m.total <= b.max);
                            if (bracket) { bracket.count++; bracket.total += m.total; }
                        });
                        
                        // Monthly trends
                        const monthlyTrends = Array(12).fill(null).map((_, idx) => {
                            const monthEntries = thisYearEntries.filter(e => new Date(e.date).getMonth() === idx);
                            const tithe = monthEntries.reduce((s, e) => s + (parseFloat(e.tithe) || 0), 0);
                            const total = monthEntries.reduce((s, e) => s + (parseFloat(e.total_received) || 0), 0);
                            const members = new Set(monthEntries.map(e => e.name)).size;
                            return { month: months[idx], tithe, total, offerings: total - tithe, entries: monthEntries.length, members };
                        });
                        
                        // Projection based on patterns
                        const avgMonthlyGiving = totalReceived / (currentMonth + 1);
                        const projectedYearTotal = avgMonthlyGiving * 12;
                        const potentialFromOccasional = occasionalGivers * avgGiftPerMember * 0.5; // If occasional became consistent
                        const potentialFromBudgetCovenant = (totalMembers - budgetCovenantMembers) * 50 * 12; // If non-participants gave $50/month
                        
                        return (
                            <>
                                {/* Key Ratios for Planning */}
                                <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                    <div className="bg-amber-500/10 rounded-xl border border-amber-500/30 p-4">
                                        <p className="text-xs text-slate-400">Tithe % of Total</p>
                                        <p className="text-2xl font-bold text-amber-400">{tithePercent.toFixed(1)}%</p>
                                        <p className="text-xs text-slate-500">{fmtCur(totalTithe)} of {fmtCur(totalReceived)}</p>
                                    </div>
                                    <div className="bg-emerald-500/10 rounded-xl border border-emerald-500/30 p-4">
                                        <p className="text-xs text-slate-400">Active Givers ({currentYear})</p>
                                        <p className="text-2xl font-bold text-emerald-400">{totalMembers}</p>
                                        <p className="text-xs text-slate-500">Avg {fmtCur(avgGiftPerMember)}/member</p>
                                    </div>
                                    <div className="bg-cyan-500/10 rounded-xl border border-cyan-500/30 p-4">
                                        <p className="text-xs text-slate-400">Top 10 Concentration</p>
                                        <p className="text-2xl font-bold text-cyan-400">{top10Percent.toFixed(0)}%</p>
                                        <p className="text-xs text-slate-500">{fmtCur(top10Total)} from top 10</p>
                                    </div>
                                    <div className="bg-purple-500/10 rounded-xl border border-purple-500/30 p-4">
                                        <p className="text-xs text-slate-400">Budget Covenant Part.</p>
                                        <p className="text-2xl font-bold text-purple-400">{budgetCovenantParticipation.toFixed(0)}%</p>
                                        <p className="text-xs text-slate-500">{budgetCovenantMembers} of {totalMembers} members</p>
                                    </div>
                                </div>
                                
                                {/* Member Movement Analysis */}
                                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                    <h3 className="text-sm font-semibold text-white mb-4">Member Movement ({lastYear} ‚Üí {currentYear})</h3>
                                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                                        <div className="text-center p-3 bg-slate-700/30 rounded-lg">
                                            <p className="text-2xl font-bold text-white">{retainedMembers}</p>
                                            <p className="text-xs text-slate-400">Retained Givers</p>
                                        </div>
                                        <div className="text-center p-3 bg-emerald-500/10 rounded-lg border border-emerald-500/30">
                                            <p className="text-2xl font-bold text-emerald-400">+{newMembers}</p>
                                            <p className="text-xs text-slate-400">New Givers</p>
                                        </div>
                                        <div className="text-center p-3 bg-red-500/10 rounded-lg border border-red-500/30">
                                            <p className="text-2xl font-bold text-red-400">-{lapsedMembers}</p>
                                            <p className="text-xs text-slate-400">Lapsed Givers</p>
                                        </div>
                                        <div className="text-center p-3 bg-slate-700/30 rounded-lg">
                                            <p className="text-2xl font-bold text-cyan-400">{consistentGivers}</p>
                                            <p className="text-xs text-slate-400">Consistent (3+ entries)</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                    {/* Giving Distribution */}
                                    <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                        <h3 className="text-sm font-semibold text-emerald-400 mb-3">Giving Distribution</h3>
                                        {givingBrackets.map(b => {
                                            const pct = totalMembers > 0 ? (b.count / totalMembers * 100) : 0;
                                            const amtPct = totalReceived > 0 ? (b.total / totalReceived * 100) : 0;
                                            return (
                                                <div key={b.label} className="mb-3">
                                                    <div className="flex justify-between text-xs mb-1">
                                                        <span className="text-slate-400">{b.label}</span>
                                                        <span className="text-slate-300">{b.count} members ‚Ä¢ {fmtCur(b.total)} ({amtPct.toFixed(0)}%)</span>
                                                    </div>
                                                    <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                                                        <div className="h-full bg-emerald-500 rounded-full" style={{width: `${pct}%`}}></div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                    
                                    {/* Growth Opportunities */}
                                    <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                        <h3 className="text-sm font-semibold text-amber-400 mb-3">üí° Growth Opportunities</h3>
                                        <div className="space-y-3">
                                            <div className="p-3 bg-slate-700/30 rounded-lg">
                                                <p className="text-xs text-slate-400 mb-1">If occasional givers became consistent:</p>
                                                <p className="text-lg font-bold text-amber-400">+{fmtCur(potentialFromOccasional)}/year</p>
                                                <p className="text-xs text-slate-500">{occasionalGivers} occasional givers √ó 50% of avg gift</p>
                                            </div>
                                            <div className="p-3 bg-slate-700/30 rounded-lg">
                                                <p className="text-xs text-slate-400 mb-1">If non-participants joined Budget Covenant:</p>
                                                <p className="text-lg font-bold text-cyan-400">+{fmtCur(potentialFromBudgetCovenant)}/year</p>
                                                <p className="text-xs text-slate-500">{totalMembers - budgetCovenantMembers} members √ó $50/month</p>
                                            </div>
                                            <div className="p-3 bg-slate-700/30 rounded-lg">
                                                <p className="text-xs text-slate-400 mb-1">Re-engage lapsed givers:</p>
                                                <p className="text-lg font-bold text-emerald-400">+{fmtCur(lapsedMembers * avgGiftPerMember)}/year</p>
                                                <p className="text-xs text-slate-500">{lapsedMembers} lapsed √ó avg gift</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Monthly Trends Table */}
                                <div className="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                                    <div className="p-3 border-b border-slate-700 bg-slate-800/50">
                                        <h3 className="text-sm font-semibold text-cyan-400">Monthly Giving Patterns ({currentYear})</h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead>
                                                <tr className="border-b border-slate-700 bg-slate-800/30">
                                                    <th className="px-3 py-2 text-left text-slate-400">Month</th>
                                                    <th className="px-3 py-2 text-right text-slate-400">Tithe</th>
                                                    <th className="px-3 py-2 text-right text-slate-400">Offerings</th>
                                                    <th className="px-3 py-2 text-right text-slate-400">Total</th>
                                                    <th className="px-3 py-2 text-right text-slate-400">Entries</th>
                                                    <th className="px-3 py-2 text-right text-slate-400">Members</th>
                                                    <th className="px-3 py-2 text-right text-slate-400">Tithe %</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {monthlyTrends.map((m, idx) => {
                                                    const tithePct = m.total > 0 ? (m.tithe / m.total * 100) : 0;
                                                    const isFuture = idx > currentMonth;
                                                    return (
                                                        <tr key={m.month} className={`border-b border-slate-700/50 ${isFuture ? 'opacity-30' : ''}`}>
                                                            <td className="px-3 py-2 text-slate-300">{m.month}</td>
                                                            <td className="px-3 py-2 text-right text-amber-400">{isFuture ? '-' : fmtCur(m.tithe)}</td>
                                                            <td className="px-3 py-2 text-right text-emerald-400">{isFuture ? '-' : fmtCur(m.offerings)}</td>
                                                            <td className="px-3 py-2 text-right text-white font-medium">{isFuture ? '-' : fmtCur(m.total)}</td>
                                                            <td className="px-3 py-2 text-right text-slate-400">{isFuture ? '-' : m.entries}</td>
                                                            <td className="px-3 py-2 text-right text-slate-400">{isFuture ? '-' : m.members}</td>
                                                            <td className="px-3 py-2 text-right text-cyan-400">{isFuture ? '-' : `${tithePct.toFixed(1)}%`}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                            <tfoot>
                                                <tr className="font-bold bg-slate-700/30">
                                                    <td className="px-3 py-2 text-white">YTD TOTAL</td>
                                                    <td className="px-3 py-2 text-right text-amber-400">{fmtCur(totalTithe)}</td>
                                                    <td className="px-3 py-2 text-right text-emerald-400">{fmtCur(totalOfferings)}</td>
                                                    <td className="px-3 py-2 text-right text-white">{fmtCur(totalReceived)}</td>
                                                    <td className="px-3 py-2 text-right text-slate-400">{thisYearEntries.length}</td>
                                                    <td className="px-3 py-2 text-right text-slate-400">{totalMembers}</td>
                                                    <td className="px-3 py-2 text-right text-cyan-400">{tithePercent.toFixed(1)}%</td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                                
                                {/* Budget Covenant Analysis */}
                                <div className="bg-slate-800/50 rounded-xl border border-cyan-500/30 p-4">
                                    <h3 className="text-sm font-semibold text-cyan-400 mb-4">üí≥ Budget Covenant Analysis</h3>
                                    
                                    {(() => {
                                        // Calculate Budget Covenant specific stats
                                        const totalBudgetCovenant = memberList.reduce((s, m) => s + m.budgetCovenant, 0);
                                        const bcMembers = memberList.filter(m => m.budgetCovenant > 0).sort((a, b) => b.budgetCovenant - a.budgetCovenant);
                                        const avgBCPerMember = bcMembers.length > 0 ? totalBudgetCovenant / bcMembers.length : 0;
                                        const bcTop5 = bcMembers.slice(0, 5);
                                        const bcTop5Total = bcTop5.reduce((s, m) => s + m.budgetCovenant, 0);
                                        const bcTop5Percent = totalBudgetCovenant > 0 ? (bcTop5Total / totalBudgetCovenant * 100) : 0;
                                        
                                        // Monthly Budget Covenant trends
                                        const monthlyBC = Array(12).fill(null).map((_, idx) => {
                                            const monthEntries = thisYearEntries.filter(e => new Date(e.date).getMonth() === idx);
                                            const bc = monthEntries.reduce((s, e) => s + (parseFloat(e.budget_covenant) || 0), 0);
                                            const members = new Set(monthEntries.filter(e => (parseFloat(e.budget_covenant) || 0) > 0).map(e => e.name)).size;
                                            return { month: months[idx], amount: bc, members };
                                        });
                                        
                                        // BC giving brackets
                                        const bcBrackets = [
                                            { label: '$1 - $50', min: 1, max: 50, count: 0 },
                                            { label: '$51 - $100', min: 51, max: 100, count: 0 },
                                            { label: '$101 - $200', min: 101, max: 200, count: 0 },
                                            { label: '$201 - $500', min: 201, max: 500, count: 0 },
                                            { label: '$501+', min: 501, max: Infinity, count: 0 },
                                        ];
                                        bcMembers.forEach(m => {
                                            const bracket = bcBrackets.find(b => m.budgetCovenant >= b.min && m.budgetCovenant <= b.max);
                                            if (bracket) bracket.count++;
                                        });
                                        
                                        // 40%/60% calculation
                                        const fortyPercent = totalBudgetCovenant * 0.4;
                                        const sixtyPercent = totalBudgetCovenant * 0.6;
                                        
                                        return (
                                            <>
                                                {/* BC Summary Cards */}
                                                <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4">
                                                    <div className="bg-cyan-500/10 rounded-lg p-3 border border-cyan-500/20">
                                                        <p className="text-xs text-slate-400">Total Budget Covenant</p>
                                                        <p className="text-xl font-bold text-cyan-400">{fmtCur(totalBudgetCovenant)}</p>
                                                    </div>
                                                    <div className="bg-slate-700/30 rounded-lg p-3">
                                                        <p className="text-xs text-slate-400">Participating Members</p>
                                                        <p className="text-xl font-bold text-white">{bcMembers.length} <span className="text-sm text-slate-400">of {totalMembers}</span></p>
                                                    </div>
                                                    <div className="bg-slate-700/30 rounded-lg p-3">
                                                        <p className="text-xs text-slate-400">Avg per Participant</p>
                                                        <p className="text-xl font-bold text-white">{fmtCur(avgBCPerMember)}</p>
                                                    </div>
                                                    <div className="bg-slate-700/30 rounded-lg p-3">
                                                        <p className="text-xs text-slate-400">Participation Rate</p>
                                                        <p className="text-xl font-bold text-white">{budgetCovenantParticipation.toFixed(0)}%</p>
                                                    </div>
                                                </div>
                                                
                                                {/* 40/60 Split */}
                                                <div className="grid grid-cols-2 gap-3 mb-4">
                                                    <div className="bg-teal-500/10 rounded-lg p-3 border border-teal-500/20">
                                                        <p className="text-xs text-slate-400">40% to Conference</p>
                                                        <p className="text-lg font-bold text-teal-400">{fmtCur(fortyPercent)}</p>
                                                    </div>
                                                    <div className="bg-blue-500/10 rounded-lg p-3 border border-blue-500/20">
                                                        <p className="text-xs text-slate-400">60% Church Operating</p>
                                                        <p className="text-lg font-bold text-blue-400">{fmtCur(sixtyPercent)}</p>
                                                    </div>
                                                </div>
                                                
                                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                                    {/* Top BC Contributors */}
                                                    <div className="bg-slate-900/50 rounded-lg p-3">
                                                        <div className="flex justify-between items-center mb-2">
                                                            <h4 className="text-xs font-semibold text-cyan-400">Top Budget Covenant Contributors</h4>
                                                            <span className="text-xs text-slate-500">Top 5 = {bcTop5Percent.toFixed(0)}%</span>
                                                        </div>
                                                        {bcTop5.length > 0 ? bcTop5.map((m, idx) => (
                                                            <div key={m.name} className="flex items-center justify-between py-1.5 border-b border-slate-700/50">
                                                                <span className="text-sm text-slate-300 truncate flex-1">{idx + 1}. {m.name}</span>
                                                                <span className="text-sm text-cyan-400 font-medium">{fmtCur(m.budgetCovenant)}</span>
                                                            </div>
                                                        )) : (
                                                            <p className="text-slate-500 text-sm">No Budget Covenant contributions yet</p>
                                                        )}
                                                    </div>
                                                    
                                                    {/* BC Distribution */}
                                                    <div className="bg-slate-900/50 rounded-lg p-3">
                                                        <h4 className="text-xs font-semibold text-cyan-400 mb-2">Contribution Distribution</h4>
                                                        {bcBrackets.map(b => {
                                                            const pct = bcMembers.length > 0 ? (b.count / bcMembers.length * 100) : 0;
                                                            return (
                                                                <div key={b.label} className="mb-2">
                                                                    <div className="flex justify-between text-xs mb-1">
                                                                        <span className="text-slate-400">{b.label}</span>
                                                                        <span className="text-slate-300">{b.count} members</span>
                                                                    </div>
                                                                    <div className="h-1.5 bg-slate-700 rounded-full overflow-hidden">
                                                                        <div className="h-full bg-cyan-500 rounded-full" style={{width: `${pct}%`}}></div>
                                                                    </div>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                </div>
                                                
                                                {/* Monthly BC Trend */}
                                                <div className="mt-4 bg-slate-900/50 rounded-lg p-3">
                                                    <h4 className="text-xs font-semibold text-cyan-400 mb-2">Monthly Budget Covenant Trend</h4>
                                                    <div className="grid grid-cols-6 lg:grid-cols-12 gap-1">
                                                        {monthlyBC.map((m, idx) => {
                                                            const maxBC = Math.max(...monthlyBC.map(x => x.amount), 1);
                                                            const heightPct = (m.amount / maxBC * 100);
                                                            const isFuture = idx > currentMonth;
                                                            return (
                                                                <div key={m.month} className={`text-center ${isFuture ? 'opacity-30' : ''}`}>
                                                                    <div className="h-16 flex items-end justify-center mb-1">
                                                                        <div 
                                                                            className="w-full bg-cyan-500 rounded-t" 
                                                                            style={{height: `${isFuture ? 0 : heightPct}%`, minHeight: m.amount > 0 ? '4px' : '0'}}
                                                                            title={`${m.month}: ${fmtCur(m.amount)}`}
                                                                        ></div>
                                                                    </div>
                                                                    <p className="text-xs text-slate-500">{m.month}</p>
                                                                    <p className="text-xs text-slate-400">{isFuture ? '-' : m.members}</p>
                                                                </div>
                                                            );
                                                        })}
                                                    </div>
                                                    <p className="text-xs text-slate-500 mt-2 text-center">Members contributing per month</p>
                                                </div>
                                                
                                                {/* All BC Contributors Table */}
                                                {bcMembers.length > 0 && (
                                                    <div className="mt-4 bg-slate-900/50 rounded-lg overflow-hidden">
                                                        <div className="p-2 border-b border-slate-700 flex justify-between items-center">
                                                            <h4 className="text-xs font-semibold text-cyan-400">All Budget Covenant Contributors ({bcMembers.length})</h4>
                                                        </div>
                                                        <div className="max-h-48 overflow-y-auto">
                                                            <table className="w-full text-xs">
                                                                <thead className="sticky top-0 bg-slate-800">
                                                                    <tr className="border-b border-slate-700">
                                                                        <th className="px-2 py-1 text-left text-slate-400">#</th>
                                                                        <th className="px-2 py-1 text-left text-slate-400">Member</th>
                                                                        <th className="px-2 py-1 text-right text-slate-400">Budget Covenant</th>
                                                                        <th className="px-2 py-1 text-right text-slate-400">% of Total</th>
                                                                        <th className="px-2 py-1 text-right text-slate-400">Entries</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    {bcMembers.map((m, idx) => {
                                                                        const pct = totalBudgetCovenant > 0 ? (m.budgetCovenant / totalBudgetCovenant * 100) : 0;
                                                                        return (
                                                                            <tr key={m.name} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                                                <td className="px-2 py-1 text-slate-500">{idx + 1}</td>
                                                                                <td className="px-2 py-1 text-slate-300">{m.name}</td>
                                                                                <td className="px-2 py-1 text-right text-cyan-400 font-medium">{fmtCur(m.budgetCovenant)}</td>
                                                                                <td className="px-2 py-1 text-right text-slate-400">{pct.toFixed(1)}%</td>
                                                                                <td className="px-2 py-1 text-right text-slate-400">{m.entries}</td>
                                                                            </tr>
                                                                        );
                                                                    })}
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                )}
                                                
                                                {/* Non-Participants */}
                                                {memberList.filter(m => m.budgetCovenant === 0).length > 0 && (
                                                    <div className="mt-4 p-3 bg-amber-500/10 rounded-lg border border-amber-500/20">
                                                        <h4 className="text-xs font-semibold text-amber-400 mb-2">üìå Members Not Participating in Budget Covenant ({memberList.filter(m => m.budgetCovenant === 0).length})</h4>
                                                        <div className="flex flex-wrap gap-1">
                                                            {memberList.filter(m => m.budgetCovenant === 0).slice(0, 20).map(m => (
                                                                <span key={m.name} className="px-2 py-0.5 bg-slate-700/50 rounded text-xs text-slate-300">{m.name}</span>
                                                            ))}
                                                            {memberList.filter(m => m.budgetCovenant === 0).length > 20 && (
                                                                <span className="px-2 py-0.5 text-xs text-slate-500">+{memberList.filter(m => m.budgetCovenant === 0).length - 20} more</span>
                                                            )}
                                                        </div>
                                                        <p className="text-xs text-amber-400/80 mt-2">
                                                            Potential if all joined at avg rate: +{fmtCur(memberList.filter(m => m.budgetCovenant === 0).length * avgBCPerMember)}/year
                                                        </p>
                                                    </div>
                                                )}
                                            </>
                                        );
                                    })()}
                                </div>
                                
                                {/* Planning Insights */}
                                <div className="bg-gradient-to-r from-purple-500/10 to-blue-500/10 rounded-xl border border-purple-500/30 p-4">
                                    <h3 className="text-sm font-semibold text-purple-400 mb-3">üìã Planning Insights</h3>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                        <div className="space-y-2">
                                            <p className="text-slate-300">
                                                <span className="text-white font-medium">Projected year-end total:</span> {fmtCur(projectedYearTotal)}
                                            </p>
                                            <p className="text-slate-300">
                                                <span className="text-white font-medium">Average monthly giving:</span> {fmtCur(avgMonthlyGiving)}
                                            </p>
                                            {top10Percent > 50 && (
                                                <p className="text-amber-400">‚ö†Ô∏è High concentration risk - top 10 give {top10Percent.toFixed(0)}% of total</p>
                                            )}
                                            {budgetCovenantParticipation < 40 && (
                                                <p className="text-cyan-400">üìå Opportunity: Only {budgetCovenantParticipation.toFixed(0)}% participate in Budget Covenant</p>
                                            )}
                                        </div>
                                        <div className="space-y-2">
                                            {lapsedMembers > 5 && (
                                                <p className="text-amber-400">‚ö†Ô∏è {lapsedMembers} members from {lastYear} haven't given in {currentYear}</p>
                                            )}
                                            {newMembers > 0 && (
                                                <p className="text-emerald-400">‚úì {newMembers} new givers joined this year</p>
                                            )}
                                            {occasionalGivers > consistentGivers && (
                                                <p className="text-cyan-400">üìå {occasionalGivers} occasional givers could become regular with engagement</p>
                                            )}
                                            {tithePercent > 60 && (
                                                <p className="text-emerald-400">‚úì Strong tithe ratio at {tithePercent.toFixed(0)}%</p>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </>
                        );
                    })()}
                </div>
            );
        }

        // Bank Reconciliation Section Component
        function BankReconciliationSection({ expenses, deposits }) {
            const [reconciliationDate, setReconciliationDate] = useState(new Date().toISOString().split('T')[0]);
            const [bankStatementBalance, setBankStatementBalance] = useState('');
            const [depositsInTransit, setDepositsInTransit] = useState('');
            const [outstandingChecks, setOutstandingChecks] = useState('');
            const [bookBalance, setBookBalance] = useState('');
            const [bankCharges, setBankCharges] = useState('');
            const [interestEarned, setInterestEarned] = useState('');
            const [otherAdjustments, setOtherAdjustments] = useState('');

            // Bank Balance calculations
            const bankStmtBal = parseFloat(bankStatementBalance) || 0;
            const depInTransit = parseFloat(depositsInTransit) || 0;
            const outChecks = parseFloat(outstandingChecks) || 0;
            const adjustedBankBalance = bankStmtBal + depInTransit - outChecks;
            
            // Book Balance calculations
            const bookBal = parseFloat(bookBalance) || 0;
            const bankChg = parseFloat(bankCharges) || 0;
            const intEarned = parseFloat(interestEarned) || 0;
            const otherAdj = parseFloat(otherAdjustments) || 0;
            const adjustedBookBalance = bookBal - bankChg + intEarned + otherAdj;
            
            const difference = adjustedBankBalance - adjustedBookBalance;

            const exportBankReconciliation = () => {
                try {
                    const data = [
                        ['BANK RECONCILIATION'],
                        [`As at: ${reconciliationDate}`],
                        [],
                        ['BANK BALANCES', '', '', 'BOOK BALANCE', ''],
                        [],
                        ['Bank Statement Balance', bankStmtBal, '', 'Book Balance', bookBal],
                        ['', '', '', 'Less: Bank Charges', -bankChg],
                        ['', '', '', 'Add: Interest Earned', intEarned],
                        ['', '', '', 'Other Adjustments', otherAdj],
                        [],
                        ['Add: Deposits in Transit', depInTransit],
                        ['Less: Outstanding Checks', -outChecks],
                        [],
                        ['Adjusted Bank Balance', adjustedBankBalance, '', 'Adjusted Book Balance', adjustedBookBalance],
                        [],
                        ['DIFFERENCE', difference],
                        [],
                        [Math.abs(difference) < 0.01 ? 'STATUS: RECONCILED' : 'STATUS: NOT RECONCILED']
                    ];
                    
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!cols'] = [{wch: 28}, {wch: 15}, {wch: 5}, {wch: 25}, {wch: 15}];
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Bank Reconciliation');
                    XLSX.writeFile(wb, `Bank_Reconciliation_${reconciliationDate}.xlsx`);
                } catch (err) {
                    console.error('Export error:', err);
                    alert('Export error: ' + err.message);
                }
            };

            return (
                <div className="space-y-4">
                    {/* Header with Date and Export */}
                    <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                        <div className="flex flex-wrap gap-4 items-end justify-between">
                            <div>
                                <label className="text-xs text-slate-400 block mb-1">Reconciliation Date</label>
                                <input type="date" value={reconciliationDate} onChange={e => setReconciliationDate(e.target.value)} className="px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm" />
                            </div>
                            <button onClick={exportBankReconciliation} className="px-4 py-2 bg-amber-600 text-white rounded-lg text-sm font-medium hover:bg-amber-500">üì• Export to Excel</button>
                        </div>
                    </div>

                    {/* Two Column Layout */}
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                        {/* Bank Balance Side */}
                        <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                            <h3 className="text-lg font-semibold text-amber-400 mb-4 text-center border-b border-slate-700 pb-2">BANK BALANCES</h3>
                            <div className="space-y-3">
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Bank Statement Balance</label>
                                    <input type="number" step="0.01" value={bankStatementBalance} onChange={e => setBankStatementBalance(e.target.value)} placeholder="0.00" className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-right" />
                                </div>
                                <div className="border-t border-slate-700 pt-3">
                                    <div>
                                        <label className="text-xs text-slate-400 block mb-1">Add: Deposits in Transit</label>
                                        <input type="number" step="0.01" value={depositsInTransit} onChange={e => setDepositsInTransit(e.target.value)} placeholder="0.00" className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-right" />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Less: Outstanding Checks</label>
                                    <input type="number" step="0.01" value={outstandingChecks} onChange={e => setOutstandingChecks(e.target.value)} placeholder="0.00" className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-right" />
                                </div>
                                <div className="pt-3 border-t border-slate-700">
                                    <div className="flex justify-between items-center p-3 bg-amber-500/20 rounded-lg">
                                        <span className="text-amber-400 font-semibold">Adjusted Bank Balance</span>
                                        <span className="text-xl font-bold text-amber-400">{fmtCur(adjustedBankBalance)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        {/* Book Balance Side */}
                        <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                            <h3 className="text-lg font-semibold text-blue-400 mb-4 text-center border-b border-slate-700 pb-2">BOOK BALANCE</h3>
                            <div className="space-y-3">
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Book Balance</label>
                                    <input type="number" step="0.01" value={bookBalance} onChange={e => setBookBalance(e.target.value)} placeholder="0.00" className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-right" />
                                </div>
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Less: Bank Charges</label>
                                    <input type="number" step="0.01" value={bankCharges} onChange={e => setBankCharges(e.target.value)} placeholder="0.00" className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-right" />
                                </div>
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Add: Interest Earned</label>
                                    <input type="number" step="0.01" value={interestEarned} onChange={e => setInterestEarned(e.target.value)} placeholder="0.00" className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-right" />
                                </div>
                                <div>
                                    <label className="text-xs text-slate-400 block mb-1">Other Adjustments (+/-)</label>
                                    <input type="number" step="0.01" value={otherAdjustments} onChange={e => setOtherAdjustments(e.target.value)} placeholder="0.00" className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-right" />
                                </div>
                                <div className="pt-3 border-t border-slate-700">
                                    <div className="flex justify-between items-center p-3 bg-blue-500/20 rounded-lg">
                                        <span className="text-blue-400 font-semibold">Adjusted Book Balance</span>
                                        <span className="text-xl font-bold text-blue-400">{fmtCur(adjustedBookBalance)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Difference / Status */}
                    <div className={`p-4 rounded-xl border ${Math.abs(difference) < 0.01 ? 'bg-emerald-500/20 border-emerald-500/30' : 'bg-red-500/20 border-red-500/30'}`}>
                        <div className="flex justify-between items-center">
                            <span className={`text-lg font-semibold ${Math.abs(difference) < 0.01 ? 'text-emerald-400' : 'text-red-400'}`}>
                                {Math.abs(difference) < 0.01 ? '‚úì RECONCILED' : '‚ö† DIFFERENCE'}
                            </span>
                            <span className={`text-2xl font-bold ${Math.abs(difference) < 0.01 ? 'text-emerald-400' : 'text-red-400'}`}>{fmtCur(difference)}</span>
                        </div>
                    </div>
                </div>
            );
        }

        // Reports Section Component
        function ReportsSection({ titheEntries, expenses, deposits, projects, settings }) {
            const [startDate, setStartDate] = useState(new Date(new Date().getFullYear(), 0, 1).toISOString().split('T')[0]);
            const [endDate, setEndDate] = useState(new Date().toISOString().split('T')[0]);
            const [memberFilter, setMemberFilter] = useState('');
            const [reportType, setReportType] = useState('summary');
            const [selectedMemberDetail, setSelectedMemberDetail] = useState(null);
            
            // Deed of Covenant state
            const [covenantYear, setCovenantYear] = useState(new Date().getFullYear());
            const [selectedCovenantMembers, setSelectedCovenantMembers] = useState([]);
            const [covenantPastor, setCovenantPastor] = useState('');
            const [covenantTreasurer, setCovenantTreasurer] = useState('');

            // Filter entries by date range and sort by date then slip number
            const filteredTithes = titheEntries.filter(e => {
                const matchDate = e.date >= startDate && e.date <= endDate;
                const matchMember = !memberFilter || e.name.toLowerCase().includes(memberFilter.toLowerCase());
                return matchDate && matchMember;
            }).sort((a, b) => {
                // Sort by date first, then by slip number ascending
                if (a.date !== b.date) {
                    return a.date.localeCompare(b.date);
                }
                return (parseInt(a.slip_number) || 0) - (parseInt(b.slip_number) || 0);
            });

            const filteredExpenses = expenses.filter(e => e.date >= startDate && e.date <= endDate);
            
            // Derive deposits from tithe entries (grouped by date)
            const depMap = {};
            filteredTithes.forEach(e => {
                if (!depMap[e.date]) depMap[e.date] = 0;
                depMap[e.date] += parseFloat(e.total_received) || 0;
            });
            const filteredDeposits = Object.entries(depMap).map(([date, total]) => ({ date, description: 'Tithe Collection', total })).sort((a, b) => a.date.localeCompare(b.date));

            // Get unique members
            const uniqueMembers = [...new Set(titheEntries.map(e => e.name))].sort();

            // Calculate totals for filtered data
            const filteredTotals = calculateTitheTotals(filteredTithes, filteredExpenses);
            const filteredExpenseTotal = filteredExpenses.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
            const filteredDepositTotal = filteredDeposits.reduce((s, d) => s + (parseFloat(d.total) || 0), 0);

            // Toggle member selection for Deed of Covenant
            const toggleCovenantMember = (member) => {
                setSelectedCovenantMembers(prev => 
                    prev.includes(member) 
                        ? prev.filter(m => m !== member)
                        : [...prev, member]
                );
            };

            // Export Deed of Covenant
            const exportDeedOfCovenant = () => {
                try {
                    if (selectedCovenantMembers.length === 0) {
                        alert('Please select at least one member');
                        return;
                    }
                    
                    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                    
                    // Build data for each selected member
                    const memberRows = selectedCovenantMembers.map((member, idx) => {
                        const memberEntries = titheEntries.filter(e => 
                            e.name === member && 
                            new Date(e.date).getFullYear() === covenantYear
                        );
                        
                        // Sum total_received by month
                        const monthlyTotals = Array(12).fill(0);
                        memberEntries.forEach(entry => {
                            const month = new Date(entry.date).getMonth();
                            monthlyTotals[month] += parseFloat(entry.total_received) || 0;
                        });
                        
                        const total = monthlyTotals.reduce((s, v) => s + v, 0);
                        
                        return [
                            idx + 1,
                            member,
                            ...monthlyTotals.map(v => v || ''),
                            total
                        ];
                    });
                    
                    const data = [
                        [`Deed of Covenant period ${covenantYear}`],
                        ['Name of Church:', 'Diego Martin SDA Church'],
                        ['Pastor:', covenantPastor || ''],
                        ['Treasurer:', covenantTreasurer || ''],
                        [],
                        ['NO', 'Name', ...months, 'TOTAL'],
                        ...memberRows
                    ];
                    
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!cols'] = [
                        {wch: 5}, {wch: 25}, 
                        ...months.map(() => ({wch: 8})),
                        {wch: 10}
                    ];
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Deed of Covenant');
                    XLSX.writeFile(wb, `Deed_of_Covenant_${covenantYear}.xlsx`);
                } catch (err) {
                    console.error('Export error:', err);
                    alert('Export error: ' + err.message);
                }
            };

            // Export functions
            const exportTithesReport = () => {
                try {
                    // Match the exact format from treasurer_book_dec.xlsx
                    const headers = [
                        'Date', 'Slip #', 'Name', "Total Rec'd", 
                        'Tithe', 'Special Offering', 'Ingathering', '3ABN/Radio', 'Nehemiah', 'Sabbath School', 'Total Conf Fund',
                        'Budget Covenant', 'Welfare', 'Church Building Fund', 'School', "Children's Home", 'Refunds', 'Choir', 'Special Projects', 'Church Project', 'Messages of Hope', 'Total Church Funds'
                    ];
                    const data = filteredTithes.map(e => [
                        e.date, 
                        e.slip_number || '', 
                        e.name,
                        parseFloat(e.total_received) || 0,
                        parseFloat(e.tithe) || '',
                        parseFloat(e.special_offering) || '',
                        parseFloat(e.ingathering) || '',
                        parseFloat(e.radio) || '',
                        parseFloat(e.nehemiah) || '',
                        parseFloat(e.sabbath_school) || '',
                        parseFloat(e.total_conf_fund) || 0,
                        parseFloat(e.budget_covenant) || '',
                        parseFloat(e.welfare) || '',
                        parseFloat(e.project) || '',
                        parseFloat(e.school) || '',
                        parseFloat(e.pos_band) || '',
                        parseFloat(e.books) || '',
                        parseFloat(e.raffa_house) || '',
                        parseFloat(e.tv) || '',
                        parseFloat(e.government_fund) || '',
                        parseFloat(e.messages_of_hope) || '',
                        parseFloat(e.total_church_fund) || 0
                    ]);
                    
                    // Sum totals row
                    const totalsRow = [
                        'TOTALS', '', '', 
                        filteredTotals.totalReceived,
                        filteredTotals.tithe || 0,
                        filteredTotals.special_offering || 0,
                        filteredTotals.ingathering || 0,
                        filteredTotals.radio || 0,
                        filteredTotals.nehemiah || 0,
                        filteredTotals.sabbath_school || 0,
                        filteredTotals.totalConfFund,
                        filteredTotals.budget_covenant || 0,
                        filteredTotals.welfare || 0,
                        filteredTotals.project || 0,
                        filteredTotals.school || 0,
                        filteredTotals.pos_band || 0,
                        filteredTotals.books || 0,
                        filteredTotals.raffa_house || 0,
                        filteredTotals.tv || 0,
                        filteredTotals.government_fund || 0,
                        filteredTotals.messages_of_hope || 0,
                        filteredTotals.totalChurchFund
                    ];
                    
                    // Conference fund calculations (40% is on Budget Covenant minus School, Children's Home, and Wesport)
                    const subTotalConfFunds = filteredTotals.totalConfFund;
                    const percentage40 = filteredTotals.percentage40;
                    const grandTotalConference = filteredTotals.grandTotalConference;
                    
                    // Empty row for spacing
                    const emptyRow = Array(22).fill('');
                    
                    // Conference summary rows with 40%/60% breakdown
                    const subTotalRow = ['', '', 'Sub Total Conference Funds', '', '', '', '', '', '', '', subTotalConfFunds, '', '', '', '', '', '', '', '', '', '', ''];
                    const breakdownHeaderRow = ['', '', '40% Calculation Breakdown:', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''];
                    const budgetCovenantRow = ['', '', '  Budget Covenant', '', '', '', '', '', '', '', filteredTotals.budget_covenant || 0, '', '', '', '', '', '', '', '', '', '', ''];
                    const lessSchoolRow = ['', '', '  Less: Contribution to School (Tithe)', '', '', '', '', '', '', '', -(filteredTotals.school || 0), '', '', '', '', '', '', '', '', '', '', ''];
                    const lessChildrensHomeRow = ['', '', "  Less: Contribution to Children's Home", '', '', '', '', '', '', '', -(filteredTotals.pos_band || 0), '', '', '', '', '', '', '', '', '', '', ''];
                    const lessWesportRow = ['', '', '  Less: School - Wesport (Expenses)', '', '', '', '', '', '', '', -(filteredTotals.wesportExpenses || 0), '', '', '', '', '', '', '', '', '', '', ''];
                    const netAmountRow = ['', '', '  Net Amount for 40%/60%', '', '', '', '', '', '', '', filteredTotals.baseFor40_60 || 0, '', '', '', '', '', '', '', '', '', '', ''];
                    const percentage40Row = ['', '', '40% of Net Amount (to Conference)', '', '', '', '', '', '', percentage40, '', '', '', '', '', '', '', '', '', '', '', ''];
                    const percentage60Row = ['', '', '60% Church Operating Income', '', '', '', '', '', '', '', filteredTotals.churchOperating, '', '', '', '', '', '', '', '', '', '', ''];
                    const grandTotalRow = ['', '', 'Grand Total To Conference Treasurer', '', '', '', '', '', '', grandTotalConference, '', '', '', '', '', '', '', '', '', '', '', ''];
                    
                    const ws = XLSX.utils.aoa_to_sheet([
                        headers, 
                        ...data, 
                        totalsRow,
                        emptyRow,
                        subTotalRow,
                        emptyRow,
                        breakdownHeaderRow,
                        budgetCovenantRow,
                        lessSchoolRow,
                        lessChildrensHomeRow,
                        lessWesportRow,
                        netAmountRow,
                        percentage40Row,
                        percentage60Row,
                        emptyRow,
                        grandTotalRow
                    ]);
                    
                    // Set column widths
                    ws['!cols'] = [
                        {wch: 12}, {wch: 6}, {wch: 30}, {wch: 12},
                        {wch: 10}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 10},
                        {wch: 15}, {wch: 15}, {wch: 12}, {wch: 10}, {wch: 18}, {wch: 10}, {wch: 14}, {wch: 10}, {wch: 10}, {wch: 14}, {wch: 14}, {wch: 16}, {wch: 16}
                    ];
                    
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Treasurer Book');
                    XLSX.writeFile(wb, `Treasurer_Book_${startDate}_to_${endDate}.xlsx`);
                } catch (err) {
                    console.error('Export error:', err);
                    alert('Export error: ' + err.message);
                }
            };

            // Export Conference Funds Report
            const exportConferenceFundsReport = () => {
                try {
                    const data = [
                        ['CONFERENCE FUNDS REPORT'],
                        [`Period: ${startDate} to ${endDate}`],
                        [],
                        ['CONFERENCE FUNDS BREAKDOWN'],
                        ['Category', 'Amount'],
                        ...CONFERENCE_FIELDS.map(f => [f.label, filteredTotals[f.key] || 0]),
                        [],
                        ['Sub Total Conference Funds', filteredTotals.totalConfFund],
                        [],
                        ['40% CALCULATION BREAKDOWN'],
                        ['Budget Covenant', filteredTotals.budget_covenant || 0],
                        ['Less: Contribution to School (Tithe)', -(filteredTotals.school || 0)],
                        ["Less: Contribution to Children's Home", -(filteredTotals.pos_band || 0)],
                        ['Less: School - Wesport (Expenses)', -(filteredTotals.wesportExpenses || 0)],
                        ['Net Amount for 40%/60%', filteredTotals.baseFor40_60 || 0],
                        [],
                        ['40% of Net Amount', filteredTotals.percentage40],
                        [],
                        ['GRAND TOTAL TO CONFERENCE', filteredTotals.grandTotalConference],
                    ];
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!cols'] = [{wch: 40}, {wch: 15}];
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Conference Funds');
                    XLSX.writeFile(wb, `Conference_Funds_${startDate}_to_${endDate}.xlsx`);
                } catch (err) {
                    console.error('Export error:', err);
                    alert('Export error: ' + err.message);
                }
            };

            // Export Church Operating Income Report
            const exportChurchOperatingReport = () => {
                try {
                    const data = [
                        ['CHURCH OPERATING INCOME REPORT'],
                        [`Period: ${startDate} to ${endDate}`],
                        [],
                        ['CHURCH FUNDS BREAKDOWN'],
                        ['Category', 'Amount'],
                        ...CHURCH_FIELDS.map(f => [f.label, filteredTotals[f.key] || 0]),
                        [],
                        ['Total Church Funds', filteredTotals.totalChurchFund],
                        [],
                        ['60% CALCULATION BREAKDOWN'],
                        ['Budget Covenant', filteredTotals.budget_covenant || 0],
                        ['Less: Contribution to School (Tithe)', -(filteredTotals.school || 0)],
                        ["Less: Contribution to Children's Home", -(filteredTotals.pos_band || 0)],
                        ['Less: School - Wesport (Expenses)', -(filteredTotals.wesportExpenses || 0)],
                        ['Net Amount for 40%/60%', filteredTotals.baseFor40_60 || 0],
                        [],
                        ['60% CHURCH OPERATING INCOME', filteredTotals.churchOperating],
                    ];
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!cols'] = [{wch: 40}, {wch: 15}];
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Church Operating');
                    XLSX.writeFile(wb, `Church_Operating_${startDate}_to_${endDate}.xlsx`);
                } catch (err) {
                    console.error('Export error:', err);
                    alert('Export error: ' + err.message);
                }
            };

            const exportMemberReport = () => {
                try {
                    const memberData = uniqueMembers.map(name => {
                        const memberEntries = filteredTithes.filter(e => e.name === name);
                        const memberTotals = calculateTitheTotals(memberEntries);
                        return [name, memberEntries.length, memberTotals.tithe || 0, memberTotals.budget_covenant || 0, memberTotals.totalReceived, memberTotals.totalConfFund, memberTotals.totalChurchFund];
                    });
                    const headers = ['Member Name', 'Entries', 'Total Tithe', 'Budget Covenant', 'Total Received', 'Conf Fund', 'Church Fund'];
                    const ws = XLSX.utils.aoa_to_sheet([headers, ...memberData]);
                    ws['!cols'] = [{wch: 25}, {wch: 10}, {wch: 15}, {wch: 18}, {wch: 15}, {wch: 12}, {wch: 12}];
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Member Report');
                    XLSX.writeFile(wb, `Member_Report_${startDate}_to_${endDate}.xlsx`);
                } catch (err) {
                    console.error('Export error:', err);
                    alert('Export error: ' + err.message);
                }
            };

            const exportExpensesReport = () => {
                try {
                    const headers = ['Date', 'Description', 'Category', 'Department', 'Cheque #', 'Voucher #', 'Amount', 'Entered By'];
                    const data = filteredExpenses.map(e => [e.date, e.description, e.category || '', e.department || '', e.cheque_number || '', e.voucher_number || '', parseFloat(e.amount) || 0, e.created_by_email || '']);
                    const ws = XLSX.utils.aoa_to_sheet([headers, ...data]);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Expenses Report');
                    XLSX.writeFile(wb, `Expenses_Report_${startDate}_to_${endDate}.xlsx`);
                } catch (err) {
                    console.error('Export error:', err);
                    alert('Export error: ' + err.message);
                }
            };

            // Calculate project financials - supports both old project_id and new project_links
            const getProjectFinancials = (projectId) => {
                const project = (projects || []).find(p => p.id === projectId);
                const openingBalance = parseFloat(project?.opening_balance) || 0;
                
                // Calculate income from tithe entries
                let income = 0;
                titheEntries.forEach(t => {
                    // Support old project_id field (backward compatibility)
                    if (t.project_id === projectId) {
                        income += (parseFloat(t.project) || 0) + (parseFloat(t.government_fund) || 0);
                    }
                    
                    // Support new project_links JSON field
                    if (t.project_links) {
                        try {
                            const links = typeof t.project_links === 'string' ? JSON.parse(t.project_links) : t.project_links;
                            Object.entries(links).forEach(([fieldKey, linkedProjectId]) => {
                                if (linkedProjectId === projectId) {
                                    income += parseFloat(t[fieldKey]) || 0;
                                }
                            });
                        } catch (e) { /* ignore parse errors */ }
                    }
                });
                
                const spent = expenses
                    .filter(e => e.project_id === projectId)
                    .reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
                const totalIncome = openingBalance + income;
                return { openingBalance, income, totalIncome, spent, balance: totalIncome - spent };
            };

            // Get tithe entries linked to a project (for display/export)
            const getProjectTithes = (projectId) => {
                return titheEntries.filter(t => {
                    if (t.project_id === projectId) return true;
                    if (t.project_links) {
                        try {
                            const links = typeof t.project_links === 'string' ? JSON.parse(t.project_links) : t.project_links;
                            return Object.values(links).includes(projectId);
                        } catch (e) { return false; }
                    }
                    return false;
                });
            };

            const exportProjectsReport = () => {
                try {
                    const allProjects = projects || [];
                    
                    // Summary sheet data
                    const summaryHeaders = ['Project Name', 'Status', 'Target Amount', 'Opening Bal', 'New Income', 'Total Income', 'Expenses', 'Balance', 'Progress %'];
                    const summaryData = allProjects.map(p => {
                        const financials = getProjectFinancials(p.id);
                        const progress = p.target_amount ? ((financials.totalIncome / p.target_amount) * 100).toFixed(1) : 'N/A';
                        return [
                            p.name,
                            p.status || 'Active',
                            parseFloat(p.target_amount) || 0,
                            financials.openingBalance,
                            financials.income,
                            financials.totalIncome,
                            financials.spent,
                            financials.balance,
                            progress
                        ];
                    });
                    
                    // Calculate totals
                    const totalTarget = allProjects.reduce((s, p) => s + (parseFloat(p.target_amount) || 0), 0);
                    const totalOpening = allProjects.reduce((s, p) => s + getProjectFinancials(p.id).openingBalance, 0);
                    const totalNewIncome = allProjects.reduce((s, p) => s + getProjectFinancials(p.id).income, 0);
                    const totalIncome = allProjects.reduce((s, p) => s + getProjectFinancials(p.id).totalIncome, 0);
                    const totalSpent = allProjects.reduce((s, p) => s + getProjectFinancials(p.id).spent, 0);
                    
                    summaryData.push([]);
                    summaryData.push(['TOTALS', '', totalTarget, totalOpening, totalNewIncome, totalIncome, totalSpent, totalIncome - totalSpent, '']);
                    
                    const ws = XLSX.utils.aoa_to_sheet([summaryHeaders, ...summaryData]);
                    ws['!cols'] = [{wch: 25}, {wch: 12}, {wch: 15}, {wch: 12}, {wch: 12}, {wch: 15}, {wch: 12}, {wch: 15}, {wch: 12}];
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, 'Projects Summary');
                    
                    // Add detail sheet for each project
                    allProjects.forEach(project => {
                        const financials = getProjectFinancials(project.id);
                        const projectTithes = getProjectTithes(project.id);
                        const projectExpenses = expenses.filter(e => e.project_id === project.id);
                        
                        // Calculate amount for each tithe entry linked to this project
                        const getTitheAmount = (t) => {
                            let amount = 0;
                            // Old project_id method
                            if (t.project_id === project.id) {
                                amount += (parseFloat(t.project) || 0) + (parseFloat(t.government_fund) || 0);
                            }
                            // New project_links method
                            if (t.project_links) {
                                try {
                                    const links = typeof t.project_links === 'string' ? JSON.parse(t.project_links) : t.project_links;
                                    Object.entries(links).forEach(([fieldKey, linkedProjectId]) => {
                                        if (linkedProjectId === project.id) {
                                            amount += parseFloat(t[fieldKey]) || 0;
                                        }
                                    });
                                } catch (e) {}
                            }
                            return amount;
                        };
                        
                        const detailData = [
                            ['PROJECT: ' + project.name],
                            ['Status: ' + (project.status || 'Active')],
                            ['Target: ' + fmtCur(project.target_amount || 0)],
                            [],
                            ['INCOME'],
                            ['Date', 'Member', 'Amount'],
                            ...projectTithes.map(t => [t.date, t.name, getTitheAmount(t)]),
                            ['', 'Total Income:', financials.income],
                            [],
                            ['EXPENSES'],
                            ['Date', 'Description', 'Amount'],
                            ...projectExpenses.map(e => [e.date, e.description, parseFloat(e.amount) || 0]),
                            ['', 'Total Expenses:', financials.spent],
                            [],
                            ['', 'BALANCE:', financials.balance]
                        ];
                        
                        const detailWs = XLSX.utils.aoa_to_sheet(detailData);
                        detailWs['!cols'] = [{wch: 12}, {wch: 30}, {wch: 15}];
                        const sheetName = project.name.substring(0, 25).replace(/[\\/*?[\]]/g, '');
                        XLSX.utils.book_append_sheet(wb, detailWs, sheetName);
                    });
                    
                    XLSX.writeFile(wb, `Projects_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
                } catch (err) {
                    console.error('Export error:', err);
                    alert('Export error: ' + err.message);
                }
            };

            return (
                <div className="space-y-4">
                    {/* Filters */}
                    <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                        <h3 className="text-sm font-semibold text-amber-400 mb-3">Report Filters</h3>
                        <div className="flex flex-wrap gap-3 items-end">
                            <div>
                                <label className="text-xs text-slate-400 block mb-1">Start Date</label>
                                <input type="date" value={startDate} onChange={e => setStartDate(e.target.value)} className="px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm" />
                            </div>
                            <div>
                                <label className="text-xs text-slate-400 block mb-1">End Date</label>
                                <input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} className="px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm" />
                            </div>
                            <div>
                                <label className="text-xs text-slate-400 block mb-1">Member Filter</label>
                                <select value={memberFilter} onChange={e => setMemberFilter(e.target.value)} className="px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm min-w-[150px]">
                                    <option value="">All Members</option>
                                    {uniqueMembers.map(name => <option key={name} value={name}>{name}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="text-xs text-slate-400 block mb-1">Report Type</label>
                                <select value={reportType} onChange={e => setReportType(e.target.value)} className="px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm">
                                    <option value="summary">Summary</option>
                                    <option value="givingAnalytics">üìä Giving Analytics</option>
                                    <option value="conferenceFunds">Conference Funds</option>
                                    <option value="churchOperating">Church Operating Income</option>
                                    <option value="fundDistribution">Fund Distribution</option>
                                    <option value="tithes">Tithes Detail</option>
                                    <option value="members">By Member</option>
                                    <option value="expenses">Expenses</option>
                                    <option value="projects">Projects</option>
                                    <option value="deedOfCovenant">Deed of Covenant</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    {/* Export Buttons */}
                    <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                        <h3 className="text-sm font-semibold text-emerald-400 mb-3">Export Reports to Excel</h3>
                        <div className="flex flex-wrap gap-2">
                            <button onClick={exportTithesReport} className="px-4 py-2 bg-emerald-600 text-white rounded-lg text-sm hover:bg-emerald-500">üì• Treasurer Book</button>
                            <button onClick={exportConferenceFundsReport} className="px-4 py-2 bg-teal-600 text-white rounded-lg text-sm hover:bg-teal-500">üì• Conference Funds</button>
                            <button onClick={exportChurchOperatingReport} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-500">üì• Church Operating</button>
                            <button onClick={exportMemberReport} className="px-4 py-2 bg-indigo-600 text-white rounded-lg text-sm hover:bg-indigo-500">üì• Member Summary</button>
                            <button onClick={exportExpensesReport} className="px-4 py-2 bg-red-600 text-white rounded-lg text-sm hover:bg-red-500">üì• Expenses Report</button>
                            <button onClick={exportProjectsReport} className="px-4 py-2 bg-cyan-600 text-white rounded-lg text-sm hover:bg-cyan-500">üì• Projects Report</button>
                        </div>
                    </div>

                    {/* Summary Cards */}
                    <div className="grid grid-cols-2 lg:grid-cols-5 gap-3">
                        <div className="p-4 bg-amber-500/10 rounded-xl border border-amber-500/30">
                            <p className="text-xs text-slate-400">Total Received</p>
                            <p className="text-xl font-bold text-amber-400">{fmtCur(filteredTotals.totalReceived)}</p>
                            <p className="text-xs text-slate-500">{filteredTithes.length} entries</p>
                        </div>
                        <div className="p-4 bg-emerald-500/10 rounded-xl border border-emerald-500/30">
                            <p className="text-xs text-slate-400">Conference Funds</p>
                            <p className="text-xl font-bold text-emerald-400">{fmtCur(filteredTotals.grandTotalConference)}</p>
                            <p className="text-xs text-slate-500">Tithe + 40%</p>
                        </div>
                        <div className="p-4 bg-cyan-500/10 rounded-xl border border-cyan-500/30">
                            <p className="text-xs text-slate-400">Church Operating</p>
                            <p className="text-xl font-bold text-cyan-400">{fmtCur(filteredTotals.churchOperating)}</p>
                            <p className="text-xs text-slate-500">60% Budget Covenant</p>
                        </div>
                        <div className="p-4 bg-red-500/10 rounded-xl border border-red-500/30">
                            <p className="text-xs text-slate-400">Expenses</p>
                            <p className="text-xl font-bold text-red-400">{fmtCur(filteredExpenseTotal)}</p>
                            <p className="text-xs text-slate-500">{filteredExpenses.length} payments</p>
                        </div>
                        <div className="p-4 bg-blue-500/10 rounded-xl border border-blue-500/30">
                            <p className="text-xs text-slate-400">Church Income (60%)</p>
                            <p className="text-xl font-bold text-blue-400">{fmtCur(filteredTotals.churchOperating)}</p>
                        </div>
                    </div>

                    {/* Summary Report */}
                    {reportType === 'summary' && (
                        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                <h3 className="text-sm font-semibold text-emerald-400 mb-2">Conference Funds Breakdown</h3>
                                {CONFERENCE_FIELDS.map(f => (
                                    <div key={f.key} className="flex justify-between py-1 border-b border-slate-700/50 text-sm">
                                        <span className="text-slate-400">{f.label}</span>
                                        <span className="text-emerald-400">{fmtCur(filteredTotals[f.key])}</span>
                                    </div>
                                ))}
                                <div className="flex justify-between py-1 font-medium">
                                    <span className="text-emerald-300">Sub-Total Conference Funds</span>
                                    <span className="text-emerald-300">{fmtCur(filteredTotals.totalConfFund)}</span>
                                </div>
                                
                                {/* 40% Calculation Breakdown */}
                                <div className="mt-3 pt-2 border-t border-slate-600">
                                    <p className="text-xs text-amber-400 font-semibold mb-1">40% Calculation:</p>
                                    <div className="flex justify-between py-0.5 text-xs">
                                        <span className="text-slate-400 pl-2">Budget Covenant</span>
                                        <span className="text-slate-300">{fmtCur(filteredTotals.budget_covenant)}</span>
                                    </div>
                                    <div className="flex justify-between py-0.5 text-xs">
                                        <span className="text-red-400 pl-2">Less: Contribution to School (Tithe)</span>
                                        <span className="text-red-400">-{fmtCur(filteredTotals.school)}</span>
                                    </div>
                                    <div className="flex justify-between py-0.5 text-xs">
                                        <span className="text-red-400 pl-2">Less: Contribution to Children's Home</span>
                                        <span className="text-red-400">-{fmtCur(filteredTotals.pos_band)}</span>
                                    </div>
                                    <div className="flex justify-between py-0.5 text-xs">
                                        <span className="text-red-400 pl-2">Less: School - Wesport (Expenses)</span>
                                        <span className="text-red-400">-{fmtCur(filteredTotals.wesportExpenses || 0)}</span>
                                    </div>
                                    <div className="flex justify-between py-0.5 text-xs border-t border-slate-700 mt-1">
                                        <span className="text-slate-300 pl-2">Net Amount</span>
                                        <span className="text-slate-300">{fmtCur(filteredTotals.baseFor40_60 || 0)}</span>
                                    </div>
                                    <div className="flex justify-between py-0.5 text-sm">
                                        <span className="text-amber-400 pl-2">40% of Net Amount</span>
                                        <span className="text-amber-400">{fmtCur(filteredTotals.percentage40)}</span>
                                    </div>
                                </div>
                                
                                <div className="flex justify-between py-2 font-bold mt-2 bg-emerald-500/10 px-2 rounded">
                                    <span className="text-emerald-400">Total to Conference</span>
                                    <span className="text-emerald-400">{fmtCur(filteredTotals.grandTotalConference)}</span>
                                </div>
                            </div>
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                <h3 className="text-sm font-semibold text-blue-400 mb-2">Church Funds Breakdown</h3>
                                {CHURCH_FIELDS.map(f => (
                                    <div key={f.key} className="flex justify-between py-1 border-b border-slate-700/50 text-sm">
                                        <span className="text-slate-400">{f.label}</span>
                                        <span className="text-blue-400">{fmtCur(filteredTotals[f.key])}</span>
                                    </div>
                                ))}
                                <div className="flex justify-between py-2 font-bold">
                                    <span className="text-blue-400">Total Church Funds</span>
                                    <span className="text-blue-400">{fmtCur(filteredTotals.totalChurchFund)}</span>
                                </div>
                                
                                {/* 60% Calculation Breakdown */}
                                <div className="mt-3 pt-2 border-t border-slate-600">
                                    <p className="text-xs text-cyan-400 font-semibold mb-1">60% Church Operating Calculation:</p>
                                    <div className="flex justify-between py-0.5 text-xs">
                                        <span className="text-slate-400 pl-2">Budget Covenant</span>
                                        <span className="text-slate-300">{fmtCur(filteredTotals.budget_covenant)}</span>
                                    </div>
                                    <div className="flex justify-between py-0.5 text-xs">
                                        <span className="text-red-400 pl-2">Less: Contribution to School (Tithe)</span>
                                        <span className="text-red-400">-{fmtCur(filteredTotals.school)}</span>
                                    </div>
                                    <div className="flex justify-between py-0.5 text-xs">
                                        <span className="text-red-400 pl-2">Less: Contribution to Children's Home</span>
                                        <span className="text-red-400">-{fmtCur(filteredTotals.pos_band)}</span>
                                    </div>
                                    <div className="flex justify-between py-0.5 text-xs">
                                        <span className="text-red-400 pl-2">Less: School - Wesport (Expenses)</span>
                                        <span className="text-red-400">-{fmtCur(filteredTotals.wesportExpenses || 0)}</span>
                                    </div>
                                    <div className="flex justify-between py-0.5 text-xs border-t border-slate-700 mt-1">
                                        <span className="text-slate-300 pl-2">Net Amount</span>
                                        <span className="text-slate-300">{fmtCur(filteredTotals.baseFor40_60 || 0)}</span>
                                    </div>
                                    <div className="flex justify-between py-1 text-sm bg-blue-500/10 px-2 rounded mt-1">
                                        <span className="text-blue-400 font-medium">60% Church Operating</span>
                                        <span className="text-blue-400 font-medium">{fmtCur(filteredTotals.churchOperating)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Giving Analytics Report */}
                    {reportType === 'givingAnalytics' && (() => {
                        // Calculate analytics
                        const totalTithe = filteredTotals.tithe || 0;
                        const totalOfferings = filteredTotals.totalReceived - totalTithe;
                        const tithePercent = filteredTotals.totalReceived > 0 ? (totalTithe / filteredTotals.totalReceived * 100) : 0;
                        const offeringPercent = 100 - tithePercent;
                        
                        // Conference vs Church split
                        const confPercent = filteredTotals.totalReceived > 0 ? (filteredTotals.grandTotalConference / filteredTotals.totalReceived * 100) : 0;
                        const churchPercent = 100 - confPercent;
                        
                        // Member statistics
                        const memberStats = uniqueMembers.map(name => {
                            const entries = filteredTithes.filter(e => e.name === name);
                            const totals = calculateTitheTotals(entries);
                            return { name, entries: entries.length, tithe: totals.tithe || 0, offerings: (totals.totalReceived || 0) - (totals.tithe || 0), total: totals.totalReceived || 0, budgetCovenant: totals.budget_covenant || 0 };
                        }).filter(m => m.total > 0).sort((a, b) => b.total - a.total);
                        
                        const totalMembers = memberStats.length;
                        const avgGiftPerMember = totalMembers > 0 ? filteredTotals.totalReceived / totalMembers : 0;
                        const avgTithePerMember = totalMembers > 0 ? totalTithe / totalMembers : 0;
                        const avgEntriesPerMember = totalMembers > 0 ? filteredTithes.length / totalMembers : 0;
                        
                        // Top 10 contributors (by total)
                        const top10 = memberStats.slice(0, 10);
                        const top10Total = top10.reduce((s, m) => s + m.total, 0);
                        const top10Percent = filteredTotals.totalReceived > 0 ? (top10Total / filteredTotals.totalReceived * 100) : 0;
                        
                        // Budget Covenant participation
                        const budgetCovenantMembers = memberStats.filter(m => m.budgetCovenant > 0);
                        const budgetCovenantParticipation = totalMembers > 0 ? (budgetCovenantMembers.length / totalMembers * 100) : 0;
                        
                        // Monthly trends
                        const monthlyData = {};
                        filteredTithes.forEach(t => {
                            const month = t.date?.substring(0, 7); // YYYY-MM
                            if (!monthlyData[month]) monthlyData[month] = { tithe: 0, offerings: 0, total: 0, entries: 0, members: new Set() };
                            monthlyData[month].tithe += parseFloat(t.tithe) || 0;
                            monthlyData[month].offerings += (parseFloat(t.total_received) || 0) - (parseFloat(t.tithe) || 0);
                            monthlyData[month].total += parseFloat(t.total_received) || 0;
                            monthlyData[month].entries += 1;
                            monthlyData[month].members.add(t.name);
                        });
                        const sortedMonths = Object.keys(monthlyData).sort();
                        
                        // Giving distribution (how many give what %)
                        const givingBrackets = [
                            { label: '$0 - $100', min: 0, max: 100, count: 0, total: 0 },
                            { label: '$101 - $500', min: 101, max: 500, count: 0, total: 0 },
                            { label: '$501 - $1,000', min: 501, max: 1000, count: 0, total: 0 },
                            { label: '$1,001 - $5,000', min: 1001, max: 5000, count: 0, total: 0 },
                            { label: '$5,001+', min: 5001, max: Infinity, count: 0, total: 0 },
                        ];
                        memberStats.forEach(m => {
                            const bracket = givingBrackets.find(b => m.total >= b.min && m.total <= b.max);
                            if (bracket) { bracket.count++; bracket.total += m.total; }
                        });
                        
                        // Consistent vs Occasional givers (based on entries)
                        const consistentGivers = memberStats.filter(m => m.entries >= 3).length;
                        const occasionalGivers = memberStats.filter(m => m.entries < 3).length;
                        
                        return (
                            <div className="space-y-4">
                                <div className="bg-slate-800/50 rounded-xl border border-purple-500/30 p-6">
                                    <h3 className="text-lg font-bold text-purple-400 mb-6">üìä Giving Analytics & Patterns</h3>
                                    
                                    {/* Key Metrics */}
                                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                                        <div className="bg-amber-500/10 rounded-lg p-4 border border-amber-500/30">
                                            <p className="text-xs text-slate-400">Tithe % of Total</p>
                                            <p className="text-2xl font-bold text-amber-400">{tithePercent.toFixed(1)}%</p>
                                            <p className="text-xs text-slate-500">{fmtCur(totalTithe)}</p>
                                        </div>
                                        <div className="bg-emerald-500/10 rounded-lg p-4 border border-emerald-500/30">
                                            <p className="text-xs text-slate-400">Offerings % of Total</p>
                                            <p className="text-2xl font-bold text-emerald-400">{offeringPercent.toFixed(1)}%</p>
                                            <p className="text-xs text-slate-500">{fmtCur(totalOfferings)}</p>
                                        </div>
                                        <div className="bg-teal-500/10 rounded-lg p-4 border border-teal-500/30">
                                            <p className="text-xs text-slate-400">To Conference</p>
                                            <p className="text-2xl font-bold text-teal-400">{confPercent.toFixed(1)}%</p>
                                            <p className="text-xs text-slate-500">{fmtCur(filteredTotals.grandTotalConference)}</p>
                                        </div>
                                        <div className="bg-blue-500/10 rounded-lg p-4 border border-blue-500/30">
                                            <p className="text-xs text-slate-400">Church Retention</p>
                                            <p className="text-2xl font-bold text-blue-400">{churchPercent.toFixed(1)}%</p>
                                            <p className="text-xs text-slate-500">{fmtCur(filteredTotals.totalReceived - filteredTotals.grandTotalConference)}</p>
                                        </div>
                                    </div>
                                    
                                    {/* Member Metrics */}
                                    <div className="grid grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                                        <div className="bg-slate-700/30 rounded-lg p-3 text-center">
                                            <p className="text-2xl font-bold text-white">{totalMembers}</p>
                                            <p className="text-xs text-slate-400">Active Givers</p>
                                        </div>
                                        <div className="bg-slate-700/30 rounded-lg p-3 text-center">
                                            <p className="text-2xl font-bold text-white">{fmtCur(avgGiftPerMember)}</p>
                                            <p className="text-xs text-slate-400">Avg Gift/Member</p>
                                        </div>
                                        <div className="bg-slate-700/30 rounded-lg p-3 text-center">
                                            <p className="text-2xl font-bold text-white">{fmtCur(avgTithePerMember)}</p>
                                            <p className="text-xs text-slate-400">Avg Tithe/Member</p>
                                        </div>
                                        <div className="bg-slate-700/30 rounded-lg p-3 text-center">
                                            <p className="text-2xl font-bold text-white">{avgEntriesPerMember.toFixed(1)}</p>
                                            <p className="text-xs text-slate-400">Avg Entries/Member</p>
                                        </div>
                                        <div className="bg-slate-700/30 rounded-lg p-3 text-center">
                                            <p className="text-2xl font-bold text-white">{budgetCovenantParticipation.toFixed(0)}%</p>
                                            <p className="text-xs text-slate-400">Budget Covenant Part.</p>
                                        </div>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        {/* Top 10 Contributors */}
                                        <div className="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                                            <div className="flex justify-between items-center mb-3">
                                                <h4 className="text-sm font-semibold text-amber-400">Top 10 Contributors</h4>
                                                <span className="text-xs text-slate-400">{top10Percent.toFixed(1)}% of total</span>
                                            </div>
                                            {top10.map((m, idx) => {
                                                const pct = filteredTotals.totalReceived > 0 ? (m.total / filteredTotals.totalReceived * 100) : 0;
                                                return (
                                                    <div key={m.name} className="flex items-center gap-2 py-1.5 border-b border-slate-700/50">
                                                        <span className="text-xs text-slate-500 w-5">{idx + 1}.</span>
                                                        <span className="flex-1 text-sm text-slate-300 truncate">{m.name}</span>
                                                        <span className="text-xs text-slate-500">{pct.toFixed(1)}%</span>
                                                        <span className="text-sm text-amber-400 font-medium w-24 text-right">{fmtCur(m.total)}</span>
                                                    </div>
                                                );
                                            })}
                                            <div className="flex justify-between pt-2 mt-2 border-t border-slate-600 text-sm font-medium">
                                                <span className="text-amber-400">Top 10 Total</span>
                                                <span className="text-amber-400">{fmtCur(top10Total)}</span>
                                            </div>
                                        </div>
                                        
                                        {/* Giving Distribution */}
                                        <div className="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                                            <h4 className="text-sm font-semibold text-emerald-400 mb-3">Giving Distribution</h4>
                                            {givingBrackets.map(b => {
                                                const pct = totalMembers > 0 ? (b.count / totalMembers * 100) : 0;
                                                return (
                                                    <div key={b.label} className="mb-3">
                                                        <div className="flex justify-between text-xs mb-1">
                                                            <span className="text-slate-400">{b.label}</span>
                                                            <span className="text-slate-300">{b.count} members ({pct.toFixed(0)}%)</span>
                                                        </div>
                                                        <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                                                            <div className="h-full bg-emerald-500 rounded-full" style={{width: `${pct}%`}}></div>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                            <div className="mt-4 pt-3 border-t border-slate-600 grid grid-cols-2 gap-4 text-center">
                                                <div>
                                                    <p className="text-lg font-bold text-cyan-400">{consistentGivers}</p>
                                                    <p className="text-xs text-slate-400">Consistent (3+ entries)</p>
                                                </div>
                                                <div>
                                                    <p className="text-lg font-bold text-orange-400">{occasionalGivers}</p>
                                                    <p className="text-xs text-slate-400">Occasional (&lt;3 entries)</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    {/* Monthly Trends */}
                                    {sortedMonths.length > 1 && (
                                        <div className="mt-6 bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                                            <h4 className="text-sm font-semibold text-cyan-400 mb-4">Monthly Trends</h4>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-sm">
                                                    <thead>
                                                        <tr className="border-b border-slate-700">
                                                            <th className="px-2 py-2 text-left text-slate-400">Month</th>
                                                            <th className="px-2 py-2 text-right text-slate-400">Tithe</th>
                                                            <th className="px-2 py-2 text-right text-slate-400">Offerings</th>
                                                            <th className="px-2 py-2 text-right text-slate-400">Total</th>
                                                            <th className="px-2 py-2 text-right text-slate-400">Entries</th>
                                                            <th className="px-2 py-2 text-right text-slate-400">Members</th>
                                                            <th className="px-2 py-2 text-right text-slate-400">Tithe %</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {sortedMonths.map((month, idx) => {
                                                            const d = monthlyData[month];
                                                            const prevMonth = sortedMonths[idx - 1];
                                                            const prevTotal = prevMonth ? monthlyData[prevMonth].total : null;
                                                            const change = prevTotal ? ((d.total - prevTotal) / prevTotal * 100) : null;
                                                            const tithePct = d.total > 0 ? (d.tithe / d.total * 100) : 0;
                                                            return (
                                                                <tr key={month} className="border-b border-slate-700/50">
                                                                    <td className="px-2 py-2 text-slate-300">{month}</td>
                                                                    <td className="px-2 py-2 text-right text-amber-400">{fmtCur(d.tithe)}</td>
                                                                    <td className="px-2 py-2 text-right text-emerald-400">{fmtCur(d.offerings)}</td>
                                                                    <td className="px-2 py-2 text-right text-white font-medium">
                                                                        {fmtCur(d.total)}
                                                                        {change !== null && (
                                                                            <span className={`ml-2 text-xs ${change >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                                                                {change >= 0 ? '‚Üë' : '‚Üì'}{Math.abs(change).toFixed(0)}%
                                                                            </span>
                                                                        )}
                                                                    </td>
                                                                    <td className="px-2 py-2 text-right text-slate-400">{d.entries}</td>
                                                                    <td className="px-2 py-2 text-right text-slate-400">{d.members.size}</td>
                                                                    <td className="px-2 py-2 text-right text-cyan-400">{tithePct.toFixed(1)}%</td>
                                                                </tr>
                                                            );
                                                        })}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}
                                    
                                    {/* Insights & Recommendations */}
                                    <div className="mt-6 bg-gradient-to-r from-purple-500/10 to-blue-500/10 rounded-lg p-4 border border-purple-500/30">
                                        <h4 className="text-sm font-semibold text-purple-400 mb-3">üí° Insights & Observations</h4>
                                        <div className="space-y-2 text-sm">
                                            {tithePercent > 60 && (
                                                <p className="text-slate-300">‚úì <span className="text-emerald-400">Strong tithe ratio</span> - Tithe represents {tithePercent.toFixed(0)}% of total giving, indicating faithful tithing practices.</p>
                                            )}
                                            {tithePercent < 40 && (
                                                <p className="text-slate-300">‚ö†Ô∏è <span className="text-amber-400">Low tithe ratio</span> - Tithe is only {tithePercent.toFixed(0)}% of total. Consider emphasizing tithing principles.</p>
                                            )}
                                            {top10Percent > 50 && (
                                                <p className="text-slate-300">‚ö†Ô∏è <span className="text-amber-400">Concentration risk</span> - Top 10 contributors give {top10Percent.toFixed(0)}% of total. Consider broadening the giving base.</p>
                                            )}
                                            {budgetCovenantParticipation < 30 && (
                                                <p className="text-slate-300">üìå <span className="text-cyan-400">Budget Covenant opportunity</span> - Only {budgetCovenantParticipation.toFixed(0)}% participate. A campaign could increase church operating income.</p>
                                            )}
                                            {budgetCovenantParticipation >= 50 && (
                                                <p className="text-slate-300">‚úì <span className="text-emerald-400">Good Budget Covenant participation</span> - {budgetCovenantParticipation.toFixed(0)}% of givers contribute to Budget Covenant.</p>
                                            )}
                                            {consistentGivers > occasionalGivers && (
                                                <p className="text-slate-300">‚úì <span className="text-emerald-400">Consistent giving base</span> - {consistentGivers} consistent givers vs {occasionalGivers} occasional givers.</p>
                                            )}
                                            {occasionalGivers > consistentGivers && (
                                                <p className="text-slate-300">üìå <span className="text-cyan-400">Engagement opportunity</span> - {occasionalGivers} occasional givers could become regular with encouragement.</p>
                                            )}
                                            <p className="text-slate-300">üìä Average gift per member: <span className="text-white font-medium">{fmtCur(avgGiftPerMember)}</span> | Average tithe: <span className="text-white font-medium">{fmtCur(avgTithePerMember)}</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}

                    {/* Conference Funds Report */}
                    {reportType === 'conferenceFunds' && (
                        <div className="space-y-4">
                            <div className="bg-slate-800/50 rounded-xl border border-teal-500/30 p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-teal-400">Conference Funds Report</h3>
                                    <button onClick={exportConferenceFundsReport} className="px-4 py-2 bg-teal-600 text-white rounded-lg text-sm hover:bg-teal-500">üì• Export to Excel</button>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* Conference Funds Breakdown */}
                                    <div className="bg-slate-900/50 rounded-lg p-4">
                                        <h4 className="text-sm font-semibold text-emerald-400 mb-3">Conference Funds Breakdown</h4>
                                        {CONFERENCE_FIELDS.map(f => (
                                            <div key={f.key} className="flex justify-between py-2 border-b border-slate-700/50">
                                                <span className="text-slate-300">{f.label}</span>
                                                <span className="text-emerald-400 font-medium">{fmtCur(filteredTotals[f.key] || 0)}</span>
                                            </div>
                                        ))}
                                        <div className="flex justify-between py-3 font-bold border-t border-slate-600 mt-2">
                                            <span className="text-emerald-300">Sub Total Conference Funds</span>
                                            <span className="text-emerald-300">{fmtCur(filteredTotals.totalConfFund)}</span>
                                        </div>
                                    </div>
                                    
                                    {/* 40% Calculation */}
                                    <div className="bg-slate-900/50 rounded-lg p-4">
                                        <h4 className="text-sm font-semibold text-amber-400 mb-3">40% Calculation</h4>
                                        <div className="flex justify-between py-2 border-b border-slate-700/50">
                                            <span className="text-slate-300">Budget Covenant</span>
                                            <span className="text-slate-300">{fmtCur(filteredTotals.budget_covenant || 0)}</span>
                                        </div>
                                        <div className="flex justify-between py-2 border-b border-slate-700/50">
                                            <span className="text-red-400">Less: Contribution to School (Tithe)</span>
                                            <span className="text-red-400">-{fmtCur(filteredTotals.school || 0)}</span>
                                        </div>
                                        <div className="flex justify-between py-2 border-b border-slate-700/50">
                                            <span className="text-red-400">Less: Contribution to Children's Home</span>
                                            <span className="text-red-400">-{fmtCur(filteredTotals.pos_band || 0)}</span>
                                        </div>
                                        <div className="flex justify-between py-2 border-b border-slate-700/50">
                                            <span className="text-red-400">Less: School - Wesport (Expenses)</span>
                                            <span className="text-red-400">-{fmtCur(filteredTotals.wesportExpenses || 0)}</span>
                                        </div>
                                        <div className="flex justify-between py-2 border-t border-slate-600 mt-2">
                                            <span className="text-slate-300 font-medium">Net Amount for 40%/60%</span>
                                            <span className="text-slate-300 font-medium">{fmtCur(filteredTotals.baseFor40_60 || 0)}</span>
                                        </div>
                                        <div className="flex justify-between py-3 bg-amber-500/20 rounded-lg px-3 mt-2">
                                            <span className="text-amber-400 font-bold">40% of Net Amount</span>
                                            <span className="text-amber-400 font-bold">{fmtCur(filteredTotals.percentage40)}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Grand Total */}
                                <div className="mt-6 p-4 bg-teal-500/20 rounded-xl border border-teal-500/30">
                                    <div className="flex justify-between items-center">
                                        <span className="text-xl font-bold text-teal-400">GRAND TOTAL TO CONFERENCE</span>
                                        <span className="text-2xl font-bold text-teal-400">{fmtCur(filteredTotals.grandTotalConference)}</span>
                                    </div>
                                    <p className="text-xs text-slate-400 mt-2">Sub Total Conference Funds ({fmtCur(filteredTotals.totalConfFund)}) + 40% of Net Amount ({fmtCur(filteredTotals.percentage40)})</p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Church Operating Income Report */}
                    {reportType === 'churchOperating' && (
                        <div className="space-y-4">
                            <div className="bg-slate-800/50 rounded-xl border border-blue-500/30 p-6">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-lg font-bold text-blue-400">Church Operating Income Report</h3>
                                    <button onClick={exportChurchOperatingReport} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-500">üì• Export to Excel</button>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    {/* Church Funds Breakdown */}
                                    <div className="bg-slate-900/50 rounded-lg p-4">
                                        <h4 className="text-sm font-semibold text-blue-400 mb-3">Church Funds Breakdown</h4>
                                        {CHURCH_FIELDS.map(f => (
                                            <div key={f.key} className="flex justify-between py-2 border-b border-slate-700/50">
                                                <span className="text-slate-300">{f.label}</span>
                                                <span className="text-blue-400 font-medium">{fmtCur(filteredTotals[f.key] || 0)}</span>
                                            </div>
                                        ))}
                                        <div className="flex justify-between py-3 font-bold border-t border-slate-600 mt-2">
                                            <span className="text-blue-300">Total Church Funds</span>
                                            <span className="text-blue-300">{fmtCur(filteredTotals.totalChurchFund)}</span>
                                        </div>
                                    </div>
                                    
                                    {/* 60% Calculation */}
                                    <div className="bg-slate-900/50 rounded-lg p-4">
                                        <h4 className="text-sm font-semibold text-cyan-400 mb-3">60% Calculation</h4>
                                        <div className="flex justify-between py-2 border-b border-slate-700/50">
                                            <span className="text-slate-300">Budget Covenant</span>
                                            <span className="text-slate-300">{fmtCur(filteredTotals.budget_covenant || 0)}</span>
                                        </div>
                                        <div className="flex justify-between py-2 border-b border-slate-700/50">
                                            <span className="text-red-400">Less: Contribution to School (Tithe)</span>
                                            <span className="text-red-400">-{fmtCur(filteredTotals.school || 0)}</span>
                                        </div>
                                        <div className="flex justify-between py-2 border-b border-slate-700/50">
                                            <span className="text-red-400">Less: Contribution to Children's Home</span>
                                            <span className="text-red-400">-{fmtCur(filteredTotals.pos_band || 0)}</span>
                                        </div>
                                        <div className="flex justify-between py-2 border-b border-slate-700/50">
                                            <span className="text-red-400">Less: School - Wesport (Expenses)</span>
                                            <span className="text-red-400">-{fmtCur(filteredTotals.wesportExpenses || 0)}</span>
                                        </div>
                                        <div className="flex justify-between py-2 border-t border-slate-600 mt-2">
                                            <span className="text-slate-300 font-medium">Net Amount for 40%/60%</span>
                                            <span className="text-slate-300 font-medium">{fmtCur(filteredTotals.baseFor40_60 || 0)}</span>
                                        </div>
                                        <div className="flex justify-between py-3 bg-blue-500/20 rounded-lg px-3 mt-2">
                                            <span className="text-blue-400 font-bold">60% of Net Amount</span>
                                            <span className="text-blue-400 font-bold">{fmtCur(filteredTotals.churchOperating)}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                {/* Church Operating Total */}
                                <div className="mt-6 p-4 bg-blue-500/20 rounded-xl border border-blue-500/30">
                                    <div className="flex justify-between items-center">
                                        <span className="text-xl font-bold text-blue-400">CHURCH OPERATING INCOME</span>
                                        <span className="text-2xl font-bold text-blue-400">{fmtCur(filteredTotals.churchOperating)}</span>
                                    </div>
                                    <p className="text-xs text-slate-400 mt-2">This is the 60% of net amount available for church operations</p>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Fund Distribution Report */}
                    {reportType === 'fundDistribution' && (() => {
                        // Calculate all project balances
                        const allProjects = projects || [];
                        const projectFunds = allProjects.map(p => ({
                            name: p.name,
                            status: p.status,
                            balance: getProjectFinancials(p.id).balance
                        }));
                        const totalProjectFunds = projectFunds.reduce((s, p) => s + p.balance, 0);
                        
                        // Church Operating Income (60%)
                        const churchOperatingIncome = filteredTotals.churchOperating;
                        
                        // Conference Funds (Tithe + 40% - needs to be remitted to Conference)
                        const conferenceFunds = filteredTotals.grandTotalConference;
                        
                        // Total Allocated Funds (Projects + Church Operating + Conference)
                        const totalAllocatedFunds = totalProjectFunds + churchOperatingIncome + conferenceFunds;
                        
                        // Get Unit Trust and Revolving Fund from settings
                        const unitTrustBalance = parseFloat(settings.unit_trust) || 79082.04;
                        const revolvingFundBalance = parseFloat(settings.revolving_fund) || 597996.24;
                        
                        // Calculate Chequing Account Balance
                        // Total Tithe Income - Total Expenses (all time for accurate balance)
                        const totalDeposits = titheEntries.reduce((s, e) => s + (parseFloat(e.total_received) || 0), 0);
                        const totalExpensesAll = expenses.reduce((s, e) => s + (parseFloat(e.amount) || 0), 0);
                        const chequingBalance = totalDeposits - totalExpensesAll;
                        
                        // Total "Represented by" = Unit Trust + Chequing + Revolving Fund
                        const representedByTotal = unitTrustBalance + chequingBalance + revolvingFundBalance;
                        
                        // Church Reserves = Represented By Total - Total Allocated Funds (balancing figure)
                        const churchReserves = representedByTotal - totalAllocatedFunds;
                        
                        // Left side total (should equal representedByTotal)
                        const leftSideTotal = totalAllocatedFunds + churchReserves;
                        
                        return (
                            <div className="space-y-4">
                                <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-6">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-lg font-bold text-purple-400">Fund Distribution Report</h3>
                                        <button onClick={() => {
                                            const data = [
                                                ['FUND DISTRIBUTION REPORT'],
                                                [`As at: ${new Date().toLocaleDateString()}`],
                                                [`Period: ${startDate} to ${endDate}`],
                                                [],
                                                ['FUNDS', 'Amount', 'REPRESENTED BY', 'Amount'],
                                                [],
                                                ['PROJECT FUNDS', '', '', ''],
                                                ...projectFunds.map(p => [p.name, p.balance, '', '']),
                                                ['Total Project Funds', totalProjectFunds, '', ''],
                                                [],
                                                ['Church Operating Income (60%)', churchOperatingIncome, 'Unit Trust', unitTrustBalance],
                                                ['Conference Funds (to remit)', conferenceFunds, 'Chequing Account', chequingBalance],
                                                ['', '', 'Revolving Fund', revolvingFundBalance],
                                                [],
                                                ['TOTAL ALLOCATED FUNDS', totalAllocatedFunds, '', ''],
                                                [],
                                                ['Church Reserves', churchReserves, 'TOTAL REPRESENTED BY', representedByTotal],
                                                [],
                                                ['BALANCE', leftSideTotal, 'BALANCE', representedByTotal],
                                                [],
                                                [],
                                                ['VERIFICATION'],
                                                ['Total Allocated Funds', totalAllocatedFunds],
                                                ['+ Church Reserves', churchReserves],
                                                ['= Total', leftSideTotal],
                                                ['Represented By Total', representedByTotal],
                                                [leftSideTotal === representedByTotal ? 'BALANCED ‚úì' : 'UNBALANCED ‚úó', '']
                                            ];
                                            const ws = XLSX.utils.aoa_to_sheet(data);
                                            ws['!cols'] = [{wch: 35}, {wch: 18}, {wch: 25}, {wch: 18}];
                                            const wb = XLSX.utils.book_new();
                                            XLSX.utils.book_append_sheet(wb, ws, 'Fund Distribution');
                                            XLSX.writeFile(wb, `Fund_Distribution_${new Date().toISOString().split('T')[0]}.xlsx`);
                                        }} className="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm hover:bg-purple-500">üì• Export to Excel</button>
                                    </div>
                                    
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        {/* Left Side - Funds */}
                                        <div className="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                                            <h4 className="text-sm font-semibold text-emerald-400 mb-4 pb-2 border-b border-slate-600">FUNDS</h4>
                                            
                                            {/* Project Funds */}
                                            <div className="mb-4">
                                                <p className="text-xs text-slate-500 font-medium mb-2">PROJECT FUNDS</p>
                                                {projectFunds.map((p, idx) => (
                                                    <div key={idx} className="flex justify-between py-1.5 border-b border-slate-700/50">
                                                        <span className="text-slate-300 text-sm">{p.name}</span>
                                                        <span className={`text-sm font-medium ${p.balance >= 0 ? 'text-emerald-400' : 'text-red-400'}`}>{fmtCur(p.balance)}</span>
                                                    </div>
                                                ))}
                                                <div className="flex justify-between py-2 mt-1 bg-emerald-500/10 rounded px-2">
                                                    <span className="text-emerald-400 font-medium text-sm">Total Project Funds</span>
                                                    <span className="text-emerald-400 font-bold">{fmtCur(totalProjectFunds)}</span>
                                                </div>
                                            </div>
                                            
                                            {/* Church Operating */}
                                            <div className="mb-2">
                                                <div className="flex justify-between py-2 border-b border-slate-600">
                                                    <span className="text-cyan-400 text-sm">Church Operating Income (60%)</span>
                                                    <span className="text-cyan-400 font-medium">{fmtCur(churchOperatingIncome)}</span>
                                                </div>
                                            </div>
                                            
                                            {/* Conference Funds */}
                                            <div className="mb-4">
                                                <div className="flex justify-between py-2 border-b border-slate-600">
                                                    <span className="text-teal-400 text-sm">Conference Funds (to remit)</span>
                                                    <span className="text-teal-400 font-medium">{fmtCur(conferenceFunds)}</span>
                                                </div>
                                                <p className="text-xs text-slate-500 mt-1 pl-2">Tithe + 40% of Budget Covenant</p>
                                            </div>
                                            
                                            {/* Total Allocated Funds */}
                                            <div className="flex justify-between py-3 bg-purple-500/20 rounded-lg px-3 mt-4">
                                                <span className="text-purple-400 font-bold">TOTAL ALLOCATED FUNDS</span>
                                                <span className="text-purple-400 font-bold text-lg">{fmtCur(totalAllocatedFunds)}</span>
                                            </div>
                                            
                                            {/* Church Reserves */}
                                            <div className="mt-4 pt-4 border-t border-slate-600">
                                                <div className="flex justify-between py-2">
                                                    <span className="text-amber-400 text-sm">Church Reserves</span>
                                                    <span className={`font-medium ${churchReserves >= 0 ? 'text-amber-400' : 'text-red-400'}`}>{fmtCur(churchReserves)}</span>
                                                </div>
                                                <p className="text-xs text-slate-500 pl-2">Balancing figure (Represented By - Allocated)</p>
                                            </div>
                                            
                                            {/* Balance */}
                                            <div className="flex justify-between py-3 bg-blue-500/20 rounded-lg px-3 mt-4 border-2 border-blue-500/50">
                                                <span className="text-blue-400 font-bold">BALANCE</span>
                                                <span className="text-blue-400 font-bold text-lg">{fmtCur(leftSideTotal)}</span>
                                            </div>
                                        </div>
                                        
                                        {/* Right Side - Represented By */}
                                        <div className="bg-slate-900/50 rounded-lg p-4 border border-slate-700">
                                            <h4 className="text-sm font-semibold text-blue-400 mb-4 pb-2 border-b border-slate-600">REPRESENTED BY</h4>
                                            
                                            <div className="space-y-4">
                                                <div className="p-4 bg-purple-500/10 rounded-lg border border-purple-500/30">
                                                    <p className="text-xs text-slate-400 mb-1">Unit Trust</p>
                                                    <p className="text-xl font-bold text-purple-400">{fmtCur(unitTrustBalance)}</p>
                                                </div>
                                                
                                                <div className="p-4 bg-blue-500/10 rounded-lg border border-blue-500/30">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <p className="text-xs text-slate-400">Chequing Account</p>
                                                    </div>
                                                    <p className="text-xl font-bold text-blue-400">{fmtCur(chequingBalance)}</p>
                                                    <div className="mt-2 pt-2 border-t border-slate-700 text-xs">
                                                        <div className="flex justify-between text-slate-500">
                                                            <span>Total Deposits</span>
                                                            <span className="text-emerald-400">{fmtCur(totalDeposits)}</span>
                                                        </div>
                                                        <div className="flex justify-between text-slate-500">
                                                            <span>Less: Total Expenses</span>
                                                            <span className="text-red-400">-{fmtCur(totalExpensesAll)}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div className="p-4 bg-teal-500/10 rounded-lg border border-teal-500/30">
                                                    <p className="text-xs text-slate-400 mb-1">Revolving Fund</p>
                                                    <p className="text-xl font-bold text-teal-400">{fmtCur(revolvingFundBalance)}</p>
                                                </div>
                                                
                                                <div className="h-px bg-slate-600 my-4"></div>
                                                
                                                <div className="flex justify-between py-3 bg-blue-500/20 rounded-lg px-3 border-2 border-blue-500/50">
                                                    <span className="text-blue-400 font-bold">TOTAL REPRESENTED BY</span>
                                                    <span className="text-blue-400 font-bold text-lg">{fmtCur(representedByTotal)}</span>
                                                </div>
                                            </div>
                                            
                                            {/* Verification */}
                                            <div className="mt-6 p-4 bg-slate-800 rounded-lg border border-slate-600">
                                                <p className="text-xs text-slate-400 mb-3">Verification:</p>
                                                <div className="space-y-2">
                                                    <div className="flex justify-between py-1 text-sm">
                                                        <span className="text-purple-400">Total Allocated Funds</span>
                                                        <span className="text-purple-400">{fmtCur(totalAllocatedFunds)}</span>
                                                    </div>
                                                    <div className="flex justify-between py-1 text-sm">
                                                        <span className="text-amber-400">+ Church Reserves</span>
                                                        <span className={churchReserves >= 0 ? 'text-amber-400' : 'text-red-400'}>{fmtCur(churchReserves)}</span>
                                                    </div>
                                                    <div className="flex justify-between py-1 text-sm border-t border-slate-600 pt-2">
                                                        <span className="text-slate-300 font-medium">= Total</span>
                                                        <span className="text-slate-300 font-medium">{fmtCur(leftSideTotal)}</span>
                                                    </div>
                                                    <div className="flex justify-between py-1 text-sm">
                                                        <span className="text-blue-400">Represented By Total</span>
                                                        <span className="text-blue-400">{fmtCur(representedByTotal)}</span>
                                                    </div>
                                                    <div className={`mt-2 p-2 rounded text-center font-bold ${Math.abs(leftSideTotal - representedByTotal) < 0.01 ? 'bg-emerald-500/20 text-emerald-400' : 'bg-red-500/20 text-red-400'}`}>
                                                        {Math.abs(leftSideTotal - representedByTotal) < 0.01 ? '‚úì BALANCED' : '‚úó UNBALANCED'}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        );
                    })()}

                    {/* Tithes Detail Report */}
                    {reportType === 'tithes' && (
                        <div className="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                            <div className="p-3 border-b border-slate-700 bg-slate-800/50">
                                <h3 className="text-sm font-semibold text-amber-400">Tithes Detail ({filteredTithes.length} entries)</h3>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-xs">
                                    <thead><tr className="border-b border-slate-700 bg-slate-800/50">
                                        <th className="px-2 py-2 text-left text-amber-400">Date</th>
                                        <th className="px-2 py-2 text-left text-amber-400">Slip#</th>
                                        <th className="px-2 py-2 text-left text-amber-400">Name</th>
                                        <th className="px-2 py-2 text-right text-amber-400">Tithe</th>
                                        <th className="px-2 py-2 text-right text-amber-400">Offerings</th>
                                        <th className="px-2 py-2 text-right text-amber-400">Total</th>
                                        <th className="px-2 py-2 text-left text-amber-400">By</th>
                                    </tr></thead>
                                    <tbody>
                                        {filteredTithes.map(e => (
                                            <tr key={e.id} className="border-b border-slate-700/50">
                                                <td className="px-2 py-1 text-slate-400">{e.date}</td>
                                                <td className="px-2 py-1 text-slate-400">{e.slip_number}</td>
                                                <td className="px-2 py-1 text-white">{e.name}</td>
                                                <td className="px-2 py-1 text-right text-emerald-400">{fmtCur(e.tithe)}</td>
                                                <td className="px-2 py-1 text-right text-blue-400">{fmtCur((parseFloat(e.total_received) || 0) - (parseFloat(e.tithe) || 0))}</td>
                                                <td className="px-2 py-1 text-right text-amber-400 font-semibold">{fmtCur(e.total_received)}</td>
                                                <td className="px-2 py-1 text-slate-500">{e.created_by_email?.split('@')[0]}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot><tr className="font-bold bg-amber-500/10">
                                        <td colSpan="3" className="px-2 py-2 text-amber-400">TOTALS</td>
                                        <td className="px-2 py-2 text-right text-emerald-400">{fmtCur(filteredTotals.tithe)}</td>
                                        <td className="px-2 py-2 text-right text-blue-400">{fmtCur(filteredTotals.totalReceived - filteredTotals.tithe)}</td>
                                        <td className="px-2 py-2 text-right text-amber-400">{fmtCur(filteredTotals.totalReceived)}</td>
                                        <td></td>
                                    </tr></tfoot>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Members Report */}
                    {reportType === 'members' && (
                        <div className="space-y-4">
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                                <div className="p-3 border-b border-slate-700 bg-slate-800/50">
                                    <h3 className="text-sm font-semibold text-blue-400">Member Summary ({uniqueMembers.length} members) - Click name to see details</h3>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead><tr className="border-b border-slate-700 bg-slate-800/50">
                                            <th className="px-3 py-2 text-left text-blue-400">Member Name</th>
                                            <th className="px-3 py-2 text-center text-blue-400">Entries</th>
                                            <th className="px-3 py-2 text-right text-blue-400">Tithe</th>
                                            <th className="px-3 py-2 text-right text-blue-400">Budget Covenant</th>
                                            <th className="px-3 py-2 text-right text-blue-400">Total Given</th>
                                        </tr></thead>
                                        <tbody>
                                            {uniqueMembers.map(name => {
                                                const memberEntries = filteredTithes.filter(e => e.name === name);
                                                if (memberEntries.length === 0) return null;
                                                const memberTotals = calculateTitheTotals(memberEntries);
                                                return (
                                                    <tr key={name} className="border-b border-slate-700/50 hover:bg-slate-700/30 cursor-pointer" onClick={() => setSelectedMemberDetail(name)}>
                                                        <td className="px-3 py-2 text-blue-400 hover:text-blue-300 underline">{name}</td>
                                                        <td className="px-3 py-2 text-center text-slate-400">{memberEntries.length}</td>
                                                        <td className="px-3 py-2 text-right text-emerald-400">{fmtCur(memberTotals.tithe)}</td>
                                                        <td className="px-3 py-2 text-right text-cyan-400">{fmtCur(memberTotals.budget_covenant)}</td>
                                                        <td className="px-3 py-2 text-right text-amber-400 font-semibold">{fmtCur(memberTotals.totalReceived)}</td>
                                                    </tr>
                                                );
                                            })}
                                        </tbody>
                                        <tfoot><tr className="font-bold bg-blue-500/10">
                                            <td className="px-3 py-2 text-blue-400">TOTALS</td>
                                            <td className="px-3 py-2 text-center text-blue-400">{filteredTithes.length}</td>
                                            <td className="px-3 py-2 text-right text-emerald-400">{fmtCur(filteredTotals.tithe)}</td>
                                            <td className="px-3 py-2 text-right text-cyan-400">{fmtCur(filteredTotals.budget_covenant)}</td>
                                            <td className="px-3 py-2 text-right text-amber-400">{fmtCur(filteredTotals.totalReceived)}</td>
                                        </tr></tfoot>
                                    </table>
                                </div>
                            </div>
                            
                            {/* Member Detail Modal */}
                            {selectedMemberDetail && (
                                <div className="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
                                    <div className="bg-slate-800 rounded-xl max-w-4xl w-full max-h-[80vh] overflow-hidden border border-slate-700">
                                        <div className="p-4 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center">
                                            <h3 className="text-lg font-bold text-blue-400">{selectedMemberDetail} - Tithe Details</h3>
                                            <button onClick={() => setSelectedMemberDetail(null)} className="text-slate-400 hover:text-white text-xl">‚úï</button>
                                        </div>
                                        <div className="p-4 overflow-y-auto max-h-[60vh]">
                                            <table className="w-full text-sm">
                                                <thead><tr className="border-b border-slate-700 bg-slate-800/50">
                                                    <th className="px-3 py-2 text-left text-blue-400">Date</th>
                                                    <th className="px-3 py-2 text-center text-blue-400">Slip #</th>
                                                    <th className="px-3 py-2 text-right text-blue-400">Tithe</th>
                                                    <th className="px-3 py-2 text-right text-blue-400">Offerings</th>
                                                    <th className="px-3 py-2 text-right text-blue-400">Total</th>
                                                </tr></thead>
                                                <tbody>
                                                    {filteredTithes.filter(e => e.name === selectedMemberDetail).map(e => (
                                                        <tr key={e.id} className="border-b border-slate-700/50">
                                                            <td className="px-3 py-2 text-slate-300">{e.date}</td>
                                                            <td className="px-3 py-2 text-center text-slate-400">{e.slip_number || '-'}</td>
                                                            <td className="px-3 py-2 text-right text-emerald-400">{fmtCur(e.tithe)}</td>
                                                            <td className="px-3 py-2 text-right text-blue-400">{fmtCur((parseFloat(e.total_received) || 0) - (parseFloat(e.tithe) || 0))}</td>
                                                            <td className="px-3 py-2 text-right text-amber-400 font-semibold">{fmtCur(e.total_received)}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                                <tfoot><tr className="font-bold bg-blue-500/10">
                                                    <td colSpan="2" className="px-3 py-2 text-blue-400">TOTALS</td>
                                                    <td className="px-3 py-2 text-right text-emerald-400">{fmtCur(calculateTitheTotals(filteredTithes.filter(e => e.name === selectedMemberDetail)).tithe)}</td>
                                                    <td className="px-3 py-2 text-right text-blue-400">{fmtCur(calculateTitheTotals(filteredTithes.filter(e => e.name === selectedMemberDetail)).totalReceived - calculateTitheTotals(filteredTithes.filter(e => e.name === selectedMemberDetail)).tithe)}</td>
                                                    <td className="px-3 py-2 text-right text-amber-400">{fmtCur(calculateTitheTotals(filteredTithes.filter(e => e.name === selectedMemberDetail)).totalReceived)}</td>
                                                </tr></tfoot>
                                            </table>
                                        </div>
                                        <div className="p-4 border-t border-slate-700 bg-slate-800/50">
                                            <button onClick={() => setSelectedMemberDetail(null)} className="px-4 py-2 bg-slate-700 text-white rounded-lg text-sm hover:bg-slate-600">Close</button>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {/* Expenses Report */}
                    {reportType === 'expenses' && (
                        <div className="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                            <div className="p-3 border-b border-slate-700 bg-slate-800/50">
                                <h3 className="text-sm font-semibold text-red-400">Expenses Detail ({filteredExpenses.length} entries)</h3>
                            </div>
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                    <thead><tr className="border-b border-slate-700 bg-slate-800/50">
                                        <th className="px-3 py-2 text-left text-red-400">Date</th>
                                        <th className="px-3 py-2 text-left text-red-400">Description</th>
                                        <th className="px-3 py-2 text-left text-red-400">Department</th>
                                        <th className="px-3 py-2 text-center text-red-400">Cheque #</th>
                                        <th className="px-3 py-2 text-right text-red-400">Amount</th>
                                        <th className="px-3 py-2 text-left text-red-400">By</th>
                                    </tr></thead>
                                    <tbody>
                                        {filteredExpenses.map(e => (
                                            <tr key={e.id} className="border-b border-slate-700/50">
                                                <td className="px-3 py-2 text-slate-400">{e.date}</td>
                                                <td className="px-3 py-2 text-white">{e.description}</td>
                                                <td className="px-3 py-2 text-slate-400">{e.department || '-'}</td>
                                                <td className="px-3 py-2 text-center text-slate-400">{e.cheque_number || '-'}</td>
                                                <td className="px-3 py-2 text-right text-red-400 font-semibold">{fmtCur(e.amount)}</td>
                                                <td className="px-3 py-2 text-slate-500 text-xs">{e.created_by_email?.split('@')[0]}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                    <tfoot><tr className="font-bold bg-red-500/10">
                                        <td colSpan="4" className="px-3 py-2 text-right text-red-400">TOTAL</td>
                                        <td className="px-3 py-2 text-right text-red-400">{fmtCur(filteredExpenseTotal)}</td>
                                        <td></td>
                                    </tr></tfoot>
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Projects Report */}
                    {reportType === 'projects' && (
                        <div className="space-y-4">
                            {/* Projects Summary Cards */}
                            <div className="grid grid-cols-2 lg:grid-cols-4 gap-3">
                                <div className="p-4 bg-cyan-500/10 rounded-xl border border-cyan-500/30">
                                    <p className="text-xs text-slate-400">Total Projects</p>
                                    <p className="text-xl font-bold text-cyan-400">{(projects || []).length}</p>
                                    <p className="text-xs text-slate-500">{(projects || []).filter(p => p.status === 'Active').length} active</p>
                                </div>
                                <div className="p-4 bg-emerald-500/10 rounded-xl border border-emerald-500/30">
                                    <p className="text-xs text-slate-400">Total Income</p>
                                    <p className="text-xl font-bold text-emerald-400">{fmtCur((projects || []).reduce((s, p) => s + getProjectFinancials(p.id).totalIncome, 0))}</p>
                                    <p className="text-xs text-slate-500">Incl. bal B/F</p>
                                </div>
                                <div className="p-4 bg-red-500/10 rounded-xl border border-red-500/30">
                                    <p className="text-xs text-slate-400">Total Expenses</p>
                                    <p className="text-xl font-bold text-red-400">{fmtCur((projects || []).reduce((s, p) => s + getProjectFinancials(p.id).spent, 0))}</p>
                                </div>
                                <div className="p-4 bg-blue-500/10 rounded-xl border border-blue-500/30">
                                    <p className="text-xs text-slate-400">Net Balance</p>
                                    <p className="text-xl font-bold text-blue-400">{fmtCur((projects || []).reduce((s, p) => s + getProjectFinancials(p.id).balance, 0))}</p>
                                </div>
                            </div>
                            
                            {/* Projects Detail Table */}
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                                <div className="p-3 border-b border-slate-700 bg-slate-800/50 flex justify-between items-center">
                                    <h3 className="text-sm font-semibold text-cyan-400">Projects Summary ({(projects || []).length} projects)</h3>
                                    <button onClick={exportProjectsReport} className="px-3 py-1 bg-cyan-600 text-white rounded text-xs hover:bg-cyan-500">üì• Export All</button>
                                </div>
                                <table className="w-full text-sm">
                                    <thead><tr className="border-b border-slate-700 bg-slate-800/50">
                                        <th className="px-3 py-2 text-left text-cyan-400">Project Name</th>
                                        <th className="px-3 py-2 text-center text-cyan-400">Status</th>
                                        <th className="px-3 py-2 text-right text-cyan-400">Target</th>
                                        <th className="px-3 py-2 text-right text-cyan-400">Bal B/F</th>
                                        <th className="px-3 py-2 text-right text-cyan-400">Income</th>
                                        <th className="px-3 py-2 text-right text-cyan-400">Expenses</th>
                                        <th className="px-3 py-2 text-right text-cyan-400">Balance</th>
                                        <th className="px-3 py-2 text-center text-cyan-400">Progress</th>
                                    </tr></thead>
                                    <tbody>
                                        {(projects || []).map(p => {
                                            const financials = getProjectFinancials(p.id);
                                            const progress = p.target_amount ? ((financials.totalIncome / p.target_amount) * 100) : 0;
                                            return (
                                                <tr key={p.id} className="border-b border-slate-700/50">
                                                    <td className="px-3 py-2 text-white font-medium">{p.name}</td>
                                                    <td className="px-3 py-2 text-center">
                                                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                                                            p.status === 'Completed' ? 'bg-emerald-500/20 text-emerald-400' : 'bg-blue-500/20 text-blue-400'
                                                        }`}>{p.status || 'Active'}</span>
                                                    </td>
                                                    <td className="px-3 py-2 text-right text-slate-300">{p.target_amount ? fmtCur(p.target_amount) : '-'}</td>
                                                    <td className="px-3 py-2 text-right text-purple-400">{financials.openingBalance > 0 ? fmtCur(financials.openingBalance) : '-'}</td>
                                                    <td className="px-3 py-2 text-right text-emerald-400">{fmtCur(financials.income)}</td>
                                                    <td className="px-3 py-2 text-right text-red-400">{fmtCur(financials.spent)}</td>
                                                    <td className="px-3 py-2 text-right text-blue-400 font-semibold">{fmtCur(financials.balance)}</td>
                                                    <td className="px-3 py-2">
                                                        {p.target_amount ? (
                                                            <div className="flex items-center gap-2">
                                                                <div className="flex-1 bg-slate-700 rounded-full h-2 overflow-hidden">
                                                                    <div className={`h-full ${progress >= 100 ? 'bg-emerald-500' : 'bg-cyan-500'}`} style={{width: `${Math.min(progress, 100)}%`}}></div>
                                                                </div>
                                                                <span className="text-xs text-slate-400 w-12">{progress.toFixed(0)}%</span>
                                                            </div>
                                                        ) : <span className="text-slate-500 text-xs">No target</span>}
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                        {(projects || []).length === 0 && (
                                            <tr><td colSpan="8" className="px-3 py-8 text-center text-slate-500">No projects found</td></tr>
                                        )}
                                    </tbody>
                                    {(projects || []).length > 0 && (
                                        <tfoot><tr className="font-bold bg-cyan-500/10">
                                            <td colSpan="2" className="px-3 py-2 text-cyan-400">TOTALS</td>
                                            <td className="px-3 py-2 text-right text-slate-300">{fmtCur((projects || []).reduce((s, p) => s + (parseFloat(p.target_amount) || 0), 0))}</td>
                                            <td className="px-3 py-2 text-right text-emerald-400">{fmtCur((projects || []).reduce((s, p) => s + getProjectFinancials(p.id).income, 0))}</td>
                                            <td className="px-3 py-2 text-right text-red-400">{fmtCur((projects || []).reduce((s, p) => s + getProjectFinancials(p.id).spent, 0))}</td>
                                            <td className="px-3 py-2 text-right text-blue-400">{fmtCur((projects || []).reduce((s, p) => s + getProjectFinancials(p.id).balance, 0))}</td>
                                            <td></td>
                                        </tr></tfoot>
                                    )}
                                </table>
                            </div>
                        </div>
                    )}

                    {/* Deed of Covenant */}
                    {reportType === 'deedOfCovenant' && (
                        <div className="space-y-4">
                            <div className="bg-slate-800/50 rounded-xl border border-slate-700 p-4">
                                <h3 className="text-lg font-semibold text-amber-400 mb-4">Deed of Covenant Report</h3>
                                
                                {/* Year and Info */}
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-3 mb-4">
                                    <div>
                                        <label className="text-xs text-slate-400 block mb-1">Year</label>
                                        <select value={covenantYear} onChange={e => setCovenantYear(parseInt(e.target.value))} className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm">
                                            {[...Array(5)].map((_, i) => {
                                                const year = new Date().getFullYear() - 2 + i;
                                                return <option key={year} value={year}>{year}</option>;
                                            })}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="text-xs text-slate-400 block mb-1">Pastor Name</label>
                                        <input type="text" value={covenantPastor} onChange={e => setCovenantPastor(e.target.value)} placeholder="Enter pastor name" className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm" />
                                    </div>
                                    <div>
                                        <label className="text-xs text-slate-400 block mb-1">Treasurer Name</label>
                                        <input type="text" value={covenantTreasurer} onChange={e => setCovenantTreasurer(e.target.value)} placeholder="Enter treasurer name" className="w-full px-3 py-2 bg-slate-900 border border-slate-600 rounded-lg text-white text-sm" />
                                    </div>
                                    <div className="flex items-end">
                                        <button onClick={exportDeedOfCovenant} disabled={selectedCovenantMembers.length === 0} className="w-full px-4 py-2 bg-amber-600 text-white rounded-lg text-sm font-medium hover:bg-amber-500 disabled:opacity-50 disabled:cursor-not-allowed">
                                            üì• Export Deed of Covenant
                                        </button>
                                    </div>
                                </div>

                                {/* Member Selection */}
                                <div className="border-t border-slate-700 pt-4">
                                    <div className="flex justify-between items-center mb-3">
                                        <h4 className="text-sm font-semibold text-slate-300">Select Members ({selectedCovenantMembers.length} selected)</h4>
                                        <div className="flex gap-2">
                                            <button onClick={() => setSelectedCovenantMembers([...uniqueMembers])} className="px-3 py-1 bg-slate-700 text-slate-300 rounded text-xs hover:bg-slate-600">Select All</button>
                                            <button onClick={() => setSelectedCovenantMembers([])} className="px-3 py-1 bg-slate-700 text-slate-300 rounded text-xs hover:bg-slate-600">Clear All</button>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2 max-h-64 overflow-y-auto p-2 bg-slate-900/50 rounded-lg">
                                        {uniqueMembers.map(member => (
                                            <label key={member} className={`flex items-center gap-2 p-2 rounded cursor-pointer hover:bg-slate-700/50 ${selectedCovenantMembers.includes(member) ? 'bg-amber-500/20 border border-amber-500/50' : 'bg-slate-800/50'}`}>
                                                <input type="checkbox" checked={selectedCovenantMembers.includes(member)} onChange={() => toggleCovenantMember(member)} className="rounded border-slate-600" />
                                                <span className="text-sm text-slate-300 truncate">{member}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Preview Table */}
                            {selectedCovenantMembers.length > 0 && (
                                <div className="bg-slate-800/50 rounded-xl border border-slate-700 overflow-hidden">
                                    <div className="p-3 border-b border-slate-700 bg-amber-500/10">
                                        <h3 className="text-sm font-semibold text-amber-400">Preview - {covenantYear} Total Contributions (Tithe + Offerings)</h3>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm">
                                            <thead><tr className="border-b border-slate-700 bg-slate-800/50">
                                                <th className="px-2 py-2 text-left text-slate-400 w-8">#</th>
                                                <th className="px-2 py-2 text-left text-slate-400">Name</th>
                                                {['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'].map(m => (
                                                    <th key={m} className="px-2 py-2 text-right text-slate-400 text-xs">{m}</th>
                                                ))}
                                                <th className="px-2 py-2 text-right text-amber-400">TOTAL</th>
                                            </tr></thead>
                                            <tbody>
                                                {selectedCovenantMembers.map((member, idx) => {
                                                    const memberEntries = titheEntries.filter(e => 
                                                        e.name === member && 
                                                        new Date(e.date).getFullYear() === covenantYear
                                                    );
                                                    const monthlyTotals = Array(12).fill(0);
                                                    memberEntries.forEach(entry => {
                                                        const month = new Date(entry.date).getMonth();
                                                        monthlyTotals[month] += parseFloat(entry.total_received) || 0;
                                                    });
                                                    const total = monthlyTotals.reduce((s, v) => s + v, 0);
                                                    
                                                    return (
                                                        <tr key={member} className="border-b border-slate-700/50 hover:bg-slate-700/30">
                                                            <td className="px-2 py-2 text-slate-500">{idx + 1}</td>
                                                            <td className="px-2 py-2 text-white font-medium">{member}</td>
                                                            {monthlyTotals.map((v, i) => (
                                                                <td key={i} className="px-2 py-2 text-right text-slate-300 text-xs">{v > 0 ? fmtCur(v) : '-'}</td>
                                                            ))}
                                                            <td className="px-2 py-2 text-right text-amber-400 font-bold">{fmtCur(total)}</td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                            <tfoot><tr className="font-bold bg-amber-500/10">
                                                <td colSpan="2" className="px-2 py-2 text-amber-400">TOTALS</td>
                                                {Array(12).fill(0).map((_, monthIdx) => {
                                                    const monthTotal = selectedCovenantMembers.reduce((sum, member) => {
                                                        const entries = titheEntries.filter(e => 
                                                            e.name === member && 
                                                            new Date(e.date).getFullYear() === covenantYear &&
                                                            new Date(e.date).getMonth() === monthIdx
                                                        );
                                                        return sum + entries.reduce((s, e) => s + (parseFloat(e.total_received) || 0), 0);
                                                    }, 0);
                                                    return <td key={monthIdx} className="px-2 py-2 text-right text-amber-400 text-xs">{monthTotal > 0 ? fmtCur(monthTotal) : '-'}</td>;
                                                })}
                                                <td className="px-2 py-2 text-right text-amber-400">
                                                    {fmtCur(selectedCovenantMembers.reduce((sum, member) => {
                                                        const entries = titheEntries.filter(e => e.name === member && new Date(e.date).getFullYear() === covenantYear);
                                                        return sum + entries.reduce((s, e) => s + (parseFloat(e.total_received) || 0), 0);
                                                    }, 0))}
                                                </td>
                                            </tr></tfoot>
                                        </table>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // Calculate totals helper
        function calculateTitheTotals(entries, expenses = []) {
            const totals = { totalReceived: 0, totalConfFund: 0, totalChurchFund: 0 };
            [...CONFERENCE_FIELDS, ...CHURCH_FIELDS].forEach(f => totals[f.key] = 0);
            entries.forEach(e => {
                totals.totalReceived += parseFloat(e.total_received) || 0;
                [...CONFERENCE_FIELDS, ...CHURCH_FIELDS].forEach(f => totals[f.key] += parseFloat(e[f.key]) || 0);
            });
            totals.totalConfFund = CONFERENCE_FIELDS.reduce((s, f) => s + totals[f.key], 0);
            totals.totalChurchFund = CHURCH_FIELDS.reduce((s, f) => s + totals[f.key], 0);
            
            // Calculate Wesport expenses (School - Wesport category)
            const wesportExpenses = expenses
                .filter(e => e.category === 'School - Wesport' || e.department === 'School - Wesport')
                .reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
            totals.wesportExpenses = wesportExpenses;
            
            // 40%/60% is calculated on Budget Covenant MINUS School contributions, Children's Home, AND Wesport expenses
            const baseFor40_60 = (totals.budget_covenant || 0) - (totals.school || 0) - (totals.pos_band || 0) - wesportExpenses;
            totals.baseFor40_60 = baseFor40_60;
            totals.percentage40 = baseFor40_60 * 0.4;
            totals.churchOperating = baseFor40_60 * 0.6;
            totals.grandTotalConference = totals.totalConfFund + totals.percentage40;
            return totals;
        }

        // Start App
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
